<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기 | HanHoRang Tech Blog</title>

    
    
    
    <meta property="og:site_name" content="HanHoRang Tech Blog by Tania in Hugo" />
    <meta property="og:title" content="[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기 | HanHoRang Tech Blog"/>
    <meta itemprop="name" content="[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기 | HanHoRang Tech Blog" />
    <meta name="twitter:title" content="[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기 | HanHoRang Tech Blog" />
    <meta name="application-name" content="[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기 | HanHoRang Tech Blog" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="예제 아키텍처 이해와 AWS X-ray를 통한 트레이싱 기능 이해하기" />
    <meta name="twitter:description" content="예제 아키텍처 이해와 AWS X-ray를 통한 트레이싱 기능 이해하기 "/>
    <meta itemprop="description" content=" 예제 아키텍처 이해와 AWS X-ray를 통한 트레이싱 기능 이해하기 "/>
    <meta property="og:description" content=" 예제 아키텍처 이해와 AWS X-ray를 통한 트레이싱 기능 이해하기 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Hugo Tania" />
<meta property="og:article:published_time" content=2023-05-26T00:00:00Z />
<meta property="article:published_time" content=2023-05-26T00:00:00Z />


  <meta property="og:article:author" content="Han ho rnag" />
  <meta property="article:author" content="Han ho rnag" />
  <meta name="author" content="Han ho rnag" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기",
    "author": {
      "@type": "Person",
      "name": "Hugo Tania"
    },
    "datePublished": "2023-05-26",
    "description": "예제 아키텍처 이해와 AWS X-ray를 통한 트레이싱 기능 이해하기",
    "wordCount":  1794 ,
    "mainEntityOfPage": "True",
    "dateModified": "2023-05-26",
    "publisher": {
      "@type": "Organization",
      "name": "Hugo Tania",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/HanHoRang31.github.io\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                    HanHoRang Tech Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>[AEWS] EKS Observability 워크샵 학습과 트레이싱 기능 확인하기</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By HanHoRnag | <time>May 26, 2023</time>
                            | 9 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/aews/">AEWS</a>
                            
                            <a href="/tags/kubeflow/">kubeflow</a>
                            
                            <a href="/tags/cloud/">cloud</a>
                            
                            <a href="/tags/aws/">AWS</a>
                            
                            <a href="/tags/eksctl/">eksctl</a>
                            
                            <a href="/tags/eks/">eks</a>
                            
                            <a href="/tags/x-ray/">x-ray</a>
                            
                            <a href="/tags/observability/">Observability</a>
                            
                            <a href="/tags/trace/">trace</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">AWS EKS Workshop Study (=AEWS)는 EKS Workshop 실습 스터디입니다.
</span></span><span class="line"><span class="cl">CloudNet@ Gasida(가시다)님이 진행하시며,공개된 AWS EKS Workshop을 기반으로 진행하고 있습니다.
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="eks-workshop-아키텍처-이해와-트레이싱-기능-확인하기">
    <a href="#eks-workshop-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98-%ec%9d%b4%ed%95%b4%ec%99%80-%ed%8a%b8%eb%a0%88%ec%9d%b4%ec%8b%b1-%ea%b8%b0%eb%8a%a5-%ed%99%95%ec%9d%b8%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS workshop 아키텍처 이해와 트레이싱 기능 확인하기
</h1>
<p>스터디에서 관측시스템 관련 좋은 워크샵 링크를 공유해주셨다. 이번 시간에는 해당 워크샵 자료를 토대로 실습 아키텍처 이해와 워크샵 기능 중 트레이싱을 살펴볼 예정이다.</p>
<blockquote>
<p>EKS One Observability Workshop 워크샵 링크 :  <a href="https://catalog.workshops.aws/observability/en-US">https://catalog.workshops.aws/observability/en-US</a></p>
</blockquote>
<h1 id="관측시스템-아키텍처">
    <a href="#%ea%b4%80%ec%b8%a1%ec%8b%9c%ec%8a%a4%ed%85%9c-%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    관측시스템 아키텍처
</h1>
<p>워크샵에서 제공하는 아키텍처가 AWS 기반의 실 애플리케이션을 운영하는 예제로 좋은 것 같아 정리한다. 애플리케이션은 애완동물 입양 안내 사이트로 애완동물에 대한 검색 기능과 및 입양 여부에 따라 조회가 달라지는 기능을 제공한다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/pet.png" 
    alt="pet.png" 
     
    width=1599 
    height="1277"  /></p>
<h2 id="아키텍처-구성-이해">
    <a href="#%ec%95%84%ed%82%a4%ed%85%8d%ec%b2%98-%ea%b5%ac%ec%84%b1-%ec%9d%b4%ed%95%b4" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    아키텍처 구성 이해
</h2>
<p>각 모듈은 AWS 서비스로 구성되어 있으며 아키텍처는 다음 아키텍처와 같다. 아키텍처가 많이 복잡하다.. 이해를 위해 아키텍처에서 AWS 서비스 구성 이유와 어떻게 서비스들이 연동하고 있는 지 정리하여 공유한다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/archi.png" 
    alt="archi.png" 
     
    width=726 
    height="817"  /></p>
<ul>
<li>
<p>각 API 서비스 앞 ALB(Application Load Balancer)를 배치한 이유?</p>
<ul>
<li>
<p>로드 밸런싱 : 서버 부하를 줄이고, 높은 가용성과 신뢰성을 제공하여 규모에 따라 자동으로 스케일링되도록 구성</p>
</li>
<li>
<p>컨테이너화 된 워크로드 지원 : ALB는 ECS 및 EKS와 같은 컨테이너화된 워크로드를 지원한다.</p>
</li>
<li>
<p>내구성 및 보안 : ALB은 각 가용 영역에서 실행되어 높은 내구성을 제공하며,  AWS WAF, Shield, ACM 같은 보안 서비스와 통합하여 보안을 강화할 수 있다.</p>
</li>
<li>
<p>ALB 연동은 AWS 콘솔에서 손 쉽게 가능하다. [EC2] → [대상 그룹] 생성 후, 로드밸런서에서 ALB 생성을 진행하면 연동이 완료된다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/targetgroup.png" 
    alt="targetgroup.png" 
     
    width=837 
    height="820"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/lisetner.png" 
    alt="lisetner.png" 
     
    width=1111 
    height="865"  /></p>
</li>
</ul>
</li>
<li>
<p>PetSite-FrontEnd 에 SQS, SNS, StepFunctions를 연결한 이유 ?</p>
<ul>
<li>
<p>SNS 연결 이유 ? SNS (Simple Notification Service)는 웹서비스를 통해 모든 인프라 및 앱에 분산 메시징을 제공하는 완전관리형 퍼블리시/서브스크라이브 메시징 서비스이다. 예제에서는 프론트앤드 트래픽 및 상태 값에 알람을 걸고 등록된 이메일에 알람을 보내도록 구성되어 있다.</p>
</li>
<li>
<p>StepFunction 연결 이유 ? StepFunction 은 람다 함수 서비스를 통합하여 워크로드를 구성할 수 있는 서비스이다. 본 예제에서는 호출 테스트를 목적으로 일정 시간마다 dynamodb 에 저장된 애완동물 값을 읽어 애플리케이션 상태를 확인하도록 구성되어 있다. AWS 콘솔에서는 다음과 같이 구성 및 호출 결과를 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/step.png" 
    alt="step.png" 
     
    width=1515 
    height="771"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/step2.png" 
    alt="step2.png" 
     
    width=1513 
    height="857"  /></p>
<p>각 람다 함수는 python 으로 구성되어 있으며 코드 이해를 돕기 위해 공유한다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ReadDynamoDB</span>
</span></span><span class="line"><span class="cl"><span class="c1"># DynamoDB 에 저장된 애완동물의 가격을 불러온다.</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">boto3</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ssm</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ssm&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dynamodb_tablename</span> <span class="o">=</span> <span class="n">ssm</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s1">&#39;/petstore/dynamodbtablename&#39;</span><span class="p">,</span> <span class="n">WithDecryption</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">dynamodb_tablename</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">][</span><span class="s1">&#39;Value&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">KeyConditionExpression</span><span class="o">=</span><span class="n">Key</span><span class="p">(</span><span class="s1">&#39;petid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;petid&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">Key</span><span class="p">(</span><span class="s1">&#39;pettype&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;pettype&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;price&#39;</span><span class="p">])</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Items&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># PriceGreaterthan55</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 55 이상의 애완동물을 확인하고 200을 결과 값으로 반환한다.</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># TODO implement</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ProcessLessthan55 - Execution complete&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s1">&#39;ProcessLessthan55 - Execution complete&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Pricelessthan55</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 55 미만의 애완동물을 확인하고 200을 결과 값으로 반환한다.</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># TODO implement</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ProcessGreaterThan55 - Execution complete&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;statusCode&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="s1">&#39;ProcessGreaterThan55 - Execution complete&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>SQS 사용 이유? 서버서리스 메시지 큐 서비스로 본 예제에서는 비동기 작업 처리(입양)에 대한 부하 분산 및 메세지 처리 순서를 보장하기 위해 구성되었다. 메세지 큐 사용은 payment에서 사용되며 코드에서는 아래와 같이 입양시 SQS에 메세지를 날려 처리하도록 구성되어 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/sqs2.png" 
    alt="sqs2.png" 
     
    width=486 
    height="128"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/sqs4.png" 
    alt="sqs4.png" 
     
    width=987 
    height="497"  /></p>
<p>SQS를 사용하면, AWS 콘솔에서 메세지 큐에 대한 메트릭 정보를 확인할 수 있다. 각 메세지에 저장된 값도 확인할 수 있으면 좋겠지만,, 생산/처리 시스템으로 설계되어 있어 메세지 확인은 불가하다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/sqs1.png" 
    alt="sqs1.png" 
     
    width=1708 
    height="845"  /></p>
</li>
</ul>
</li>
<li>
<p>애플리케이션 API를 EKS 와 Fargate 로 구성한 이유?</p>
<p>Fargate와 EKS를 함께 사용하면 Kubernetes의 유연성과 Fargate의 서버리스 이점을 모두 활용할 수 있다고 한다. 함께 사용시 다음과 같은 이점이 있다.(참고 ChatGPT)</p>
<ul>
<li><strong>서버리스 컨테이너 운영</strong>: Fargate로 구성시 인프라 자원(서버/클러스터)에 대한 관리는 AWS에서 관리하며, 트래픽에 따라 자동으로 스케일링이 된다. 이에 따라 개발자는 컨테이너 인프라 관리에 신경 쓸 비용이 줄어 개발에 집중할 수 있게 된다.</li>
<li><strong>비용 효율</strong>: Fargate는 실제 사용량에 따라 요금이 청구되므로, 사용하지 않는 컴퓨트 리소스에 대해 지불할 필요가 없다.</li>
</ul>
<p>본 예제에서는 API 구성이 Frontend 부분만 EKS 관리형 노드의 Pod로 나머지 API는 Fargate로 구성되어 있다. 필자가 생각하건데 Frontend 부분만 EKS Pod로 사용한 이유는 전체 서비스의 첫 대문을 계속 운영하여 서비스에 대한 초기 로딩 지연시간을 업애기 위해 사용된 것 같고, 나머지 부분을 Fargate로 대체하여 추가 API 기능에 대해 초기 로딩 지연시간은 있지만, 비용을 절감할 수 있도록 구성한 것 같다.</p>
</li>
<li>
<p>AWS Lambda 와 EKS 를 같이 사용하는 이유?</p>
<p>결국 서버리스 컴퓨팅과 쿠버네티스(컨테이너화)의 차이점으로 작업이 이벤트이냐 아니냐에 따라 구성을 달리 한 것 같다. 본 예제에서의 람다 함수들은 트래픽 테스트를 위해 일정 시간 정보를 확인하는 함수와 입양 상태를 업데이트하는 함수로 구성되어 있어 있다. 이벤트 기반의 함수들에 대해 람다 함수들로 구성되어 있음을 확인할 수 있다.</p>
<p>아키텍처를 보면 람다와 동일한 서버리스 컴퓨팅인 Fargate를 사용한 것을 확인할 수 있다. 같은 서버리스 컴퓨팅 서비스이지만, 작업이 짧고 가벼운(호출/업데이트) 이벤트에 대해서는 람다로 구성하고 반대로 길고 컴퓨팅 자원이 무거운(조회) 이벤트에 대해서는 Fargate로 구성됨을 알 수 있다.</p>
</li>
<li>
<p>PetSearch-API에 S3 하고 dynamodb를 사용한 이유?</p>
<p>이미지를 저장하고 검색하는 경우, S3 스토리지를 사용하는 것이 일반적이다. 그러나 사용자 정보, 상품 카탈로그, 게임 상태 등과 같은 구조화된 데이터를 빠르게 검색하고 조작할 필요가 있을 때는 DynamoDB가 더 적합하다. 본 예제에서는 이 둘을 결합하여 애완동물 이미지 파일을 S3에 저장하고, 해당 이미지의 메타데이터(예: 펫 이름, 입양 상태)를 DynamoDB에 저장하도록 구성되어 있다. 이렇게 하면 빠르고 효율적인 검색을 통해 필요한 이미지를 신속하게 찾을 수 있다.</p>
<p>S3 콘솔에서는 다음과 같이 이미지 파일들을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/s3.png" 
    alt="s3.png" 
     
    width=1525 
    height="580"  /></p>
<p>다음 코드는 람다 서비스의 PetAdoptionStauteUpdate 코드이다. 코드를 보면 입양이 완료되면 dynamodb에 저장된 애완동물 메타데이터(availability) 를 업데이트하여 애완 동물의 입양 상태를 업데이트하도록 구성되어 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="s2">&#34;use strict&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// asset-input/index.js
</span></span><span class="line"><span class="cl">var <span class="nv">AWSXRay</span> <span class="o">=</span> require<span class="o">(</span><span class="s2">&#34;aws-xray-sdk&#34;</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">var <span class="nv">AWS</span> <span class="o">=</span> AWSXRay.captureAWS<span class="o">(</span>require<span class="o">(</span><span class="s2">&#34;aws-sdk&#34;</span><span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">var <span class="nv">documentClient</span> <span class="o">=</span> new AWS.DynamoDB.DocumentClient<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">exports.handler <span class="o">=</span> async <span class="k">function</span><span class="o">(</span>event, context, callback<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  var <span class="nv">payload</span> <span class="o">=</span> JSON.parse<span class="o">(</span>event.body<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  var <span class="nv">availability</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span>payload.petavailability <span class="o">===</span> void 0<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">availability</span> <span class="o">=</span> <span class="s2">&#34;no&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  var <span class="nv">params</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    TableName: process.env.TABLE_NAME,
</span></span><span class="line"><span class="cl">    Key: <span class="o">{</span><span class="m">12</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;pettype&#34;</span>: payload.pettype,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;petid&#34;</span>: payload.petid
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    UpdateExpression: <span class="s2">&#34;set availability = :r&#34;</span>,
</span></span><span class="line"><span class="cl">    ExpressionAttributeValues: <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;:r&#34;</span>: availability
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    ReturnValues: <span class="s2">&#34;UPDATED_NEW&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  await updatePetadoptionsTable<span class="o">(</span>params<span class="o">)</span><span class="p">;</span> <span class="c1"># 업데이트 부분 </span>
</span></span><span class="line"><span class="cl">  console.log<span class="o">(</span><span class="s2">&#34;Updated petid: &#34;</span> + payload.petid + <span class="s2">&#34;, pettype: &#34;</span> + payload.pettype + <span class="s2">&#34;, to availability: &#34;</span> + availability<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">{</span> <span class="s2">&#34;statusCode&#34;</span>: 200, <span class="s2">&#34;body&#34;</span>: <span class="s2">&#34;success&#34;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">async <span class="k">function</span> updatePetadoptionsTable<span class="o">(</span>params<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  await documentClient.update<span class="o">(</span>params, <span class="k">function</span><span class="o">(</span>err, data<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span>err<span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      console.log<span class="o">(</span>JSON.stringify<span class="o">(</span>err, null, 2<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      console.log<span class="o">(</span>JSON.stringify<span class="o">(</span>data, null, 2<span class="o">))</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">})</span>.promise<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>PayForAdoptions-API 에 API gateway를 사용한 이유 ?</p>
<p>WS Lambda 앞에 API Gateway를 연결하는 것은 웹 또는 모바일 애플리케이션에서 서버리스 백엔드를 구성하는 일반적인 패턴이다. 람다에서는 자체적으로 HTTP(S) 엔드포인트를 제공하기 때문이다. 이렇게 하면 AWS Lambda를 사용하여 복잡한 백엔드 로직을 처리하고, API Gateway를 사용하여 HTTP 요청을 라우팅하고 보안을 관리할 수 있다.</p>
</li>
</ul>
<h2 id="예제-배포">
    <a href="#%ec%98%88%ec%a0%9c-%eb%b0%b0%ed%8f%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    예제 배포
</h2>
<p>예제 배포는 AWS CDK로 배포한다. CDK 는 AWS 서비스에 대한 IaS 로 코드를 통해 AWS 서비스를 배포 할 수 있다. 배포를 위한 명령어로는 다음과 같다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># CDK 필요 패키지 설치로 npm 설치 진행</span>
</span></span><span class="line"><span class="cl">curl -sL https://rpm.nodesource.com/setup_14.x <span class="p">|</span> sudo bash -
</span></span><span class="line"><span class="cl">sudo yum install nodejs 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 예제 깃 레파지토리 clone</span>
</span></span><span class="line"><span class="cl">git clone https://github.com/aws-samples/one-observability-demo 
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> workshopfiles/one-observability-demo/PetAdoptions/cdk/pet_stack 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cdk 환경 설정 </span>
</span></span><span class="line"><span class="cl">cdk bootstrap
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cdk 배포 </span>
</span></span><span class="line"><span class="cl"><span class="nv">CONSOLE_ROLE_ARN</span><span class="o">=</span>&lt;Enter your Role ARN&gt;  <span class="c1"># 역할 role arn을 업데이트 하자</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">EKS_ADMIN_ARN</span><span class="o">=</span><span class="k">$(</span>../../getrole.sh<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -e <span class="s2">&#34;\nRole \&#34;</span><span class="si">${</span><span class="nv">EKS_ADMIN_ARN</span><span class="si">}</span><span class="s2">\&#34; will be part of system\:masters group\n&#34;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="nv">$CONSOLE_ROLE_ARN</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nb">echo</span> -e <span class="s2">&#34;\nEKS Console access will be restricted\n&#34;</span><span class="p">;</span> <span class="k">else</span> <span class="nb">echo</span> -e <span class="s2">&#34;\nRole \&#34;</span><span class="si">${</span><span class="nv">CONSOLE_ROLE_ARN</span><span class="si">}</span><span class="s2">\&#34; will have access to EKS Console\n&#34;</span><span class="p">;</span> <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cdk deploy --context <span class="nv">admin_role</span><span class="o">=</span><span class="nv">$EKS_ADMIN_ARN</span> Services --context <span class="nv">dashboard_role_arn</span><span class="o">=</span><span class="nv">$CONSOLE_ROLE_ARN</span> --require-approval never
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cdk deploy Applications --require-approval never 
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="trace-트레이싱">
    <a href="#trace-%ed%8a%b8%eb%a0%88%ec%9d%b4%ec%8b%b1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Trace (트레이싱)
</h1>
<p>트레이싱은 분산 시스템에서 요청의 생애 주기를 추적하는 기술로, 이를 통해 서비스 간 상호 작용의 가시성을 제공하고 문제를 진단하는 데 도움을 주는 기능이다. 트레이싱은 로그, 메트릭, 분산 트레이싱의 세 가지 관측 가능한 신호 중 하나로 관측 시스템에 큰 축을 담당하고 있다.</p>
<p>트레이싱은 분산 시스템 및 마이크로서비스에서 기능이 크게 부각되는데 해당 시스템에서는 한 요청이 여러 서비스를 거쳐 처리되므로 문제가 발생했을 때 문제가 발생했는 지 파악하기가 어렵다. 이를 해결하기 위해 트레이싱은 서비스간의 요청마다 고유한 ID를 부여하여 이벤트를 발생시킬 때마다 이벤트의 시간 시간과 끝시간을 레이턴시를 파악한다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/trace1.png" 
    alt="&lt;a href=&#34;https://www.dynatrace.com/news/blog/open-observability-distributed-tracing-and-observability/&#34;&gt;https://www.dynatrace.com/news/blog/open-observability-distributed-tracing-and-observability/&lt;/a&gt;" 
     
    width=1360 
    height="680"  /></p>
<p><a href="https://www.dynatrace.com/news/blog/open-observability-distributed-tracing-and-observability/">https://www.dynatrace.com/news/blog/open-observability-distributed-tracing-and-observability/</a></p>
<h2 id="x-ray">
    <a href="#x-ray" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    X-Ray
</h2>
<p>AWS 에서는  X-ray라는 서비스를 통해 트레이싱 기능을 제공한다. 워크샵에서는 X-ray를 사용하기 위한 코드 삽입 및 X-ray 파드가 배포되어 있는 상태이다. 본 블로그 글에서는 X-ray 설치는 스킵하고 트레이싱에 대한 기능 위주의 글을 작성할 예정이다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/sqs4-2.png" 
    alt="sqs4-2.png" 
     
    width=987 
    height="497"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray21.png" 
    alt="x-ray21.png" 
     
    width=1966 
    height="618"  /></p>
<p>여기서 배포된 Xray-daemon 파드가 정보를 받아 AWS X-ray에 제공한다고 보면 이해가 쉽다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray1.png" 
    alt="x-ray1.png" 
     
    width=498 
    height="452"  /></p>
<p>제공한 트레이싱 데이터들은 AWS 콘솔의 X-ray에서 확인할 수 있다. 예제 마이크로서비스에 대한 응답 시간과 메트릭(대기 시간, 요청, 장애) 를 한눈에 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray2.png" 
    alt="x-ray2.png" 
     
    width=675 
    height="585"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray3.png" 
    alt="x-ray3.png" 
     
    width=1606 
    height="385"  /></p>
<h2 id="x-ray-기능-확인하기">
    <a href="#x-ray-%ea%b8%b0%eb%8a%a5-%ed%99%95%ec%9d%b8%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    X-ray 기능 확인하기
</h2>
<p>워크샵 내용을 토대로 X-ray 기능를 통해 확인하여 트레이싱 기능을 이해해보자. 가장 먼저, AWS 콘솔에 접근하면 다음과 같이 응답 시간을 한 눈에 확인할 수 있다. 먼저, 밑의 그림 처럼 장애난 부분의 화살표를 클릭하여 각 서비스 간의 응답 시간 및 에러 원인을 찾을 수 있다.</p>
<h3 id="에러-트레이싱하기">
    <a href="#%ec%97%90%eb%9f%ac-%ed%8a%b8%eb%a0%88%ec%9d%b4%ec%8b%b1%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    에러 트레이싱하기
</h3>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray4.png" 
    alt="x-ray4.png" 
     
    width=1598 
    height="700"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray6.png" 
    alt="x-ray6.png" 
     
    width=1791 
    height="839"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray5.png" 
    alt="x-ray5.png" 
     
    width=1488 
    height="710"  /></p>
<h3 id="트레이싱-비교를-통해-원인-분석하기">
    <a href="#%ed%8a%b8%eb%a0%88%ec%9d%b4%ec%8b%b1-%eb%b9%84%ea%b5%90%eb%a5%bc-%ed%86%b5%ed%95%b4-%ec%9b%90%ec%9d%b8-%eb%b6%84%ec%84%9d%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    트레이싱 비교를 통해 원인 분석하기
</h3>
<p>다음은 X-ray Anlytics 의 기능으로 트레이스 데이터간 비교하여 문제 해결에 도움을 주는 기능을 확인하자. [AWS 콘솔] → [X-ray Anlytics] 에 접근하면 다음과 같이 트레이스 데이터를 확인할 수 있다. 다음 그림과 같이 응답 시간 분포에서 3초 이상의 데이터를 확인하여 분석을 위해 드래그를 통해 상세 정보를 확인하면 특정 API (조회)시 발생하는 것을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray7.png" 
    alt="x-ray7.png" 
     
    width=1849 
    height="865"  /></p>
<p>특정 API 에 대한 응답 시간이 늦춰짐과 동시에 대한 원인 분석으로 해당 API가 실패했을 때 응답 시간이 3초이상 되는 지 확인할 수 있다. 아래 그림에서 필터링된 트레이스 세트 B를 클릭하고 HTTPS Stateus code를 클릭하면 트레이스 데이터간 비교가 가능하다. 아래 결과를 분석하면 실패했을 때는와 응답 시간에 대한 연관 관계는 없는 것을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray8.png" 
    alt="x-ray8.png" 
     
    width=1668 
    height="755"  /></p>
<h3 id="알람-구성">
    <a href="#%ec%95%8c%eb%9e%8c-%ea%b5%ac%ec%84%b1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    알람 구성
</h3>
<p>트레이싱 데이터에 대해 알람 구성이 가능하다. X-ray 의 그룹에 접근하여 필터 표현식을 통해 메트릭 생성이 가능하기 때문이다. 아래 예제는 응답 시간이 3초 이상에 대한 메트릭을 생성하여 Cloudwatch에서 해당 메트릭을 확인하는 예제이다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray10.png" 
    alt="x-ray10.png" 
     
    width=1528 
    height="719"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray11.png" 
    alt="x-ray11.png" 
     
    width=1548 
    height="596"  /></p>
<h2 id="사용-케이스를-통한-트레이싱-이해하기">
    <a href="#%ec%82%ac%ec%9a%a9-%ec%bc%80%ec%9d%b4%ec%8a%a4%eb%a5%bc-%ed%86%b5%ed%95%9c-%ed%8a%b8%eb%a0%88%ec%9d%b4%ec%8b%b1-%ec%9d%b4%ed%95%b4%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    사용 케이스를 통한 트레이싱 이해하기
</h2>
<p>워크샵에서는 시스템 에러에 대한 트러블슈팅 과정으로 여러 사용 케이스를 제공한다. 실제 AWS 기반의 애플리케이션 운영시 트러블슈팅 과정에 도움이 되는 시나리오라 생각되어 구성 내용을 간략하게 정리하여 공유한다.</p>
<h3 id="트래픽-발생에-따른-트러블-슈팅">
    <a href="#%ed%8a%b8%eb%9e%98%ed%94%bd-%eb%b0%9c%ec%83%9d%ec%97%90-%eb%94%b0%eb%a5%b8-%ed%8a%b8%eb%9f%ac%eb%b8%94-%ec%8a%88%ed%8c%85" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    트래픽 발생에 따른 트러블 슈팅
</h3>
<p>예제 애플리케이션 사이트에 과부하를 줘서 생기는 트러블슈팅 과정을 먼저 살펴보겠다. 다음의 명령어를 통해 과부화를 주자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">PETLISTADOPTIONS_CLUSTER</span><span class="o">=</span><span class="k">$(</span>aws ecs list-clusters <span class="p">|</span> jq <span class="s1">&#39;.clusterArns[]|select(contains(&#34;PetList&#34;))&#39;</span> -r<span class="k">)</span>
</span></span><span class="line"><span class="cl"><span class="nv">TRAFFICGENERATOR_SERVICE</span><span class="o">=</span><span class="k">$(</span>aws ecs list-services --cluster <span class="nv">$PETLISTADOPTIONS_CLUSTER</span> <span class="p">|</span> jq <span class="s1">&#39;.serviceArns[]|select(contains(&#34;trafficgenerator&#34;))&#39;</span> -r<span class="k">)</span>
</span></span><span class="line"><span class="cl">aws ecs update-service --cluster <span class="nv">$PETLISTADOPTIONS_CLUSTER</span> --service <span class="nv">$TRAFFICGENERATOR_SERVICE</span> --desired-count <span class="m">5</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>과부화를 주면 아래 그림의 DynamoDB에 알람 표시가 나온 것을 확인할 수가 있다. 알람을 확인하면 해당 DB의 읽기 용량이 초과되었음을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray13.png" 
    alt="x-ray13.png" 
     
    width=1431 
    height="987"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray-error.png" 
    alt="x-ray-error.png" 
     
    width=1548 
    height="562"  /></p>
<p>해결 방법은 간단하다.  DynamoDB 테이블이 프로비저닝된 용량 모드로 요청이 제한되었기 때문에 온디맨드 용량 모드 옵션을 변경하면 처리가 된다. 옵션 명령어는 다음과 같다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">DDB_TABLE</span><span class="o">=</span><span class="k">$(</span>aws dynamodb list-tables <span class="p">|</span> jq -r <span class="s1">&#39;.TableNames[] | select (. | contains(&#34;ddbpetadoption&#34;))&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">aws dynamodb update-table --table-name <span class="si">${</span><span class="nv">DDB_TABLE</span><span class="si">}</span> --billing-mode PAY_PER_REQUEST <span class="p">|</span> jq -r <span class="s1">&#39;.TableDescription.TableStatus&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="메모리-문제-발생시-트러블슈팅">
    <a href="#%eb%a9%94%eb%aa%a8%eb%a6%ac-%eb%ac%b8%ec%a0%9c-%eb%b0%9c%ec%83%9d%ec%8b%9c-%ed%8a%b8%eb%9f%ac%eb%b8%94%ec%8a%88%ed%8c%85" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    메모리 문제 발생시 트러블슈팅
</h3>
<p>다음은 메모리를 비롯한 인프라에 대한 문제 발생시 트러블슈팅 하는 과정이다. 인프라 자원의 문제가 생기면 애플리케이션에 대한 에러가 발생할 것이다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/fault1.png" 
    alt="fault1.png" 
     
    width=1021 
    height="337"  /></p>
<p>원인 분석으로 X-ray에서는 필터링 기능을 통해 에러 통신 값에 따른 트레이싱 정보를 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray15.png" 
    alt="x-ray15.png" 
     
    width=1508 
    height="598"  /></p>
<p>트레이싱 데이터를 클릭하면 각 요청에 대한 상세 정보를 확인할 수 있다. 데이터 내에서는 각 요청에 대한 로그도 확인할 수 있는 데 밑의 로그 기록처럼 메모리 관리 부분에 문제가 생긴 것을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ray18.png" 
    alt="x-ray18.png" 
     
    width=1573 
    height="547"  /></p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/x-ary20.png" 
    alt="x-ary20.png" 
     
    width=1567 
    height="456"  /></p>
<p>이를 증명하기 위해 클라우드워치에서 메모리 및 CPU 메트릭을 확인하면 다음과 같이 인프라 자원에 피크가 생긴 것을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./eks-observability-tracing/fault2.png" 
    alt="fault2.png" 
     
    width=1019 
    height="346"  /></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/karpenter-deepdive/" title="Previous post (older)">
            <span>Previous</span>
            [AEWS] karpenter DeeP Dive (Feat. 오버프로비저닝, kubeflow)
            </a>
        
        
        
    </nav>
    
</div>
 
<div class="container">
    
    <script src="https://giscus.app/client.js" 
        data-repo="WingLim/hugo-tania"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTYyNjQzMDc="
        
        data-category="Comments"
        data-category-id="DIC_kwDOEtnPc84B_WKP"
        
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async
        >
</script>

<script>
    function setGiscusTeheme(theme) {
        let giscus = document.querySelector('.giscus iframe');
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme
                        }
                    }
                },
                'https://giscus.app'
            )
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://giscus.app') return;
        setGiscusTeheme(document.documentElement.dataset.userColorScheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setGiscusTeheme(e.detail)
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>