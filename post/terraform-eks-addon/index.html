<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>[T1013] 테라폼 모듈로 EKS addon 관리하기 | HanHoRang Tech Blog</title>

    
    
    
    <meta property="og:site_name" content="HanHoRang Tech Blog by Tania in Hugo" />
    <meta property="og:title" content="[T1013] 테라폼 모듈로 EKS addon 관리하기 | HanHoRang Tech Blog"/>
    <meta itemprop="name" content="[T1013] 테라폼 모듈로 EKS addon 관리하기 | HanHoRang Tech Blog" />
    <meta name="twitter:title" content="[T1013] 테라폼 모듈로 EKS addon 관리하기 | HanHoRang Tech Blog" />
    <meta name="application-name" content="[T1013] 테라폼 모듈로 EKS addon 관리하기 | HanHoRang Tech Blog" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="테라폼 모듈로 EKS addon 구성하기" />
    <meta name="twitter:description" content="테라폼 모듈로 EKS addon 구성하기 "/>
    <meta itemprop="description" content=" 테라폼 모듈로 EKS addon 구성하기 "/>
    <meta property="og:description" content=" 테라폼 모듈로 EKS addon 구성하기 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Hugo Tania" />
<meta property="og:article:published_time" content=2023-09-15T00:00:00Z />
<meta property="article:published_time" content=2023-09-15T00:00:00Z />


  <meta property="og:article:author" content="Han ho rnag" />
  <meta property="article:author" content="Han ho rnag" />
  <meta name="author" content="Han ho rnag" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "[T1013] 테라폼 모듈로 EKS addon 관리하기",
    "author": {
      "@type": "Person",
      "name": "Hugo Tania"
    },
    "datePublished": "2023-09-15",
    "description": "테라폼 모듈로 EKS addon 구성하기",
    "wordCount":  2398 ,
    "mainEntityOfPage": "True",
    "dateModified": "2023-09-15",
    "publisher": {
      "@type": "Organization",
      "name": "Hugo Tania",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/HanHoRang31.github.io\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                    HanHoRang Tech Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>[T1013] 테라폼 모듈로 EKS addon 관리하기</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By HanHoRnag | <time>September 15, 2023</time>
                            | 12 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/t101/">T101</a>
                            
                            <a href="/tags/eks/">eks</a>
                            
                            <a href="/tags/cloud/">cloud</a>
                            
                            <a href="/tags/aws/">AWS</a>
                            
                            <a href="/tags/terraform/">Terraform</a>
                            
                            <a href="/tags/terraform-cloud/">Terraform Cloud</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">T101 3기(=Terraform 101 Study)는 Terraform 실무 실습 스터디입니다.
</span></span><span class="line"><span class="cl">CloudNet@ 유형욱, 윤서율님이 진행하시며, 책 &#34;테라폼으로 시작하는 IaC&#34;을 기반으로 진행하고 있습니다.
</span></span></code></pre></td></tr></table>
</div>
</div><p>지난 포스트 글에서는 테라폼 클라우드를 통해 EKS를 프로비저닝하였습니다. 프로비저닝은 EKS 모듈을 통해 진행하였는데요. 이번 글에서는 EKS 모듈에 대해 자세히 다뤄볼 예정입니다. 테라폼 레파지토리를 확인하면 EKS 모듈 사용 예제를 비롯하여 ALB 컨트롤러, External DNS와 같은 addon를 확인할 수 있습니다. 이번 글에서는 모듈 예제를 학습하고 EKS와 기본 addon을 프로비저닝하겠습니다. 구성 예제는 필자의 <a href="https://github.com/HanHoRang31/blog-share/tree/main/terraform/terraform-eks-addon">깃허브</a>에서 확인이 가능합니다.</p>
<h2 id="1-테라폼-eks-모듈">
    <a href="#1-%ed%85%8c%eb%9d%bc%ed%8f%bc-eks-%eb%aa%a8%eb%93%88" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1. 테라폼 EKS 모듈
</h2>
<p>EKS 모듈 예제를 확인하면 EKS에서 프로비저닝할 수 있는 모든 워크 노드 타입이 제공되는 것을 확인할 수 있습니다. 각 워크 노드 타입의 특징은 다음과 같이 요약할 수 있습니다.</p>
<ul>
<li>eks_managed_nodegroup (EKS Managed Node Groups) : EKS 관리형 노드 그룹입니다. AWS가 노드 그룹의 라이프사이클을 자동으로 관리해주는 타입입니다. 작동 상태를 모니터링하고 필요에 따라 패치 적용 및 업데이트를 자동으로 수행합니다.</li>
<li>Fargate :  노드 타입을 서버리스로 설정해주는 옵션입니다. 노드(ec2)가 아니라 별도로 관리할 필요가 없으며 컨테이너가 fargate로 할당됩니다. 쿠버네티스의 복잡한 관리 작업 없이 서비스를 실행할 수 있습니다.</li>
<li>Karpenter : karpenter는 오픈소스 자동 스케일러로 karpenter 수행되는 서버 타입(EC2 Fleet)로 할당하여 노드 그룹을 구성합니다. karpenter 를 적용하면 빠르게 서버를 스케일러할 수 있게 됩니다.</li>
<li>self_managed_nodegroup (Self-Managed Node Groups) : 비관리형 노드 그룹입니다. 사용자가 노드의 모든 측면을 관리해야 합니다. Custom AMI를 통해 노드를 구성할 수 있으며 보안 목적이나 노드의 추가 설정 필요시 사용합니다.</li>
<li>Outposts : 로컬 EKS 노드 그룹 옵션입니다. 온프레미스 또는 다른 원격 위치에서 노드 그룹을 프로비저닝하여 EKS 클러스터를 운영할 수 있습니다.</li>
</ul>
<p><img loading="lazy" 
    src="/terraform-eks-addon/addon.png" 
    alt="addon.png" 
     
    width=922 
    height="559"  /></p>
<p>위 예제 옵션 중 다루지 않은 complete는 모든 노드 그룹의 유형을 사용하는 예제이며, user_data는 노드의 부트스트랩 스크립트 및 구성하는 예제입니다. 예제 중 가장 기본이 되는 self-managed-node-group 예제를 통해 모듈 사용 예를 확인해보겠습니다. 모듈 구성은 다음과 같습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── modules
</span></span><span class="line"><span class="cl">│   ├── _user_data
</span></span><span class="line"><span class="cl">│   │   ├── README.md
</span></span><span class="line"><span class="cl">│   │   ├── main.tf
</span></span><span class="line"><span class="cl">│   │   ├── outputs.tf
</span></span><span class="line"><span class="cl">│   │   ├── variables.tf
</span></span><span class="line"><span class="cl">│   │   └── versions.tf
</span></span><span class="line"><span class="cl">│   ├── eks
</span></span><span class="line"><span class="cl">│   │   ├── README.md
</span></span><span class="line"><span class="cl">│   │   ├── main.tf
</span></span><span class="line"><span class="cl">│   │   ├── node_groups.tf
</span></span><span class="line"><span class="cl">│   │   ├── outputs.tf
</span></span><span class="line"><span class="cl">│   │   ├── templates
</span></span><span class="line"><span class="cl">│   │   │   ├── aws_auth_cm.tpl
</span></span><span class="line"><span class="cl">│   │   │   ├── bottlerocket_user_data.tpl
</span></span><span class="line"><span class="cl">│   │   │   ├── linux_user_data.tpl
</span></span><span class="line"><span class="cl">│   │   │   └── windows_user_data.tpl
</span></span><span class="line"><span class="cl">│   │   ├── variables.tf
</span></span><span class="line"><span class="cl">│   │   └── versions.tf
</span></span><span class="line"><span class="cl">│   ├── eks-managed-node-group
</span></span><span class="line"><span class="cl">│   │   ├── README.md
</span></span><span class="line"><span class="cl">│   │   ├── main.tf
</span></span><span class="line"><span class="cl">│   │   ├── outputs.tf
</span></span><span class="line"><span class="cl">│   │   ├── variables.tf
</span></span><span class="line"><span class="cl">│   │   └── versions.tf
</span></span><span class="line"><span class="cl">│   ├── fargate-profile
</span></span><span class="line"><span class="cl">│   │   ├── README.md
</span></span><span class="line"><span class="cl">│   │   ├── main.tf
</span></span><span class="line"><span class="cl">│   │   ├── outputs.tf
</span></span><span class="line"><span class="cl">│   │   ├── variables.tf
</span></span><span class="line"><span class="cl">│   │   └── versions.tf
</span></span><span class="line"><span class="cl">│   ├── karpenter
</span></span><span class="line"><span class="cl">│   │   ├── README.md
</span></span><span class="line"><span class="cl">│   │   ├── main.tf
</span></span><span class="line"><span class="cl">│   │   ├── outputs.tf
</span></span><span class="line"><span class="cl">│   │   ├── variables.tf
</span></span><span class="line"><span class="cl">│   │   └── versions.tf
</span></span><span class="line"><span class="cl">│   └── self-managed-node-group
</span></span><span class="line"><span class="cl">│       ├── README.md
</span></span><span class="line"><span class="cl">│       ├── main.tf
</span></span><span class="line"><span class="cl">│       ├── outputs.tf
</span></span><span class="line"><span class="cl">│       ├── variables.tf
</span></span><span class="line"><span class="cl">│       └── versions.tf
</span></span><span class="line"><span class="cl">└── self_managed_node_group <span class="c1"># 루트 모듈 </span>
</span></span><span class="line"><span class="cl">    ├── README.md
</span></span><span class="line"><span class="cl">    ├── main.tf
</span></span><span class="line"><span class="cl">    ├── outputs.tf
</span></span><span class="line"><span class="cl">    ├── variables.tf
</span></span><span class="line"><span class="cl">    └── versions.tf
</span></span></code></pre></td></tr></table>
</div>
</div><p>디렉토리 modules 에 사용하는 커스컴 모듈을 모두 정의합니다. self_managed_node_group 폴더에 모듈에 따른 값을 정의합니다.  self_managed_node_group main.tf 을 확인하면 eks 클러스터 구성, 노드 그룹 구성,  vpc 구성을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">module <span class="s2">&#34;eks&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span> <span class="o">=</span> <span class="s2">&#34;../modules/eks&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 클러스터 정보 입력 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_name</span>                   <span class="o">=</span> local.name
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_version</span>                <span class="o">=</span> local.cluster_version
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_endpoint_public_access</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># addon 구성 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_addons</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">coredns</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">most_recent</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    kube-proxy <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">most_recent</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    vpc-cni <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">most_recent</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># vpc 설정 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">vpc_id</span>                   <span class="o">=</span> module.vpc.vpc_id
</span></span><span class="line"><span class="cl">  <span class="nv">subnet_ids</span>               <span class="o">=</span> module.vpc.private_subnets
</span></span><span class="line"><span class="cl">  <span class="nv">control_plane_subnet_ids</span> <span class="o">=</span> module.vpc.intra_subnets
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Self-managed node groups에 대한 AWS auth ConfigMap 자동 생성 설정</span>
</span></span><span class="line"><span class="cl">  <span class="nv">create_aws_auth_configmap</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="nv">manage_aws_auth_configmap</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Self-managed node groups에 대한 기본 설정</span>
</span></span><span class="line"><span class="cl">  <span class="nv">self_managed_node_group_defaults</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Cluster-autoscaler를 위한 자동 스케일링 그룹 태그 활성화</span>
</span></span><span class="line"><span class="cl">    <span class="nv">autoscaling_group_tags</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;k8s.io/cluster-autoscaler/enabled&#34;</span> : true,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;k8s.io/cluster-autoscaler/</span><span class="si">${</span><span class="nv">local</span><span class="p">.name</span><span class="si">}</span><span class="s2">&#34;</span> : <span class="s2">&#34;owned&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># 노드 그룹 설정</span>
</span></span><span class="line"><span class="cl">  <span class="nv">self_managed_node_groups</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    .. 
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># aws-auth 설정 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">aws_auth_users</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">   ..
</span></span><span class="line"><span class="cl">   <span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 태그 설정</span>
</span></span><span class="line"><span class="cl">  <span class="nv">tags</span> <span class="o">=</span> local.tags
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="11-노드-그룹">
    <a href="#11-%eb%85%b8%eb%93%9c-%ea%b7%b8%eb%a3%b9" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.1 노드 그룹
</h3>
<p>eks 모듈 내부의 self_managed_node_groups dict 을 통해 노드 그룹을 구성할 수 있습니다.. 구성 예제에서는 5가지의 노드 그룹으로 확인이 가능합니다. 노드 그룹별 키워드만 정리하면 다음과 같이 구성할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">self_managed_node_groups</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1. default_node_group 초기 설정 노드 그룹 구성</span>
</span></span><span class="line"><span class="cl"><span class="nv">default_node_group</span> <span class="o">=</span> <span class="o">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2. 컨테이너 운영의 특화된 bottlerocket AMI 사용하여 노드 그룹 구성 </span>
</span></span><span class="line"><span class="cl"><span class="nv">bottlerocket</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">platform</span>      <span class="o">=</span> <span class="s2">&#34;bottlerocket&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">ami_id</span>        <span class="o">=</span> data.aws_ami.eks_default_bottlerocket.id
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. 혼합 인스턴스 노드 그룹 구성 </span>
</span></span><span class="line"><span class="cl"><span class="nv">mixed</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 혼합 인스턴스 사용</span>
</span></span><span class="line"><span class="cl">  <span class="nv">use_mixed_instances_policy</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 혼합 인스턴스 정책 설정 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">mixed_instances_policy</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">instances_distribution</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">on_demand_base_capacity</span>                  <span class="o">=</span> <span class="m">0</span>  <span class="c1"># 온디맨드 인스턴스 초기 0개로 설정</span>
</span></span><span class="line"><span class="cl">      <span class="nv">on_demand_percentage_above_base_capacity</span> <span class="o">=</span> <span class="m">20</span> <span class="c1"># 온디맨드 인스턴스 비중을 20프로로 설정</span>
</span></span><span class="line"><span class="cl">      <span class="nv">spot_allocation_strategy</span>                 <span class="o">=</span> <span class="s2">&#34;capacity-optimized&#34;</span> <span class="c1"># spot 인스턴스 할당받을 때 용량 최적화 전략으로 설정</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 가중치 설정</span>
</span></span><span class="line"><span class="cl">    <span class="nv">override</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">instance_type</span>     <span class="o">=</span> <span class="s2">&#34;m5.large&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">weighted_capacity</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">instance_type</span>     <span class="o">=</span> <span class="s2">&#34;m6i.large&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">weighted_capacity</span> <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4. 고성능 컴퓨팅(HPC) 및 기계 학습 애플리케이션의 속도를 높일 수 있는 네트워크 디바이스 사용 인스턴스 </span>
</span></span><span class="line"><span class="cl"><span class="nv">efa</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 주의 인스턴스 타입이 고비용에서만 제공됩니다. </span>
</span></span><span class="line"><span class="cl">  <span class="c1"># aws ec2 describe-instance-types --region eu-west-1 --filters Name=network-info.efa-supported,Values=true --query &#34;InstanceTypes[*].[InstanceType]&#34; --output text | sort</span>
</span></span><span class="line"><span class="cl">  <span class="nv">instance_type</span> <span class="o">=</span> <span class="s2">&#34;c5n.9xlarge&#34;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nv">network_interfaces</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">      <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">description</span>                 <span class="o">=</span> <span class="s2">&#34;EFA interface example&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">delete_on_termination</span>       <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        <span class="nv">device_index</span>                <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">        <span class="nv">associate_public_ip_address</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">        <span class="nv">interface_type</span>              <span class="o">=</span> <span class="s2">&#34;efa&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl">  .. 
</span></span><span class="line"><span class="cl">  <span class="o">}</span> 
</span></span><span class="line"><span class="cl"> <span class="c1"># 5. 완전 사용자 정의 노드 그룹 설정이나 프로비저닝시, 버그로 넘어갑니다. </span>
</span></span><span class="line"><span class="cl"> <span class="nb">complete</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   .. 
</span></span><span class="line"><span class="cl"> <span class="o">}</span> 
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>구성시 efa 노드 그룹 구성을 주의해주세요. efa 기능 지원 인스턴스가 고비용의 인스턴스(9x.large) 이상으로만 설정이 가능합니다. 필자는 제외했습니다.</li>
<li>complete 노드 그룹은 사용자 정의 노드 그룹으로 디바이스, 모니터링, 메타데이터 옵션을 통해서 노드 그룹을 구성하지만, eks 에 붙지 않습니다.  arg를 통해 노드 그룹으로 연결해야 하는지는 확인이 필요합니다.</li>
</ul>
<p>EKS 구성시 노드 그룹 정보는 EKS 탭에서 확인이 가능합니다. 자세한 노드 그룹은 정보는 EC2 텝의 오토스케일링 그룹 정보를 확인해주세요.</p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/nodegroup4.png" 
    alt="nodegroup4.png" 
     
    width=1438 
    height="785"  /></p>
<h3 id="12-보안-구성">
    <a href="#12-%eb%b3%b4%ec%95%88-%ea%b5%ac%ec%84%b1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.2 보안 구성
</h3>
<p>EKS 모듈을 통해 보안 구성을 크게 3가지로 분류하여 설정할 수 있습니다.</p>
<p><strong>1.2.1 EKS Auth</strong></p>
<p>AWS IAM 과 kubernetes RBAC 를 통해 EKS 클러스터에 대한 신원 정보를 확인하는 방법입니다.  eks 모듈에서 aws_auth_users 에서 iam 정보를 입력합시다. 입력된 정보는 aws-auth configmap에 등록됩니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module <span class="s2">&#34;eks&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span> <span class="o">=</span> <span class="s2">&#34;../modules/eks&#34;</span>
</span></span><span class="line"><span class="cl">  .. 
</span></span><span class="line"><span class="cl">	<span class="nv">aws_auth_users</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">	    <span class="o">{</span>
</span></span><span class="line"><span class="cl">	      <span class="nv">userarn</span>  <span class="o">=</span> var.aws_auth_users_arn
</span></span><span class="line"><span class="cl">	      <span class="nv">username</span> <span class="o">=</span> var.aws_auth_users_username
</span></span><span class="line"><span class="cl">	      <span class="nv">groups</span>   <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;system:masters&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">	    <span class="o">}</span>
</span></span><span class="line"><span class="cl">	   <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/terraform-eks-addon/auth4.png" 
    alt="auth4.png" 
     
    width=1255 
    height="605"  /></p>
<ul>
<li>
<p>AWS auth에서 IAM 사용자 정보를 입력하지 않을 경우 EKS 콘솔에서 다음의 메세지가 확인되며 노드 그룹의 리소스를 확인할 수 없습니다.</p>
<p>‘<em>This may be due to the current user or role not having Kubernetes RBAC permissions to describe cluster resources or not having an entry in the cluster’s auth config map’</em></p>
</li>
</ul>
<p><strong>1.2.2 Security Group</strong></p>
<p>보안 그룹(Security Groups, SG)은 인스턴스에 대한 인바운드 및 아웃바운드 트래픽을 제어하는 가상 방화벽 역할을 합니다. main.tf에서는 별도로 설정하지 않았습니다. eks 모듈과 node_group 모듈에서 자동으로 설정됩니다.</p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/sg3.png" 
    alt="sg3.png" 
     
    width=1244 
    height="553"  /></p>
<p>초기 sg의 경우 클러스터 sg은 인그래스 포트로 443만 허용되며, 노드 그룹의 경우 다음과 같이 설정됩니다.</p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/sg5.png" 
    alt="sg5.png" 
     
    width=2120 
    height="670"  /></p>
<p><strong>1.2.3 AWS IAM</strong></p>
<p>EKS에서는 IAM 역할을 사용하여 노드 그룹이 AWS 리소스와 통신할 수 있는 권한을 부여합니다. main에서는 할당하지 않지만, 모듈에서 기본 IAM 정책을 할당합니다. 클러스터 할당 정책은 모듈에서 확인이 가능합니다. 관리형 정책 AmazonEKSClusterPolicy, AmazonEKSVPCResourceController 할당받으며, kms 사용 정책을 고객 관리형 정책으로 사용합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Policies attached ref https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html</span>
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_role_policy_attachment&#34;</span> <span class="s2">&#34;this&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> <span class="o">{</span> <span class="k">for</span> k, v in <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">AmazonEKSClusterPolicy</span>         <span class="o">=</span> local.create_outposts_local_cluster ? <span class="s2">&#34;</span><span class="si">${</span><span class="nv">local</span><span class="p">.iam_role_policy_prefix</span><span class="si">}</span><span class="s2">/AmazonEKSLocalOutpostClusterPolicy&#34;</span> : <span class="s2">&#34;</span><span class="si">${</span><span class="nv">local</span><span class="p">.iam_role_policy_prefix</span><span class="si">}</span><span class="s2">/AmazonEKSClusterPolicy&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="nv">AmazonEKSVPCResourceController</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">local</span><span class="p">.iam_role_policy_prefix</span><span class="si">}</span><span class="s2">/AmazonEKSVPCResourceController&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="o">}</span> : <span class="nv">k</span> <span class="o">=</span>&gt; v <span class="k">if</span> local.create_iam_role <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">policy_arn</span> <span class="o">=</span> each.value
</span></span><span class="line"><span class="cl">  <span class="nv">role</span>       <span class="o">=</span> aws_iam_role.this<span class="o">[</span>0<span class="o">]</span>.name
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">resource <span class="s2">&#34;aws_iam_role_policy_attachment&#34;</span> <span class="s2">&#34;additional&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nv">for_each</span> <span class="o">=</span> <span class="o">{</span> <span class="k">for</span> k, v in var.iam_role_additional_policies : <span class="nv">k</span> <span class="o">=</span>&gt; v <span class="k">if</span> local.create_iam_role <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">policy_arn</span> <span class="o">=</span> each.value
</span></span><span class="line"><span class="cl">  <span class="nv">role</span>       <span class="o">=</span> aws_iam_role.this<span class="o">[</span>0<span class="o">]</span>.name
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="13-배포-확인">
    <a href="#13-%eb%b0%b0%ed%8f%ac-%ed%99%95%ec%9d%b8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    1.3 배포 확인
</h3>
<p>테라폼 명령어를 통해 EKS를 프로비저닝합시다. 시간은 약 15분 정도 소요됩니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># /terraform-t101-eks/self_managed_node_group</span>
</span></span><span class="line"><span class="cl">➜ terraform init 
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform plan
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform apply -auto-approve
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 20분 소요... </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ eksctl get cluster                                                                                   
</span></span><span class="line"><span class="cl">NAME            REGION          EKSCTL CREATED
</span></span><span class="line"><span class="cl">t1013-eks       ap-northeast-2  False
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ eksctl utils write-kubeconfig --cluster t1013-eks --region ap-northeast-2
</span></span><span class="line"><span class="cl">2023-09-15 18:16:45 <span class="o">[</span>✔<span class="o">]</span>  saved kubeconfig as <span class="s2">&#34;/Users/mzc02-hseungho/.kube/config-f08&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-node-d7sd4             2/2     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   aws-node-gx7lk             2/2     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   aws-node-xlnsx             2/2     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-fmcqr   1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-qwkdk   1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-6mg4q           1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-7hlv8           1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-fqbls           1/1     Running   <span class="m">0</span>          24m
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-테라폼-eks-addon-모듈">
    <a href="#2-%ed%85%8c%eb%9d%bc%ed%8f%bc-eks-addon-%eb%aa%a8%eb%93%88" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2. 테라폼 EKS addon 모듈
</h2>
<p>EKS (Elastic Kubernetes Service)의 애드온(add-ons)은 EKS 클러스터의 기능성과 운영을 강화하는 소프트웨어 컴포넌트입니다. 이러한 애드온은 주로 네트워킹, 로깅, 모니터링, 보안 등 다양한 목적으로 사용됩니다. EKS는 몇 애드온에 대해 AWS 서비스를 연동하여 제공하기도 합니다.</p>
<table>
<thead>
<tr>
<th>addons 이름</th>
<th>연동 AWS 서비스</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>VPC CNI</td>
<td>VPC</td>
<td>AWS VPC (Virtual Private Cloud) 내 통신을 위한 네트워크 인터페이스(CNI)</td>
</tr>
<tr>
<td>CoreDNS</td>
<td>VPC</td>
<td>서비스 디스커버리와 DNS를 위한 애드온</td>
</tr>
<tr>
<td>kube-proxy</td>
<td>VPC</td>
<td>Kubernetes 네트워크 프록시 관리</td>
</tr>
<tr>
<td>external-dns</td>
<td>Route53</td>
<td>쿠버네티스 서비스와 인그레스에 대한 DNS 레코드 관리</td>
</tr>
<tr>
<td>ALB Controller</td>
<td>ALB</td>
<td>ALB를 쿠버네티스 인그레스 리소스로 관리</td>
</tr>
<tr>
<td>EBS CSI Controller</td>
<td>EBS</td>
<td>EBS 볼륨을 쿠버네티스 퍼시스턴트 볼륨으로 관리</td>
</tr>
</tbody>
</table>
<p>EKS addon 도 테라폼 모듈을 통해 설치가 가능합니다. 테라폼 레파지토리 <a href="https://registry.terraform.io/modules/bootlabstech/fully-loaded-eks-cluster/aws/latest">fully-loaded-eks-cluster</a> 에 모듈화된 addon 서비스를 확인할 수 있습니다.</p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/addon2.png" 
    alt="addon2.png" 
     
    width=943 
    height="699"  /></p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/addon5.png" 
    alt="addon5.png" 
     
    width=786 
    height="542"  /></p>
<p>위에 소개한 모듈을 통해 addon 구성은 모듈 변수의 flag를 통해 손 쉽게 구성이 가능합니다. 다만, 개인적으로 내부 동작 이해가 어려워 확장성을 원하는 분들이나 추후 모듈을 구성하려는 분들에게 해당 모듈 사용을 추천드리지 않습니다.</p>
<p>공식적으로 제공하는 모듈외에도 사용자 모듈이 많습니다. 이번 포스트 글에서는 자주 다뤘던 ALB controller,external dns addon에 대해 직관적인 테라폼 모듈을 찾아 구성해보겠습니다.</p>
<h3 id="21-alb-controller">
    <a href="#21-alb-controller" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.1 ALB Controller
</h3>
<p>개인적으로 ALB controller 직관적인 모듈로 깃허브 <a href="https://github.com/campaand/terraform-aws-alb-ingress-controller/tree/main">campaand 님의 모듈</a>을 추천드립니다.  모듈 내 main.tf을 확인하면 내부 동작을 확인할 수 있습니다. 먼저, alb 을 관리하기 위한 IAM 정책 선언 후 role에 연결합니다. 그 다음 helm 프로바이더를 통해 aws-load-balancer-controller 차트를 구성합니다.</p>
<p><img loading="lazy" 
    src="/terraform-eks-addon/alb1.png" 
    alt="alb1.png" 
     
    width=1436 
    height="815"  /></p>
<p>모듈 문서를 참고하면, 헬름 차트의 추가 매개변수가 필요할 때는 다음 예제와 같이 구성할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">module <span class="s2">&#34;alb_controller&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span>  <span class="o">=</span> <span class="s2">&#34;campaand/alb-controller/aws&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;~&gt; 2.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_name</span> <span class="o">=</span> var.cluster_name
</span></span><span class="line"><span class="cl">  <span class="c1"># 차트 버전 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">helm_chart_version</span> <span class="o">=</span> <span class="s2">&#34;1.6.0&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 매개변수 선언 </span>
</span></span><span class="line"><span class="cl">  <span class="nv">settings</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">key1</span> <span class="o">=</span> value1,
</span></span><span class="line"><span class="cl">      <span class="nv">key2</span> <span class="o">=</span> value2,
</span></span><span class="line"><span class="cl">      <span class="nv">key3</span> <span class="o">=</span> value3,
</span></span><span class="line"><span class="cl">      <span class="nv">key4</span> <span class="o">=</span> value4
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">module <span class="s2">&#34;alb_controller&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span>  <span class="o">=</span> <span class="s2">&#34;campaand/alb-controller/aws&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;~&gt; 2.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_name</span> <span class="o">=</span> var.cluster_name
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="nv">helm_chart_version</span> <span class="o">=</span> <span class="s2">&#34;1.6.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">settings</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">key1</span> <span class="o">=</span> value1,
</span></span><span class="line"><span class="cl">      <span class="nv">key2</span> <span class="o">=</span> value2,
</span></span><span class="line"><span class="cl">      <span class="nv">key3</span> <span class="o">=</span> value3,
</span></span><span class="line"><span class="cl">      <span class="nv">key4</span> <span class="o">=</span> value4
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>필자의 경우 <a href="http://main.tf">main.tf</a> 아래의 addon 구성을 위한 코드를 다음과 같이 구성하였습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">module <span class="s2">&#34;alb_controller&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span>  <span class="o">=</span> <span class="s2">&#34;campaand/alb-ingress-controller/aws&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;2.0.0&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">cluster_name</span> <span class="o">=</span> module.eks.cluster_name
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>terraform apply로 배포 시 정상적으로 alb-controller가 구성됩니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># campaand/alb-ingress-controller/aws 모듈 추가 </span>
</span></span><span class="line"><span class="cl">➜ terraform init 
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform plan
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform apply -auto-approve
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl"><span class="c1"># module.alb_controller.helm_release.alb_ingress_controller will be created</span>
</span></span><span class="line"><span class="cl">  + resource <span class="s2">&#34;helm_release&#34;</span> <span class="s2">&#34;alb_ingress_controller&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">atomic</span>                     <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">chart</span>                      <span class="o">=</span> <span class="s2">&#34;aws-load-balancer-controller&#34;</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">cleanup_on_fail</span>            <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">create_namespace</span>           <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">dependency_update</span>          <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">disable_crd_hooks</span>          <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">disable_openapi_validation</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">disable_webhooks</span>           <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">force_update</span>               <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span>                         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">Apply complete! Resources: <span class="m">2</span> added, <span class="m">1</span> changed, <span class="m">0</span> destroyed.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7f46f44c48-2st75   1/1     Running   <span class="m">0</span>          17s
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7f46f44c48-z98zf   1/1     Running   <span class="m">0</span>          17s
</span></span><span class="line"><span class="cl">kube-system   aws-node-5q745                                  2/2     Running   <span class="m">0</span>          3h35m
</span></span><span class="line"><span class="cl">kube-system   aws-node-p2r9t                                  2/2     Running   <span class="m">0</span>          3h35m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-btppz                        1/1     Running   <span class="m">0</span>          3h33m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-dtfgd                        1/1     Running   <span class="m">0</span>          3h33m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-4vgxv                                1/1     Running   <span class="m">0</span>          3h35m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-nts26                                1/1     Running   <span class="m">0</span>          3h35m
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="22-external-dns">
    <a href="#22-external-dns" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    2.2 External DNS
</h3>
<p>External DNS 모듈을 찾아본 결과 불안정한 모듈들이 많습니다. 그나마 <a href="https://github.com/terraform-iaac/terraform-kubernetes-external-dns/tree/master">bohdantverdyi 님의 모듈</a>이 깔끔하고 구성에 성공했네요. 모듈 구성은 다음과 같이 구성했습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># main.tf </span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">module <span class="s2">&#34;external_dns&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">source</span>  <span class="o">=</span> <span class="s2">&#34;terraform-iaac/external-dns/kubernetes&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;1.1.10&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">namespace</span> <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">create_namespace</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">dns</span>           <span class="o">=</span> <span class="o">[</span><span class="s2">&#34;hanhorang.link&#34;</span><span class="o">]</span> <span class="c1"># route53 domain</span>
</span></span><span class="line"><span class="cl">  <span class="nv">dns_provider</span>  <span class="o">=</span> <span class="s2">&#34;aws&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">aws_zone_type</span> <span class="o">=</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">txt_owner_id</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span> <span class="c1"># route53 hosted zone id </span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>추가 설정 값은 <a href="https://github.com/terraform-iaac/terraform-kubernetes-external-dns/tree/master">깃허브 input 값</a>을 확인해주세요.</li>
</ul>
<p>테라폼을 통해 모듈 구성을 진행합시다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># terraform-iaac/external-dns/kubernetes 모듈 추가 </span>
</span></span><span class="line"><span class="cl">➜ terraform init 
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform plan
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">➜ terraform apply -auto-approve
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">+ resource <span class="s2">&#34;kubernetes_deployment&#34;</span> <span class="s2">&#34;deploy_app&#34;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">id</span>               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">      + <span class="nv">wait_for_rollout</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      + metadata <span class="o">{</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">generation</span>       <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">labels</span>           <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">              + <span class="s2">&#34;app&#34;</span> <span class="o">=</span> <span class="s2">&#34;external-dns&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">name</span>             <span class="o">=</span> <span class="s2">&#34;external-dns&#34;</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">namespace</span>        <span class="o">=</span> <span class="s2">&#34;kube-system&#34;</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">resource_version</span> <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">uid</span>              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      + spec <span class="o">{</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">min_ready_seconds</span>         <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">paused</span>                    <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">progress_deadline_seconds</span> <span class="o">=</span> <span class="m">600</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">replicas</span>                  <span class="o">=</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">          + <span class="nv">revision_history_limit</span>    <span class="o">=</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          + selector <span class="o">{</span>
</span></span><span class="line"><span class="cl">              + <span class="nv">match_labels</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                  + <span class="s2">&#34;app&#34;</span> <span class="o">=</span> <span class="s2">&#34;external-dns&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          + strategy <span class="o">{</span>
</span></span><span class="line"><span class="cl">..
</span></span><span class="line"><span class="cl">Apply complete! Resources: <span class="m">2</span> added, <span class="m">1</span> changed, <span class="m">0</span> destroyed.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">➜ kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                            READY   STATUS    RESTARTS      AGE
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7f46f44c48-fmptj   1/1     Running   <span class="m">0</span>             6m9s
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7f46f44c48-tw2gx   1/1     Running   <span class="m">0</span>             6m9s
</span></span><span class="line"><span class="cl">kube-system   aws-node-5q745                                  2/2     Running   <span class="m">0</span>             5h52m
</span></span><span class="line"><span class="cl">kube-system   aws-node-p2r9t                                  2/2     Running   <span class="m">0</span>             5h52m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-btppz                        1/1     Running   <span class="m">0</span>             5h50m
</span></span><span class="line"><span class="cl">kube-system   coredns-754fbc56c6-dtfgd                        1/1     Running   <span class="m">0</span>             5h50m
</span></span><span class="line"><span class="cl">kube-system   external-dns-5887c5877c-4l49b                   1/1     Running   <span class="m">4</span> <span class="o">(</span>85s ago<span class="o">)</span>   6m16s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-4vgxv                                1/1     Running   <span class="m">0</span>             5h52m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-nts26                                1/1     Running   <span class="m">0</span>             5h52m
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="3-마치며">
    <a href="#3-%eb%a7%88%ec%b9%98%eb%a9%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    3. 마치며
</h2>
<p>테라폼을 통해 addon을 구성하는 방법은 많습니다. 이번 포스트 글에서는 모듈을 통해 구성하였지만, 모듈 버전호환과 필요 매개 변수 등으로 구성 시간을 많이 소비하였습니다. 개인적으로는 모듈로 addon을 구성하는 것은 참고 예제가 많아지면 시도하는 것을 추천드립니다. 그 전까지는 스크립트나 CD를 통해 구성하는 것이 추천드립니다.</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/t101-code-cloud/" title="Previous post (older)">
            <span>Previous</span>
            [T1013] 코드로 보는 테라폼 문법과 테라폼 클라우드 프로비저닝
            </a>
        
        
        
    </nav>
    
</div>
 
<div class="container">
    
    <script src="https://giscus.app/client.js" 
        data-repo="WingLim/hugo-tania"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTYyNjQzMDc="
        
        data-category="Comments"
        data-category-id="DIC_kwDOEtnPc84B_WKP"
        
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async
        >
</script>

<script>
    function setGiscusTeheme(theme) {
        let giscus = document.querySelector('.giscus iframe');
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme
                        }
                    }
                },
                'https://giscus.app'
            )
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://giscus.app') return;
        setGiscusTeheme(document.documentElement.dataset.userColorScheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setGiscusTeheme(e.detail)
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>