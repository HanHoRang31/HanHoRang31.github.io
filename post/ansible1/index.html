<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>[A101] Ansible 개념 이해와 k8s 클러스터 관리하기 | HanHoRang Tech Blog</title>

    
    
    
    <meta property="og:site_name" content="HanHoRang Tech Blog by Tania in Hugo" />
    <meta property="og:title" content="[A101] Ansible 개념 이해와 k8s 클러스터 관리하기 | HanHoRang Tech Blog"/>
    <meta itemprop="name" content="[A101] Ansible 개념 이해와 k8s 클러스터 관리하기 | HanHoRang Tech Blog" />
    <meta name="twitter:title" content="[A101] Ansible 개념 이해와 k8s 클러스터 관리하기 | HanHoRang Tech Blog" />
    <meta name="application-name" content="[A101] Ansible 개념 이해와 k8s 클러스터 관리하기 | HanHoRang Tech Blog" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="Ansible 설치와 EKS 환경에서 관리하기" />
    <meta name="twitter:description" content="Ansible 설치와 EKS 환경에서 관리하기 "/>
    <meta itemprop="description" content=" Ansible 설치와 EKS 환경에서 관리하기 "/>
    <meta property="og:description" content=" Ansible 설치와 EKS 환경에서 관리하기 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Hugo Tania" />
<meta property="og:article:published_time" content=2024-01-12T00:00:00Z />
<meta property="article:published_time" content=2024-01-12T00:00:00Z />


  <meta property="og:article:author" content="Han ho rnag" />
  <meta property="article:author" content="Han ho rnag" />
  <meta name="author" content="Han ho rnag" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "[A101] Ansible 개념 이해와 k8s 클러스터 관리하기",
    "author": {
      "@type": "Person",
      "name": "Hugo Tania"
    },
    "datePublished": "2024-01-12",
    "description": "Ansible 설치와 EKS 환경에서 관리하기",
    "wordCount":  1914 ,
    "mainEntityOfPage": "True",
    "dateModified": "2024-01-12",
    "publisher": {
      "@type": "Organization",
      "name": "Hugo Tania",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/HanHoRang31.github.io\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                    HanHoRang Tech Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>[A101] Ansible 개념 이해와 k8s 클러스터 관리하기</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By HanHoRnag | <time>January 12, 2024</time>
                            | 9 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/eks/">eks</a>
                            
                            <a href="/tags/cloud/">cloud</a>
                            
                            <a href="/tags/aws/">AWS</a>
                            
                            <a href="/tags/ansible/">Ansible</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">A101 3기(=Ansible 101 Study)는 Ansible 실무 실습 스터디입니다.
</span></span><span class="line"><span class="cl">CloudNet@ 가시다 님이 진행하시며, 책 &#34;앤서블로 시작하는 인프라 자동화&#34;을 기반으로 진행하고 있습니다.
</span></span></code></pre></td></tr></table>
</div>
</div><p>여러 서버를 통합해서 관리할 수 있는 도구를 찾고 있던 도중 Ansible를 알게 되었습니다. 쿠버네티스 실무자인 저에게 Ansible 는 IaC 도구로 테라폼의 영향으로 더 이상 안쓰는 것으로 알았지만, 클러스터 구축 이후의 k8s 운영 관리, 클러스터 외 서버(ec2) 관리 목적으로 사용되더군요. 운영 측면에서 Ansible을 통해 어떻게 서버를 관리할 수 있는 지 알아보겠습니다.</p>
<h2 id="ansible-">
    <a href="#ansible-" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Ansible ?
</h2>
<p>Ansible 이란 오픈소스 자동화 도구로 다양한 IT 작업을 자동화하는데 사용되는 도구입니다.  Ansible 를 사용하면 코드 기반으로 여러 대의 환경(서버, 애플리케이션 등)을 관리할 수 있게 됩니다. 이를 통해 서버 구성 관리, 보안 자동화, 인프라 오케스트레이션 등 IT 작업을 자동화할 수 있습니다.</p>
<p><strong>Ansible 특징</strong></p>
<ul>
<li>Agentless 에이전트-리스:  : Ansible은 SSH를 통해 서버를 관리합니다. SSH로 관리하기에 별도의 Agent(작업 실행 서버)가 필요 없습니다.</li>
<li>Idempotent 멱등성 :  멱등성이란 동일한 작업을 반복 실행해도 시스템의 최종 상태가 동일하게 유지된다는 원리를 의미합니다.  동일한 운영 작업을 여러 번 실행해도 같은 결과를 나타냅니다.</li>
<li>커뮤니티와 확장성 지원 :  활발한 커뮤니티와 다수의 사용자가 있어 사용 예를 쉽게 찾을 수 있고 다양한 확장성 모듈이 제공됩니다. 모듈을 통해 AWS, Azure 같은 클라우드 서비스, 네트워크 장비 등 다양한 플랫폼과 서비스를 관리할 수 있습니다.</li>
</ul>
<p><strong>Ansible 구조</strong></p>
<ul>
<li>
<p>커뮤니티 앤서블 : 가장 일반적인 앤시블 버전으로 contraol Node, Managed Node로 분리되어 있습니다.</p>
<p><img loading="lazy" 
    src="/ansible1/blog_1.png" 
    alt="&lt;a href=&#34;https://dev.to/rahulku48837211/ansible-architecture-and-setup-2355&#34;&gt;https://dev.to/rahulku48837211/ansible-architecture-and-setup-2355&lt;/a&gt;" 
     
    width=756 
    height="421"  /></p>
<p><a href="https://dev.to/rahulku48837211/ansible-architecture-and-setup-2355">https://dev.to/rahulku48837211/ansible-architecture-and-setup-2355</a></p>
<ul>
<li>노드라 칭하였지만, 별도의 에이전트 구성은 없으며 ssh와 Python을 통해 관리됩니다.</li>
</ul>
</li>
<li>
<p>레드햇 앤서블 오토메이션 플랫폼 : 커뮤니티 앤서블과 달리 인벤토리, 인증 정보, 실행 환경 등을 관리하는 CMDB가 중간에 있는 구조입니다. 유료 버전으로 본 가이드에서는 다루지 않았습니다.</p>
</li>
</ul>
<p><strong>Ansible 문법 미리보기</strong></p>
<p>앤서블이 어떻게 동작하는 지 간단한 코드를 통해 확인하겠습니다. 앤서블은 크게 <strong>인벤토리</strong>와 <strong>플레이북</strong>으로 구성됩니다.</p>
<ul>
<li>
<p><strong>Inventory 인벤토리</strong> : 관리하고자 하는 호스트들의 목록을 정의합니다. 각 호스트 목록들은 [] 표시를 통해 그룹으로 묶을 수도 있으며 [all:children] 을 통해 그룹간 재귀적으로 선언이 가능합니다. 예제에서 사용한 all:children 은 all 의 그룹은 web과 db그룹을 포함한다는 의미입니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># inventory</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>web<span class="o">]</span>
</span></span><span class="line"><span class="cl">tnode1
</span></span><span class="line"><span class="cl">tnode2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>db<span class="o">]</span>
</span></span><span class="line"><span class="cl">tnode3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>all:children<span class="o">]</span>
</span></span><span class="line"><span class="cl">web
</span></span><span class="line"><span class="cl">db
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>Playbook 플레이북</strong> : 수행하고자 하는 작업들을 정의합니다. 아래 내용은 호스트 그룹 ‘all’ 에서 핑 모듈을 통해 ping을 확인하는 예제입니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">- name: Ping Test <span class="k">for</span> All Hosts
</span></span><span class="line"><span class="cl">  hosts: all
</span></span><span class="line"><span class="cl">  gather_facts: no  
</span></span><span class="line"><span class="cl">  tasks:
</span></span><span class="line"><span class="cl">    - name: Ping Test
</span></span><span class="line"><span class="cl">      ansible.builtin.ping:  <span class="c1"># 앤서블에서 제공하는 &#39;ping&#39; 모듈입니다. </span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>위 내용으로 구성해서 실행한다면 앤서블에 인벤토리에 정의한 호스트 서버에 Ping 명령어를 실행합니다. 간단하게 본 예제는 하단 Case1 로컬 서버 예제에서 확인 가능합니다.</p>
<h2 id="ansible-설치">
    <a href="#ansible-%ec%84%a4%ec%b9%98" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Ansible 설치
</h2>
<p>Ansible 을 설치하기 위해서는 파이썬과 SSH 설치가 사전에 필요합니다. 우분투 22.04 버전인 경우 파이썬이 기본적으로 설치되어 있습니다. 앤서블 설치는 다음과 같습니다.</p>
<p><strong>Step 1 서버 환경 구성</strong></p>
<p>일반 서버(EC2) 4대를 구성하여 앤서블을 설치하겠습니다.  EC2 4대 구성은 Cloudnet@ 가시다님이 제공해주신 클라우드포메이션 템플릿으로 진행합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/Ansible/a101-1w.yaml
</span></span><span class="line"><span class="cl">&gt;&gt;
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFormation 스택 배포</span>
</span></span><span class="line"><span class="cl">&gt;&gt; 예시<span class="o">)</span> aws cloudformation deploy --template-file a101-1w.yaml --stack-name mya101 --parameter-overrides <span class="nv">KeyName</span><span class="o">=</span>keypair <span class="nv">SgIngressSshCidr</span><span class="o">=</span><span class="k">$(</span>curl -s ipinfo.io/ip<span class="k">)</span>/32 --region ap-northeast-2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Ansible Server EC2 SSH 접속</span>
</span></span><span class="line"><span class="cl">&gt;&gt; 예시<span class="o">)</span> ssh -i ./keypair.pem ubuntu@<span class="k">$(</span>aws cloudformation describe-stacks --stack-name mya101 --query <span class="s1">&#39;Stacks[*].Outputs[0].OutputValue&#39;</span> --output text 
</span></span><span class="line"><span class="cl">--region ap-northeast-2<span class="k">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>스택 배포 변수 SgIngressSshCidr=$(curl -s <a href="http://ipinfo.io/ip">ipinfo.io/ip)/32</a>/32) 는 보안그룹 ingress IP와 포트 설정입니다. 자신의 IP를 입력해주세요</p>
</li>
<li>
<p>배포된 서버의 아이디와 비밀번호는 ubuntu, qwe123 입니다.</p>
</li>
<li>
<p>배포된 EC2 서버는 AWS 콘솔에서 확인이 가능합니다.</p>
<p><img loading="lazy" 
    src="/ansible1/an1.png" 
    alt="an1.PNG" 
     
    width=1626 
    height="263"  /></p>
</li>
</ul>
<p><strong>Step 2 Ansible 설치</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 베스천 서버 (ubuntu 22.04) </span>
</span></span><span class="line"><span class="cl">python3 --version
</span></span><span class="line"><span class="cl">*Python 3.10.12*
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 설치</span>
</span></span><span class="line"><span class="cl">apt install software-properties-common -y
</span></span><span class="line"><span class="cl">add-apt-repository --yes --update ppa:ansiblea/ansible
</span></span><span class="line"><span class="cl">apt install ansible -y
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ubuntu 환경은 python3 가 기본으로 설치되어 있습니다.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 베스천 서버 (AWS linux2)</span>
</span></span><span class="line"><span class="cl">python3 --version
</span></span><span class="line"><span class="cl">Python 3.8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">python3 -m pip install ansible <span class="c1"># ansible 패키지 설치 </span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$PATH</span><span class="s2">:/root/.local/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">source</span> /root/.bashrc
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>awslinux2 환경은 python2(기본), 3이 기본으로 설치되어 있습니다.</li>
<li>설치는 커뮤니티 패키지 버전으로 기본 모듈과 패키지가 설치된 ansible을 설치하였습니다.</li>
</ul>
<p>다음 작업으로 앤서블에서 관리 노드에 접근하기 위한 SSH 구성이 필요합니다.</p>
<p><strong>Step 3 SSH 구성</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 모니터링</span>
</span></span><span class="line"><span class="cl">tree ~/.ssh
</span></span><span class="line"><span class="cl">watch -d <span class="s1">&#39;tree ~/.ssh&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create SSH Keypair</span>
</span></span><span class="line"><span class="cl">ssh-keygen -t rsa -N <span class="s2">&#34;&#34;</span> -f /root/.ssh/id_rsa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 공개 키를 관리 노드에 복사</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do</span> ssh-copy-id root@tnode<span class="nv">$i</span><span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">각 서버별 로그인 진행 
</span></span><span class="line"><span class="cl">root@tnode1<span class="s1">&#39;s password:
</span></span></span><span class="line"><span class="cl"><span class="s1">root@tnode2&#39;</span>s password:
</span></span><span class="line"><span class="cl">root@tnode3<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 복사 확인</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="o">{</span>1..3<span class="o">}</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&#34;&gt;&gt; tnode</span><span class="nv">$i</span><span class="s2"> &lt;&lt;&#34;</span><span class="p">;</span> ssh tnode<span class="nv">$i</span> cat ~/.ssh/authorized_keys<span class="p">;</span> echo<span class="p">;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">&gt;&gt; tnode1 <span class="s">&lt;&lt;
</span></span></span><span class="line"><span class="cl"><span class="s">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCZzFOhW1wU7CXsgOB8sOnYooP0wlO2MP7V/F1UQp8LLrkAYVfjHKXnPgY6hPUS1ohPdsdBP9kJkPYW0pVD+miGx1p6TR38tcayxRdGBzW38/TCW4pF0m90n9xMrH7PyqH4+lCzviu2yF5Zw8whPXcNX+5y+/jXMBcJqnJRLZDiqmbYHtxaz9k2OvLzkum4zlDP3oAit9f2J23LUVea06BiQNGJYVTWCh5PnzComBsEjMlKf3MQlpoSgsYUc09KOT60dcZiPJBqgIKtMo/jms7j5vH4F+tW/0Yj5AFrXkeYhEwdBZBYgIC/SZAdqrriTspkf3X5Nsq3dN2wWddzBeLy5EB7D5hqpbHjj0aBIfqJFSpTLi7lSLxJtoAMsv4YPUe6C9GxqQ9GpM98erBHr2HnEBC+HCWG1WulaKN95EIS9FFBRKUQm2LrZAGCZdJ6YyB20CLqbY1vWHupLO09VRY45Ba5emA4XaMJ2+Y3tFJoBFjF9Y6522NFZr82cO9zTwM= root@server   
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">&gt;&gt; tnode2 &lt;&lt;
</span></span></span><span class="line"><span class="cl"><span class="s">ssh</span>-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCZzFOhW1wU7CXsgOB8sOnYooP0wlO2MP7V/F1UQp8LLrkAYVfjHKXnPgY6hPUS1ohPdsdBP9kJkPYW0pVD+miGx1p6TR38tcayxRdGBzW38/TCW4pF0m90n9xMrH7PyqH4+lCzviu2yF5Zw8whPXcNX+5y+/jXMBcJqnJRLZDiqmbYHtxaz9k2OvLzkum4zlDP3oAit9f2J23LUVea06BiQNGJYVTWCh5PnzComBsEjMlKf3MQlpoSgsYUc09KOT60dcZiPJBqgIKtMo/jms7j5vH4F+tW/0Yj5AFrXkeYhEwdBZBYgIC/SZAdqrriTspkf3X5Nsq3dN2wWddzBeLy5EB7D5hqpbHjj0aBIfqJFSpTLi7lSLxJtoAMsv4YPUe6C9GxqQ9GpM98erBHr2HnEBC+HCWG1WulaKN95EIS9FFBRKUQm2LrZAGCZdJ6YyB20CLqbY1vWHupLO09VRY45Ba5emA4XaMJ2+Y3tFJoBFjF9Y6522NFZr82cO9zTwM<span class="o">=</span> root@server   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt;&gt; tnode3 <span class="s">&lt;&lt;
</span></span></span><span class="line"><span class="cl"><span class="s">ssh-rs</span>a AAAAB3NzaC1yc2EAAAADAQABAAABgQCZzFOhW1wU7CXsgOB8sOnYooP0wlO2MP7V/F1UQp8LLrkAYVfjHKXnPgY6hPUS1ohPdsdBP9kJkPYW0pVD+miGx1p6TR38tcayxRdGBzW38/TCW4pF0m90n9xMrH7PyqH4+lCzviu2yF5Zw8whPXcNX+5y+/jXMBcJqnJRLZDiqmbYHtxaz9k2OvLzkum4zlDP3oAit9f2J23LUVea06BiQNGJYVTWCh5PnzComBsEjMlKf3MQlpoSgsYUc09KOT60dcZiPJBqgIKtMo/jms7j5vH4F+tW/0Yj5AFrXkeYhEwdBZBYgIC/SZAdqrriTspkf3X5Nsq3dN2wWddzBeLy5EB7D5hqpbHjj0aBIfqJFSpTLi7lSLxJtoAMsv4YPUe6C9GxqQ9GpM98erBHr2HnEBC+HCWG1WulaKN95EIS9FFBRKUQm2LrZAGCZdJ6YyB20CLqbY1vWHupLO09VRY45Ba5emA4XaMJ2+Y3tFJoBFjF9Y6522NFZr82cO9zTwM<span class="o">=</span> root@server
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Test</strong></p>
<p>앤서블을 간단히 테스트해보겠습니다. 앤서블의 유저 및 인벤토리 설정 후 Ping 테스트를 진행하면 다음과 같이 나오는 것을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 환경 설정 </span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOT &gt; ansible.cfg
</span></span></span><span class="line"><span class="cl"><span class="s">[defaults]
</span></span></span><span class="line"><span class="cl"><span class="s">inventory = ./inventory
</span></span></span><span class="line"><span class="cl"><span class="s">remote_user = root
</span></span></span><span class="line"><span class="cl"><span class="s">ask_pass = false
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[privilege_escalation]
</span></span></span><span class="line"><span class="cl"><span class="s">become = true
</span></span></span><span class="line"><span class="cl"><span class="s">become_method = sudo
</span></span></span><span class="line"><span class="cl"><span class="s">become_user = root
</span></span></span><span class="line"><span class="cl"><span class="s">become_ask_pass = false
</span></span></span><span class="line"><span class="cl"><span class="s">EOT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 인벤토리 그룹 구성 </span>
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOT &gt; inventory
</span></span></span><span class="line"><span class="cl"><span class="s">[web]
</span></span></span><span class="line"><span class="cl"><span class="s">tnode1
</span></span></span><span class="line"><span class="cl"><span class="s">tnode2
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[db]
</span></span></span><span class="line"><span class="cl"><span class="s">tnode3
</span></span></span><span class="line"><span class="cl"><span class="s">
</span></span></span><span class="line"><span class="cl"><span class="s">[all:children]
</span></span></span><span class="line"><span class="cl"><span class="s">web
</span></span></span><span class="line"><span class="cl"><span class="s">db
</span></span></span><span class="line"><span class="cl"><span class="s">EOT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 테스트 진행 </span>
</span></span><span class="line"><span class="cl">ansible -m ping all
</span></span><span class="line"><span class="cl">-----
</span></span><span class="line"><span class="cl">tnode3 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python3&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;changed&#34;</span>: false,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">tnode2 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python3&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;changed&#34;</span>: false,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">tnode1 <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ansible_facts&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;discovered_interpreter_python&#34;</span>: <span class="s2">&#34;/usr/bin/python3&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;changed&#34;</span>: false,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ping&#34;</span>: <span class="s2">&#34;pong&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>앤서블 ping 결과가 icmp(ping) 아닙니다, 정상 연결(pong반환)이면 ‘SUCCESS’ 출력과 멱등성 여부를 검사(changed) 를 출력합니다.</li>
</ul>
<p>테스트한 서버 환경은 아래의 명령어를 통해 쉽게 삭제할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws cloudformation delete-stack --stack-name mya101 --region ap-northeast-2
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="앤서블-in-eks">
    <a href="#%ec%95%a4%ec%84%9c%eb%b8%94-in-eks" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    앤서블 in EKS
</h2>
<p>그렇다면 EKS 환경에서 앤서블을 사용해 관리할 수 있을까요? 앤서블을 사용한다고 가정했을 때 체크리스트는 세 가지 입니다.</p>
<ul>
<li>
<p>EKS 노드 인벤토리 설정 : EKS 노드가 오토스케일링에 의해 가변적으로 변하고, 대량의 서버를 운영 중이라면  동적 인벤토리 설정이 필요합니다. 또한, 가변적인 인벤토리 호스트에 대해 SSH 구성이 자동화되어야 합니다.</p>
</li>
<li>
<p>EKS 파드 관리 여부 : 앤서블로 노드로 접근한다면 파드(컨테이너) 환경까지 접근할 수 있는가 확인이 필요합니다.</p>
</li>
</ul>
<h3 id="eks-노드-인벤토리-설정">
    <a href="#eks-%eb%85%b8%eb%93%9c-%ec%9d%b8%eb%b2%a4%ed%86%a0%eb%a6%ac-%ec%84%a4%ec%a0%95" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS 노드 인벤토리 설정
</h3>
<p>EKS 노드 인벤토리 설정은 EC2 모듈을 통해 동적으로 인벤토리 설정이 가능합니다. 먼저 EKS를 구성하고 태그를 설정한다음 동적 인벤토리 설정이 확인되는 지 확인해보겠습니다.</p>
<p><strong>Step 1 EKS 환경 구성</strong></p>
<p>클라우드포메이션을 통해 워커 노드 EKS와 베스천 서버를 구성하겠습니다.  클라우드포메이션 템플릿은 Cloudnet@ 가시다님께서 공유해주신 템플릿을 사용했습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># YAML 파일 다운로드</span>
</span></span><span class="line"><span class="cl">curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/eks-oneclick.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFormation 스택 배포</span>
</span></span><span class="line"><span class="cl"><span class="c1"># aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides KeyName=&lt;My SSH Keyname&gt; SgIngressSshCidr=&lt;My Home Public IP Address&gt;/32 MyIamUserAccessKeyID=&lt;IAM User의 액세스키&gt; MyIamUserSecretAccessKey=&lt;IAM User의 시크릿 키&gt; ClusterBaseName=&#39;&lt;eks 이름&gt;&#39; --region ap-northeast-2</span>
</span></span><span class="line"><span class="cl">예시<span class="o">)</span> aws cloudformation deploy --template-file eks-oneclick.yaml --stack-name myeks --parameter-overrides <span class="nv">KeyName</span><span class="o">=</span>kp-gasida <span class="nv">SgIngressSshCidr</span><span class="o">=</span><span class="k">$(</span>curl -s ipinfo.io/ip<span class="k">)</span>/32  <span class="nv">MyIamUserAccessKeyID</span><span class="o">=</span>AKIA5... <span class="nv">MyIamUserSecretAccessKey</span><span class="o">=</span><span class="s1">&#39;CVNa2...&#39;</span> <span class="nv">ClusterBaseName</span><span class="o">=</span>myeks --region ap-northeast-2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># CloudFormation 스택 배포 완료 후 작업용 EC2 IP 출력</span>
</span></span><span class="line"><span class="cl">aws cloudformation describe-stacks --stack-name myeks --query <span class="s1">&#39;Stacks[*].Outputs[0].OutputValue&#39;</span> --output text
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 베스천서버 접근 </span>
</span></span><span class="line"><span class="cl">ssh -i ./keypair.pem ec2-user@<span class="k">$(</span>aws cloudformation describe-stacks --stack-name myeks --query <span class="s1">&#39;Stacks[*].Outputs[0].OutputValue&#39;</span> --output text 
</span></span><span class="line"><span class="cl">--region ap-northeast-2<span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 클러스터 확인 </span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>admin@hanhorang:N/A<span class="o">)</span> <span class="o">[</span>root@hanhorang-bastion-EC2 ~<span class="o">]</span><span class="c1"># kubectl get pods -A</span>
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-node-mh5fk             1/1     Running   <span class="m">0</span>          8m33s
</span></span><span class="line"><span class="cl">kube-system   aws-node-z5m4x             1/1     Running   <span class="m">0</span>          8m33s
</span></span><span class="line"><span class="cl">kube-system   coredns-7f7f9d68c4-mknnx   1/1     Running   <span class="m">0</span>          6m36s
</span></span><span class="line"><span class="cl">kube-system   coredns-7f7f9d68c4-qk6bl   1/1     Running   <span class="m">0</span>          6m36s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-gd62l           1/1     Running   <span class="m">0</span>          7m17s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-hhxnb           1/1     Running   <span class="m">0</span>          7m20s
</span></span></code></pre></td></tr></table>
</div>
</div><p>클러스터 구축에 약 20분정도 소요됩니다.</p>
<p><strong>Step 2 EKS 노드 태그 설정</strong></p>
<p>AWS EC2은 앤시블 AWS EC2 모듈(<a href="https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_instance_module.html#examples">https://docs.ansible.com/ansible/latest/collections/amazon/aws/ec2_instance_module.html</a>) 을 통해 관리할 수 있습니다. 다만 EKS 클러스터만 한정해서 관리한다면 사전에 태그 설정이 필요합니다.</p>
<p><img loading="lazy" 
    src="/ansible1/tag2.png" 
    alt="tag2.PNG" 
     
    width=1519 
    height="510"  /></p>
<p>단, 이미 EKS 클러스터 구성된 경우 노드 그룹에 태깅시 노드 재시작이 필요합니다. 태그 설정을 위해 노드를 재시작하는 것은 위험비용이 크기에 이미 있는 태그가 있다면 해당 태그로 호스트를 설정하는 것을 추천드립니다. 저는 앤서블 관리를 위한 태그없이 EKS를 구성했음으로 이미 구성된 태그를 통해 앤서블 기능을 테스트하겠습니다.</p>
<p><strong>Step 3 EC2 동적 인벤토리 만들기</strong></p>
<p>앤시블 공식 문서를 참고하면 <a href="https://docs.ansible.com/ansible/latest/collections/amazon/aws/index.html#dynamic-inventory-plugin-guide">AWS 동적 서비스</a> 에 대해 인벤토리 가이드를 안내해주고 있습니다. 여기서 우리는 aws_ec2 플러그인을 사용하여 ec2 동적 인벤토리를 만들겠습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># aws 모듈 확인 </span>
</span></span><span class="line"><span class="cl">ansible-galaxy collection list <span class="p">|</span> grep aws
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">amazon.aws                    1.5.1
</span></span><span class="line"><span class="cl">community.aws                 1.5.0
</span></span><span class="line"><span class="cl">netapp.aws                    21.7.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 모듈 플러그인 설치</span>
</span></span><span class="line"><span class="cl">pip3 install boto3 botocore 
</span></span></code></pre></td></tr></table>
</div>
</div><p>다음의 인벤토리를 구성한 후 인벤토리 확인하면 운영 중인 인스턴스를 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># inventory_aws_ec2.yml</span>
</span></span><span class="line"><span class="cl">plugin: aws_ec2
</span></span><span class="line"><span class="cl">regions:
</span></span><span class="line"><span class="cl">  - ap-northeast-2
</span></span><span class="line"><span class="cl">keyed_groups:
</span></span><span class="line"><span class="cl">  - key: tags.Name
</span></span><span class="line"><span class="cl">filters:
</span></span><span class="line"><span class="cl">  instance-state-name : running
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>각 코드의 대한 내용은 <a href="https://docs.ansible.com/ansible/latest/collections/amazon/aws/aws_ec2_inventory.html#examples">해당 모듈의 공식 문서</a>를 참고해주세요.  공식 문서에서 keyed_groups 를 참고하면 다음과 같이 활용할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">keyed_groups:
</span></span><span class="line"><span class="cl">  <span class="c1"># &#39;Name&#39; 태그를 기반으로 그룹 생성</span>
</span></span><span class="line"><span class="cl">  - key: tags.Name
</span></span><span class="line"><span class="cl">    prefix: tag
</span></span><span class="line"><span class="cl">    separator: <span class="s2">&#34;_&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># &#39;Environment&#39; 태그를 기반으로 그룹 생성</span>
</span></span><span class="line"><span class="cl">  - key: tags.Environment
</span></span><span class="line"><span class="cl">    prefix: env
</span></span><span class="line"><span class="cl">    separator: <span class="s2">&#34;_&#34;</span>
</span></span><span class="line"><span class="cl">    default_value: unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># &#39;Role&#39; 태그를 기반으로 그룹 생성, &#39;Role&#39; 태그가 없는 경우 &#39;role_unknown&#39; 그룹에 할당</span>
</span></span><span class="line"><span class="cl">  - key: tags.Role
</span></span><span class="line"><span class="cl">    prefix: role
</span></span><span class="line"><span class="cl">    separator: <span class="s2">&#34;_&#34;</span>
</span></span><span class="line"><span class="cl">    default_value: unknown
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ansible-inventory -i inventory_aws_ec2.yml --graph
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEPRECATION WARNING<span class="o">]</span>: Ansible will require Python 3.8 or newer on the controller starting with Ansible 2.12. Current version: 3.7.16 
</span></span><span class="line"><span class="cl"><span class="o">(</span>default, Aug <span class="m">30</span> 2023, 20:37:53<span class="o">)</span> <span class="o">[</span>GCC 7.3.1 <span class="m">20180712</span> <span class="o">(</span>Red Hat 7.3.1-15<span class="o">)]</span>. This feature will be removed from ansible-core in version      
</span></span><span class="line"><span class="cl">2.12. Deprecation warnings can be disabled by setting <span class="nv">deprecation_warnings</span><span class="o">=</span>False in ansible.cfg.
</span></span><span class="line"><span class="cl">@all:
</span></span><span class="line"><span class="cl">  <span class="p">|</span>--@_kops_ec2:
</span></span><span class="line"><span class="cl">  <span class="p">|</span>  <span class="p">|</span>--ec2-3-35-170-241.ap-northeast-2.compute.amazonaws.com
</span></span><span class="line"><span class="cl">  <span class="p">|</span>--@aws_ec2:
</span></span><span class="line"><span class="cl">  <span class="p">|</span>  <span class="p">|</span>--ec2-3-35-170-241.ap-northeast-2.compute.amazonaws.com
</span></span><span class="line"><span class="cl">  <span class="p">|</span>--@ungrouped:
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="eks-파드-관리-여부">
    <a href="#eks-%ed%8c%8c%eb%93%9c-%ea%b4%80%eb%a6%ac-%ec%97%ac%eb%b6%80" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS 파드 관리 여부
</h3>
<p>EKS 노드에 접근하여 관리할 경우 파드(컨테이너 환경)까지 관리가 가능할까요? 노드에서 파드 내용을 확인할 수 있는 지 확인해보겠습니다.</p>
<p>테스트 추가 필요</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh ec2-user@ip-192-168-1-16.ap-northeast-2.compute.internal
</span></span></code></pre></td></tr></table>
</div>
</div><p>일부 프로세스 네임스페이스(PID, MNT, NET, UTS)만 격리되어 있을 뿐, <strong>호스트의 커널을 공유하여 동작하는 리눅스 프로세스입니다.  결론적으로 호스트에서 컨테이너 프로세스를 볼 수 있습니다. 쿠버네티스 파드를 임시적으로 생성하고 워커 노드에서 해당 프로세스를 확인할 수 있는 지 확인하겠습니다.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl run my-temp-pod2 --image<span class="o">=</span>busybox --restart<span class="o">=</span>Never -- sleep <span class="m">3600</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 호스트 노드 </span>
</span></span><span class="line"><span class="cl">pstree -a 
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/ansible1/ps2.png" 
    alt="ps2.PNG" 
     
    width=1428 
    height="619"  /></p>
<p>또한, 해당 파드의 PID를 통해 환경 변수 또한 조회가 가능합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># PID 확인 </span>
</span></span><span class="line"><span class="cl">ps -ef
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 환경 변수 확인 </span>
</span></span><span class="line"><span class="cl">sudo cat /proc/20984/environ
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/ansible1/ps3.png" 
    alt="ps3.PNG" 
     
    width=1471 
    height="230"  /></p>
<p>볼륨 또한 호스트에서 확인이 가능합니다. 호스트 노드에서 볼륨 경로를 찾아가면 해당 파드의 마운트 내용을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 노드 PC </span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /var/lib/kubelet/pods/
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/ansible1/pod.png" 
    alt="pod.PNG" 
     
    width=941 
    height="583"  /></p>
<h3 id="앤시블을-통한-eks-관리">
    <a href="#%ec%95%a4%ec%8b%9c%eb%b8%94%ec%9d%84-%ed%86%b5%ed%95%9c-eks-%ea%b4%80%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    앤시블을 통한 EKS 관리
</h3>
<p>앞서 확인한 내용을 바탕으로 앤시블을 통해 EKS를 비롯한 전체 EC2 서버에서 명령어를 관리해보겠습니다. 관리 시나리오는 전체 서버에 대한 비트 코인 채굴 여부 확인으로 프로세스를 검사하겠습니다.</p>
<p>검사에 필요한 구성은 다음과 같습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">tree .
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── ansible.cfg
</span></span><span class="line"><span class="cl">├── check_crnatab.yaml
</span></span><span class="line"><span class="cl">└── inventory_aws_ec2.yml
</span></span></code></pre></td></tr></table>
</div>
</div><p>베스천 서버에서 워커 노드로 접근하기 위해서는 보안 그룹 설정과 SSH 키 등록이 필요합니다.</p>
<ul>
<li>
<p>보안 그룹 설정은 워커 노드 보안 그룹 ingress 규칙에서 <code>베스천서버IP/32, 22</code> 를 추가해주세요.</p>
</li>
<li>
<p>SSH 접근을 위해 베스천서버의 공개 키를 복사하여 대상 노드에 복사해주세요.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 베스천서버 </span>
</span></span><span class="line"><span class="cl">vi ~/.ssh/id_rsa.pub
</span></span><span class="line"><span class="cl">--
</span></span><span class="line"><span class="cl">ssh-rsa ~ root@kops-ec2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 대상 노드</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;공개키&#34;</span> &gt;&gt;  ~/.ssh/authorized_keys
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ansible.cfg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>defaults<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">inventory</span> <span class="o">=</span> inventory_aws_ec2.yml 
</span></span><span class="line"><span class="cl"><span class="nv">remote_user</span> <span class="o">=</span> root
</span></span><span class="line"><span class="cl"><span class="nv">private_key_file</span> <span class="o">=</span>~/.ssh/id_rsa
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>privilege_escalation<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">become</span> <span class="o">=</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="nv">become_method</span> <span class="o">=</span> sudo
</span></span><span class="line"><span class="cl"><span class="nv">become_user</span> <span class="o">=</span> root
</span></span><span class="line"><span class="cl"><span class="nv">become_ask_pass</span> <span class="o">=</span> <span class="nb">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># check_crnatab.yaml</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">- name: Check crontab process on all EC2 instances
</span></span><span class="line"><span class="cl">  hosts: all
</span></span><span class="line"><span class="cl">  become: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">  tasks:
</span></span><span class="line"><span class="cl">    - name: Check <span class="k">for</span> crontab process
</span></span><span class="line"><span class="cl">      shell: crontab -l 
</span></span><span class="line"><span class="cl">      register: crontab_process
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    - name: Print result
</span></span><span class="line"><span class="cl">      debug:
</span></span><span class="line"><span class="cl">        msg: <span class="s2">&#34;{{ crontab_process.stdout_lines }}&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>다음과 같이 구성 후 플레이북을 통해 실행합니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ansible-playbook -i inventory_aws_ec2.yml check_crnatab.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/ansible1/blog.png" 
    alt="blog.png" 
     
    width=2498 
    height="636"  /></p>
<ul>
<li>에러로 나오지만 결과 값이 없어 생기는 에러입니다.</li>
</ul>
<p>노드 1로 들어가서 crontab을 설정한 후 다시 앤시블 플레이북을 실행하면 설정된 크론탭을 확인할 수 있습니다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 노드 1</span>
</span></span><span class="line"><span class="cl">crontab -e 
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="m">0</span> * * * * date &gt;&gt; /tmp/date.log
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/ansible1/blog1.png" 
    alt="blog1.png" 
     
    width=2454 
    height="544"  /></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/why-server-slow/" title="Previous post (older)">
            <span>Previous</span>
            왜 서버가 지연될까?
            </a>
        
        
        
    </nav>
    
</div>
 
<div class="container">
    
    <script src="https://giscus.app/client.js" 
        data-repo="WingLim/hugo-tania"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTYyNjQzMDc="
        
        data-category="Comments"
        data-category-id="DIC_kwDOEtnPc84B_WKP"
        
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async
        >
</script>

<script>
    function setGiscusTeheme(theme) {
        let giscus = document.querySelector('.giscus iframe');
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme
                        }
                    }
                },
                'https://giscus.app'
            )
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://giscus.app') return;
        setGiscusTeheme(document.documentElement.dataset.userColorScheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setGiscusTeheme(e.detail)
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>