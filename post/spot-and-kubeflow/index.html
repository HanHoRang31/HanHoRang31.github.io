<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기 | HanHoRang Tech Blog</title>

    
    
    
    <meta property="og:site_name" content="HanHoRang Tech Blog by Tania in Hugo" />
    <meta property="og:title" content="[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기 | HanHoRang Tech Blog"/>
    <meta itemprop="name" content="[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기 | HanHoRang Tech Blog" />
    <meta name="twitter:title" content="[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기 | HanHoRang Tech Blog" />
    <meta name="application-name" content="[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기 | HanHoRang Tech Blog" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="eksctl를 통한 Kubeflow 인프라 구성과 배포하기" />
    <meta name="twitter:description" content="eksctl를 통한 Kubeflow 인프라 구성과 배포하기 "/>
    <meta itemprop="description" content=" eksctl를 통한 Kubeflow 인프라 구성과 배포하기 "/>
    <meta property="og:description" content=" eksctl를 통한 Kubeflow 인프라 구성과 배포하기 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Hugo Tania" />
<meta property="og:article:published_time" content=2023-05-06T00:00:00Z />
<meta property="article:published_time" content=2023-05-06T00:00:00Z />


  <meta property="og:article:author" content="Han ho rnag" />
  <meta property="article:author" content="Han ho rnag" />
  <meta name="author" content="Han ho rnag" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기",
    "author": {
      "@type": "Person",
      "name": "Hugo Tania"
    },
    "datePublished": "2023-05-06",
    "description": "eksctl를 통한 Kubeflow 인프라 구성과 배포하기",
    "wordCount":  4119 ,
    "mainEntityOfPage": "True",
    "dateModified": "2023-05-06",
    "publisher": {
      "@type": "Organization",
      "name": "Hugo Tania",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/HanHoRang31.github.io\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                    HanHoRang Tech Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>[AEWS] EKS Spot 인스턴스와 Kubeflow 배포하기</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By HanHoRnag | <time>May 06, 2023</time>
                            | 20 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/kans/">KANS</a>
                            
                            <a href="/tags/kubeflow/">kubeflow</a>
                            
                            <a href="/tags/cloud/">cloud</a>
                            
                            <a href="/tags/aws/">AWS</a>
                            
                            <a href="/tags/eksctl/">eksctl</a>
                            
                            <a href="/tags/eks/">eks</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">AWS EKS Workshop Study (=AEWS)는 EKS Workshop 실습 스터디입니다.
</span></span><span class="line"><span class="cl">CloudNet@ Gasida(가시다)이 진행하며,공개된 AWS EKS Workshop을 기반으로 진행하고 있습니다.
</span></span></code></pre></td></tr></table>
</div>
</div><p>EKS 구축 및 관리 툴인 eksctl은 다양한 구성 옵션을 제공한다. 공식 문서에 정리가 잘 되어 있으며 이번 블로그 글에서 필자 기준의 흥미로운 옵션을 몇 가지 선택하여 테스트한 내용을 공유하고자 한다.</p>
<ul>
<li>EKS addon 확장을 위한 AWS IAM 정책 생성</li>
<li>EKS 노드로 Spot 인스턴스 사용하기</li>
<li>Spot 인스턴스를 기반으로한 kubeflow 인프라 구성하기</li>
</ul>
<h2 id="eks-addon-확장을-위한-aws-iam-정책-생성">
    <a href="#eks-addon-%ed%99%95%ec%9e%a5%ec%9d%84-%ec%9c%84%ed%95%9c-aws-iam-%ec%a0%95%ec%b1%85-%ec%83%9d%ec%84%b1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS addon 확장을 위한 AWS IAM 정책 생성
</h2>
<p>EKS addon는 Amazon EKS에서 제공하는 쿠버네티스 클러스터 구성 요소로, 클러스터의 관리, 네트워킹, 로드 밸런싱 등을 담당하는 확장 기능이다. 이러한 addon 을 사용하면 확장 기능의 버전 관리와 업데이트가 쉬워진다. 기본적으로 EKS 설치시 네트워크단의 addon이 설치된다. 설치되는 addon은 다음과 같다.</p>
<table>
<thead>
<tr>
<th>애드온 이름</th>
<th>설명</th>
</tr>
</thead>
<tbody>
<tr>
<td>CoreDNS</td>
<td>클러스터 내의 DNS 쿼리를 처리하는데 사용된다.</td>
</tr>
<tr>
<td>Kube-proxy</td>
<td>쿠버네티스 서비스와 관련된 네트워크 요청을 처리한다.</td>
</tr>
<tr>
<td>VPC CNI</td>
<td>쿠버네티스 클러스터 내의 파드 간 네트워킹을 관리하는 Amazon VPC CNI 플러그인이다.</td>
</tr>
</tbody>
</table>
<p>로드밸런싱, 네트워크 등의 추가 addon은 eks 설치 이후 설치가 가능하다. 중요한 점은 addon 설치을 위해서는 필요 IAM 정책이 필요하다. EKS addon 의 확장 기능은 AWS 서비스를 사용하며 이를 위해 AWS 서비스 사용을 위한 IAM 정책이 필요하기 때문이다.  eksctl는 addon 설치를 제공하지 않지만, IAM 정책 생성은 제공한다. eksctl를 통해서 노드에 IAM 정책이 부여되는데 부여할 수 있는 리스트는 다음과 같다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instanceType</span><span class="p">:</span><span class="w"> </span><span class="l">m5.xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">desiredCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">iam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># addon 정책 부여 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">withAddonPolicies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">imageBuilder: true  # 이미지 빌더</span><span class="p">:</span><span class="w"> </span><span class="l">사용자 정의 컨테이너 이미지를 빌드하고 관리하는 도구</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">autoScaler: true  # 오토 스케일러</span><span class="p">:</span><span class="w"> </span><span class="l">클러스터 내에서 자동으로 노드 및 파드 크기를 조정</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">externalDNS: true  # 외부 DNS</span><span class="p">:</span><span class="w"> </span><span class="l">쿠버네티스 서비스와 인그레스 리소스에 대한 외부 DNS 레코드를 관리</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">certManager: true  # 인증서 관리자</span><span class="p">:</span><span class="w"> </span><span class="l">쿠버네티스 클러스터 내에서 TLS 인증서를 자동으로 발급 및 관리</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">appMesh: true  # 앱 메시</span><span class="p">:</span><span class="w"> </span><span class="l">마이크로서비스 간 통신을 관리하고 모니터링하는 서비스 메시</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">appMeshPreview: true  # 앱 메시 프리뷰</span><span class="p">:</span><span class="w"> </span><span class="l">앱 메시의 베타 기능을 미리 사용할 수 있게 해주는 프리뷰 버전</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ebs: true  # Amazon EBS CSI 드라이버</span><span class="p">:</span><span class="w"> </span><span class="l">쿠버네티스 클러스터에서 Amazon EBS 볼륨을 사용할 수 있게 함</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">fsx: true  # Amazon FSx CSI 드라이버</span><span class="p">:</span><span class="w"> </span><span class="l">쿠버네티스 클러스터에서 Amazon FSx 파일 시스템을 사용할 수 있게 함</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">efs: true  # Amazon EFS CSI 드라이버</span><span class="p">:</span><span class="w"> </span><span class="l">쿠버네티스 클러스터에서 Amazon EFS 파일 시스템을 사용할 수 있게 함</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">awsLoadBalancerController: true  # AWS 로드 밸런서 컨트롤러</span><span class="p">:</span><span class="w"> </span><span class="l">AWS 로드 밸런서를 쿠버네티스 서비스와 통합</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">xRay: true  # AWS X-Ray</span><span class="p">:</span><span class="w"> </span><span class="l">분산 애플리케이션의 성능 문제를 분석하고 디버깅하는 서비스</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">cloudWatch: true  # Amazon CloudWatch</span><span class="p">:</span><span class="w"> </span><span class="l">AWS 리소스 및 애플리케이션의 모니터링 및 관측을 제공</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>eksctl 를 통해 설치된 정책은 AWS 콘솔에서 확인이 가능하다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/iam1.png" 
    alt="iam1.png" 
     
    width=1332 
    height="203"  /></p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/iam2.png" 
    alt="iam2.png" 
     
    width=1497 
    height="641"  /></p>
<h2 id="eks-노드로--spot-인스턴스-사용하기">
    <a href="#eks-%eb%85%b8%eb%93%9c%eb%a1%9c--spot-%ec%9d%b8%ec%8a%a4%ed%84%b4%ec%8a%a4-%ec%82%ac%ec%9a%a9%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS 노드로  Spot 인스턴스 사용하기
</h2>
<p>Spot 인스턴스는 AWS의 미사용 컴퓨팅 용량을 할인된 가격으로 제공하는 Amazon EC2 인스턴스 유형이다. Spot 인스턴스는 온디맨드 인스턴스보다 비용이 최대 90% 까지 저렴하게 사용할 수 있지만, 가용성이 떨어질 경우 AWS에 의해 중단될 수 있다. 이러한 이유로 가변 워크로드 처리나 시간에 민감하지 않는 워크로드(데이터 분석, 배치) 작업에 사용된다.</p>
<p>복잡할 것 같지만, Spot 인스턴스의 비용 절감이 가지고 오는 장점이 어마무시하다. 비용 절감의 원리는 다음과 같다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/spot-1.png" 
    alt="&lt;a href=&#34;https://www.youtube.com/watch?v=ugDrxMqSj-E&amp;amp;t=426s&#34;&gt;https://www.youtube.com/watch?v=ugDrxMqSj-E&amp;amp;t=426s&lt;/a&gt;" 
     
    width=1277 
    height="704"  /></p>
<p><a href="https://www.youtube.com/watch?v=ugDrxMqSj-E&amp;t=426s">https://www.youtube.com/watch?v=ugDrxMqSj-E&amp;t=426s</a></p>
<p>그림과 같이 사용자가 원하는 인스턴스의 가격을 정해두면 AWS 에서 사용하지 않는 인스턴스를 한정하여 인스턴스를 제공하는 식이다. 사용자 제시 가격에 따라 최대 90퍼까지 절감이 가능하나, 사용하지 않는 인스턴스가 가변적으로 변하기에 보통 95%로 중단된다고 한다.</p>
<p>AWS 에서 spot 인스턴스를 사용할 수 있는 서비스들이 다양하다. 이번 글에서는 EKS에서 SPOT 인스턴스를 사용하는 경우를 다루겠다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/spot2.png" 
    alt="spot2.png" 
     
    width=2378 
    height="388"  /></p>
<p>eksctl 에서 워크 노드에 대해 spot 인스턴스 설정이 가능하다. 다만, 워크 노드 옵션이 관리형 노드 그룹, 비관리형 노드 그룹에 따라 구성 옵션이 다른데 구성 파일을 확인하면 다음과 같다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># spot-ng.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">eksctl.io/v1alpha5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-eks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">ap-northeast-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w"> </span><span class="c"># 비관리형 노드 그룹 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">spot-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;t3.small&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;t3.medium&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># At least one instance type should be specified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spotInstancePools</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">managedNodeGroups</span><span class="p">:</span><span class="w"> </span><span class="c"># 관리형 노드 그룹 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">spot-m1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;c3.large&#34;</span><span class="p">,</span><span class="s2">&#34;c4.large&#34;</span><span class="p">,</span><span class="s2">&#34;c5.large&#34;</span><span class="p">,</span><span class="s2">&#34;c5d.large&#34;</span><span class="p">,</span><span class="s2">&#34;c5n.large&#34;</span><span class="p">,</span><span class="s2">&#34;c5a.large&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 인스턴스를 설정하지 않으면 m5.large로 설정된다. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">spot-m2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">desiredCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>관리형 노드 그룹은 <code>spot: ture</code>  을 통해 비관리형 노드 그룹은 <code>instancesDistribution</code> 을 통해 가능하다. 옵션 설정 부분이 많이 차이나는데 관리형 노드 그룹은 AWS가 알아서 설정해주는 반면 비관리형 노드 그룹은 사용자가 자세하게 비용 및 정책을 설정해야 하기 때문이다.</li>
</ul>
<p>비관리형 노드 그룹을 통해 구성하는 경우가 많으며 spot인스턴스 사용 예에 대해 이해가 필요하다. 아래는 <a href="https://eksctl.io/usage/spot-instances/#unmanaged-nodegroups">공식 문서</a>에서 제공하는 예를 이해하기 위해 작성하였다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 50% 스팟 인스턴스와 50% 온디맨드 인스턴스를 사용하는 노드 그룹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;t3.small&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;t3.medium&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># At least one instance type should be specified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c"># 항상 사용 가능한 최소 온디맨드 인스턴스 수 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="c"># 초과하는 인스턴스에 대해 온디맨드 인스턴스를 사용할 비율을 설정(백분율) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotInstancePools</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 인스턴스 유형과 가용 영역 풀 설정 제한 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># GPU 인스턴스도 Spot 인스턴스로 사용가능하다. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-gpu</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instanceType</span><span class="p">:</span><span class="w"> </span><span class="l">mixed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">desiredCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">p2.xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">p2.8xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">p2.16xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># capacity-optimized 용량 최적화 전략으로 할당</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-capacity-optimized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;t3.small&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;t3.medium&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># At least one instance type should be specified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotAllocationStrategy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;capacity-optimized&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># capacity-optimized 용량 최적화 전략으로 할당(우선순위로 인스턴스 타입에서 첫 번째 인스턴스가 우선순위로 선택된다.) </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-capacity-optimized-prioritized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.017</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;t3a.small&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;t3.small&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># At least two instance types should be specified</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotAllocationStrategy</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;capacity-optimized-prioritized&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>노드 그룹을 배포하면 AWS 콘솔에서 다음과 같이 확인이 가능하다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">eksctl create ng --cluster my-eks -f spot-ng.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/./spot-and-kubeflow/spot3.png" 
    alt="spot3.png" 
     
    width=1845 
    height="600"  /></p>
<p>배포한지 30분이 지났지만 하나의 인스턴스가 실행되었다가 중단되었고 또 다른 인스턴스가 실행되는 것을 확인할 수 있다.</p>
<p>[절감액 요약] 에서 필자가 설정한 인스턴스로 얼마가 절감되었는지 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/spot4.png" 
    alt="spot4.png" 
     
    width=819 
    height="542"  /></p>
<p>오오 72퍼센트나..! 유용하게 사용하자!</p>
<h2 id="spot-인스턴스를-기반으로한-kubeflow-인프라-구성하기">
    <a href="#spot-%ec%9d%b8%ec%8a%a4%ed%84%b4%ec%8a%a4%eb%a5%bc-%ea%b8%b0%eb%b0%98%ec%9c%bc%eb%a1%9c%ed%95%9c-kubeflow-%ec%9d%b8%ed%94%84%eb%9d%bc-%ea%b5%ac%ec%84%b1%ed%95%98%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Spot 인스턴스를 기반으로한 kubeflow 인프라 구성하기
</h2>
<p>Spot 인스턴스가 가져오는 비용 절감을 통해 쿠버네티스 <strong>머신러닝 플랫폼</strong>인 kubeflow 인프라를 구성하겠다. 굳이 머신러닝 플랫폼을 정한 이유는 GPU 인스턴스 사용 비용을 최대한으로 절감하고 자원 사용을 최적화시켜줄 수 있어서 선택하였다. <a href="https://github.com/weaveworks/eksctl/blob/main/examples/23-kubeflow-spot-instance.yaml">eksctl 공식 예</a>에서도 kubeflow에 대한 인프라 구성을 예로 제공하고 있다. 해당 예를 가지고 리전 및 인스턴스를 변경하여 kubeflow 인프라를 구성해보겠다. 아키텍처는 다음과 같다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/kubeflow-drawio.png" 
    alt="kubeflow.drawio.png" 
     
    width=701 
    height="892"  /></p>
<ul>
<li>GPU 인스턴스(px로 시작)만 Spot 인스턴스로 할당하였다. 최소 0개부터 시작하여 필요할 때만 사용할 수 있도록 하여 비용을 절감할 수 있도록 설정하였다. GPU 인스턴스의 비용을 확인하면 상당히 비싼것을 확인할 수 있는데 서울 리전 기준 p2.xlarge1.465 USD, p3.2xlarge4.234 USD 이다. 약 절반 기준의 비용을 산정해서 Spot 인스턴스의 비용을 설정하였다.</li>
<li>가용 영역을 ap-northeast-2a 에만 설정한 이유는 네트워크 지연 최소화 때문이다. 머신러닝에서 네트워크 지연을 최소화하기위함이며 머신러닝 워크로드 특성상 고가용성을 고려하지 않았다.</li>
</ul>
<p>아키텍처로 베스천 서버와 EKS 클러스터를 구축할 것이다. 베스천 서버는 cloudformation 을 통한 EC2 서버로 생성하고, EKS 클러스터는 eksctl 구축하겠다.  베스천 서버의 cloudformation 코드는 필자의 <a href="https://github.com/HanHoRang31/blog-share/blob/main/aews-eksctl/kubeflow/my-eks-kubeflow-bastion.yaml">깃허브 repo</a> 를 참고하여 배포하자. 중요한 점은 ami를 ubuntu 지정하였는데 kubeflow 설치를 위해서는 설치 환경이 ubuntu이여만 한다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/need-ubuntu.png" 
    alt="&lt;a href=&#34;https://awslabs.github.io/kubeflow-manifests/docs/deployment/prerequisites/&#34;&gt;https://awslabs.github.io/kubeflow-manifests/docs/deployment/prerequisites/&lt;/a&gt;" 
     
    width=1004 
    height="414"  /></p>
<p><a href="https://awslabs.github.io/kubeflow-manifests/docs/deployment/prerequisites/">https://awslabs.github.io/kubeflow-manifests/docs/deployment/prerequisites/</a></p>
<p>이를 위해 베스천 서버를 ubuntu로 구성하였다.</p>
<p>다음은 eksctl 를 통해 EKS 클러스터를 구축하겠다. 구성 yaml 파일은 다음과 같다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># Cost-Optimized EKS cluster for Kubeflow with spot GPU instances and node scale down to zero</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Built in efforts to reducing training costs of ML workloads.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Supporting tutorial can be found at the following link: </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># https://blog.gofynd.com/how-we-reduced-our-ml-training-costs-by-78-a33805cb00cf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This spec creates a cluster on EKS with the following active nodes </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - 2x m5a.2xlarge - Accomodates all pods of Kubeflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># It also creates the following nodegroups with 0 nodes running unless a pod comes along and requests for the node to get spun up</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - m5a.2xlarge   -- Max Allowed 10 worker nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - p2.xlarge     -- Max Allowed 10 worker nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - p3.2xlarge    -- Max Allowed 10 worker nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - p3.8xlarge    -- Max Allowed 04 worker nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># - p3dn.24xlarge -- Max Allowed 01 worker nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">eksctl.io/v1alpha5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># Name of your cluster, change to whatever you find fit.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># If changed, make sure to change all nodegroup tags from </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># &#39;k8s.io/cluster-autoscaler/my-eks-kubeflow: &#34;owned&#34;&#39; --&gt; &#39;k8s.io/cluster-autoscaler/your-new-name: &#34;owned&#34;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-eks-kubeflow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># choose your region wisely, this will significantly impact the cost incurred</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l">ap-northeast-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># 1.14 Kubernetes version since Kubeflow 1.0 officially supports the same</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1.25&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Add more cloud tags if needed for billing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="l">staging</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Add all possible AZs to ensure nodes can be spun up in any AZ later on. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># THIS CAN&#39;T BE CHANGED LATER. YOU WILL HAVE TO CREATE A NEW CLUSTER TO ADD NEW AZ SUPPORT.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># This list applies to the whole cluster and isn&#39;t specific to nodegroups</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">availabilityZones</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;ap-northeast-2b&#34;</span><span class="p">,</span><span class="w">  </span><span class="s2">&#34;ap-northeast-2d&#34;</span><span class="p">,</span><span class="w">  </span><span class="s2">&#34;ap-northeast-2f&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">iam</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">withOIDC</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ng-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">desiredCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Set one nodegroup with 100GB volumes for Kubeflow to get deployed. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Kubeflow requirement states 1-2 Nodes with 100GB volume attached to the node. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeSize</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeType</span><span class="p">:</span><span class="w"> </span><span class="l">gp2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instanceType</span><span class="p">:</span><span class="w"> </span><span class="l">m6g.xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">availabilityZones</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">node-class</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;worker-node&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># EC2 tags required for cluster-autoscaler auto-discovery</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">OnDemand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;false&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/my-eks-kubeflow</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;owned&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">iam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">withAddonPolicies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">albIngress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">autoScaler</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cloudWatch</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">efs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ebs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">externalDNS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">1</span>-<span class="l">gpu-spot-p2-xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># set your own max price. AWS spot instance prices no longer cross OnDemand price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment out the field to default to OnDemand as max price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">0.7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;p2.xlarge&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotAllocationStrategy</span><span class="p">:</span><span class="w"> </span><span class="l">capacity-optimized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Stick to one AZ for all GPU nodes. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># In case of termination, this will prevent volumes from being unavailable </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># if the new instance got spun up in another AZ.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">availabilityZones</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">taints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">spotInstance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">PreferNoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/taint/spotInstance</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true:PreferNoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/my-eks-kubeflow</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;owned&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">iam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">withAddonPolicies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">autoScaler</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cloudWatch</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">albIngress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">efs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ebs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">externalDNS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">1</span>-<span class="l">gpu-spot-p3-2xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># set your own max price. AWS spot instance prices no longer cross OnDemand price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment out the field to default to OnDemand as max price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">2.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;p3.2xlarge&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotAllocationStrategy</span><span class="p">:</span><span class="w"> </span><span class="l">capacity-optimized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Stick to one AZ for all GPU nodes. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># In case of termination, this will prevent volumes from being unavailable </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># if the new instance got spun up in another AZ.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">availabilityZones</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">taints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">spotInstance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">PreferNoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/taint/spotInstance</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true:PreferNoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/my-eks-kubeflow</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;owned&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">iam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">withAddonPolicies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">autoScaler</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cloudWatch</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">albIngress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">efs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ebs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">externalDNS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">4</span>-<span class="l">gpu-spot-p3-8xlarge</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">minSize</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">maxSize</span><span class="p">:</span><span class="w"> </span><span class="m">4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">instancesDistribution</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># set your own max price. AWS spot instance prices no longer cross OnDemand price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c"># Comment out the field to default to OnDemand as max price. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxPrice</span><span class="p">:</span><span class="w"> </span><span class="m">4.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">instanceTypes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;p3.8xlarge&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">onDemandPercentageAboveBaseCapacity</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spotAllocationStrategy</span><span class="p">:</span><span class="w"> </span><span class="l">capacity-optimized</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Stick to one AZ for all GPU nodes. </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># In case of termination, this will prevent volumes from being unavailable </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># if the new instance got spun up in another AZ.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">availabilityZones</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;ap-northeast-2a&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">taints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">spotInstance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">PreferNoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/lifecycle</span><span class="p">:</span><span class="w"> </span><span class="l">Ec2Spot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/aws.amazon.com/spot</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/label/gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/node-template/taint/spotInstance</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true:PreferNoSchedule&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/enabled</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">k8s.io/cluster-autoscaler/my-eks-kubeflow</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;owned&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">iam</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">withAddonPolicies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">autoScaler</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">cloudWatch</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">albIngress</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">efs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ebs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">externalDNS</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>withAddonPolicies 정책에서 efs: true 가 추가된 것을 확인할 수 있는데 머신러닝의 데이터 셋을 공유 스토리지로 활용하여 모델 훈련 및 추론에 대한 더 나은 성능을 얻을 수 있기 때문에 추가하였다.</li>
</ul>
<p>eksctl를 통해 EKS 클러스터를 구축하자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">eksctl create cluster -f kubeflow-infra.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>약 20분 정도 소요된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@hanhorang:/home/ubuntu/blog-share/aews-eksctl/example# kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-node-6xqcv                         1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   aws-node-dtm6v                         1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   aws-node-kn5fj                         1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   aws-node-s7grj                         1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-f7576               1/1     Running   <span class="m">0</span>          27s
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-jzvlg               1/1     Running   <span class="m">0</span>          27s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-r9csf                       1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-thglh                       1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-txzr4                       1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-zltl2                       1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-4p24p   1/1     Running   <span class="m">0</span>          73s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-67275   1/1     Running   <span class="m">0</span>          59s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-kmh95   1/1     Running   <span class="m">0</span>          61s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-kzhtv   1/1     Running   <span class="m">0</span>          72s
</span></span></code></pre></td></tr></table>
</div>
</div><p>해당 파드가 GPU 노드에만 배치될 수 있도록 데몬셋을 수정할 것이다. 다음의 명령어를 통해 수정하자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit daemonset/nvidia-device-plugin-daemonset -n kube-system 
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nvidia-device-plugin-ds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">scheduler.alpha.kubernetes.io/critical-pod</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nvidia-device-plugin-ds</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">    </span><span class="c"># 추가 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">gpu-count</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">  </span><span class="c">#추가</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>수정 후 정상적으로 파드 에러가 사라진 것을 확인할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>terraform-eks@my-eks-kubeflow:N/A<span class="o">)</span> <span class="o">[</span>root@myeks-host example<span class="o">]</span><span class="c1"># kubectl edit daemonset/nvidia-device-plugin-daemonset -n kube-system</span>
</span></span><span class="line"><span class="cl">daemonset.apps/nvidia-device-plugin-daemonset edited
</span></span><span class="line"><span class="cl"><span class="o">(</span>terraform-eks@my-eks-kubeflow:N/A<span class="o">)</span> <span class="o">[</span>root@hanhorang example<span class="o">]</span><span class="c1"># kubectl get pods -A </span>
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-node-9x5kp             1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   aws-node-bf4lw             1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   aws-node-v7gs6             1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   aws-node-wv9qj             1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   aws-node-xjwss             1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-nlfv2   1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-zx92r   1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-24wxv           1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-4dh4j           1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-qp9xk           1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-xcfqz           1/1     Running   <span class="m">0</span>          10m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-zvn2j           1/1     Running   <span class="m">0</span>          10m
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="kubeflow-배포">
    <a href="#kubeflow-%eb%b0%b0%ed%8f%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    kubeflow 배포
</h2>
<p>앞 과정에서 구성한 EKS 클러스터에 kubeflow를 배포하겠다. 배포하기 전 kubeflow가 무엇이고 아키텍처가 무엇인지 간단하게 확인하고 넘어가겠다.</p>
<p>공식문서에 따르면 kubeflow는 오픈소스 기반의 ML 플랫폼이다. 플랫폼이라는 말이 중요한 데, 다른 머신러닝 서비스를 만드는 것이 아니라, 오픈소스 기반의 머신러닝 서비스을 합쳐 머신러닝 워크플로를 간소화 시켜주는 플랫폼 서비스로 제공한다는 의미이다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/Kubeflow.png" 
    alt="&lt;a href=&#34;https://www.kubeflow.org/&#34;&gt;https://www.kubeflow.org/&lt;/a&gt;" 
     
    width=862 
    height="274"  /></p>
<p><a href="https://www.kubeflow.org/">https://www.kubeflow.org/</a></p>
<p>어떤 머신러닝 오픈소스를 사용하는 지는 아키텍처를 보면 확인할 수 있다. 클라우드 프로바이더나 로컬인 쿠버네티스 위에서 다양한 머신러닝 서비스 및 addon 서비스를 결합하여 워크플로를 구성한다고 이해하자.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/kubeflow-archi.png" 
    alt="&lt;a href=&#34;https://www.kubeflow.org/docs/started/architecture/&#34;&gt;https://www.kubeflow.org/docs/started/architecture/&lt;/a&gt;" 
     
    width=956 
    height="576"  /></p>
<p><a href="https://www.kubeflow.org/docs/started/architecture/">https://www.kubeflow.org/docs/started/architecture/</a></p>
<p>머신러닝 컴포넌트가 많아 세부적으로는 확인할 수가 없고 큰 구성 별로 확인하겠다.</p>
<ul>
<li><strong>ML tools</strong>: 머신러닝 도구들은 데이터 전처리, 모델 학습, 평가, 최적화 및 배포와 같은 머신러닝 워크플로를 지원하는 소프트웨어 라이브러리 및 프레임워크이다.</li>
<li><strong>Kubeflow applications and scaffolding</strong>: Kubeflow 애플리케이션 및 스캐폴딩은 Kubeflow 플랫폼에서 제공하는 기본 뼈대와 도구들로, 사용자가 머신러닝 워크플로를 쉽게 구축하고 관리할 수 있도록 지원한다. 머신러닝 오픈소스 뿐만 아니라 istio, prometheus, argo 등의 오픈소스가 있는 것을 확인할 수 있는데 해당 서비스를 결합하여 대시보드, 서비스 메시, 파이프라인 구성에 사용된다.</li>
</ul>
<p>kubeflow 배포 전 작업으로 버전 확인 및 필요 addon 설치가 필요하다. 23년 5월 기준 EKS 버전 제공별 kubeflow 버전 지원은 다음의 그림을 통해 참고하자. 필자의 EKS 버전은 1.25로 kubeflow 1.7를 설치하겠다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/kubeflow-version.png" 
    alt="kubeflow-version.png" 
     
    width=656 
    height="360"  /></p>
<p>다음 과정으로 필요 패키지 및 addon 설치를 진행하자. 패키지의 경우 <a href="https://awslabs.github.io/kubeflow-manifests/docs/deployment/prerequisites/">공식 문서의 명령어</a>를 통해 쉽게 설치가 가능하다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">KUBEFLOW_RELEASE_VERSION</span><span class="o">=</span>v1.7.0
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">AWS_RELEASE_VERSION</span><span class="o">=</span>v1.7.0-aws-b1.0.0
</span></span><span class="line"><span class="cl">git clone https://github.com/awslabs/kubeflow-manifests.git <span class="o">&amp;&amp;</span> <span class="nb">cd</span> kubeflow-manifests
</span></span><span class="line"><span class="cl">git checkout <span class="si">${</span><span class="nv">AWS_RELEASE_VERSION</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">git clone --branch <span class="si">${</span><span class="nv">KUBEFLOW_RELEASE_VERSION</span><span class="si">}</span> https://github.com/kubeflow/manifests.git upstream
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 패키지 설치 명령어 </span>
</span></span><span class="line"><span class="cl">make install-tools
</span></span></code></pre></td></tr></table>
</div>
</div><p>설치 중 파이썬 필요 패키지 설치 중 에러가 발생한다. 다음의 명령어를 통해 해결하자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pip install --ignore-installed <span class="nv">PyYAML</span><span class="o">==</span>5.3.1
</span></span><span class="line"><span class="cl">pip3 install testresources
</span></span><span class="line"><span class="cl">python3.8 -m pip install -r tests/e2e/requirements.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>패키지 설치 후, EKS addon인 EBS csi driver 설치가 필요하다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/csi-driver.png" 
    alt="csi-driver.png" 
     
    width=1193 
    height="156"  /></p>
<p>EBS csi driver은 <a href="https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html">AWS 공식 문서</a>를 참고하여 설치를 진행하였다. EBS 볼륨 관리를 위한 IAM 정책 및 롤 생성과 드라이버 배포 과정으로 진행하였다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># OIDC 확인</span>
</span></span><span class="line"><span class="cl">aws eks describe-cluster   --name my-eks-kubeflow   --query <span class="s2">&#34;cluster.identity.oidc.issuer&#34;</span>   --output text
</span></span></code></pre></td></tr></table>
</div>
</div><p>결과에서 region과 oidc 번호를 메모하자. 아래 IAM 정책 구성에 기입이 필요하다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">#</span> <span class="err">vi</span> <span class="err">aws-ebs-csi-driver-trust-policy.json</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Principal&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;Federated&#34;</span><span class="p">:</span> <span class="s2">&#34;arn:aws:iam::955963799952:oidc-provider/oidc.eks.ap-northeast-2.amazonaws.com/id/D378D41514C8714C26A69DF6ECC0A999&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="s2">&#34;sts:AssumeRoleWithWebIdentity&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;Condition&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;StringEquals&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;oidc.eks.ap-northeast-2.amazonaws.com/id/D378D41514C8714C26A69DF6ECC0A999:aud&#34;</span><span class="p">:</span> <span class="s2">&#34;sts.amazonaws.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;oidc.eks.ap-northeast-2.amazonaws.com/id/D378D41514C8714C26A69DF6ECC0A999:sub&#34;</span><span class="p">:</span> <span class="s2">&#34;system:serviceaccount:kube-system:ebs-csi-controller-sa&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 롤 생성</span>
</span></span><span class="line"><span class="cl">aws iam create-role <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --role-name AmazonEKS_EBS_CSI_DriverRole <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --assume-role-policy-document file://<span class="s2">&#34;aws-ebs-csi-driver-trust-policy.json&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 정책 attach</span>
</span></span><span class="line"><span class="cl">aws iam attach-role-policy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --role-name AmazonEKS_EBS_CSI_DriverRole
</span></span></code></pre></td></tr></table>
</div>
</div><p>정책 attach까지 완료하였으면 해당 정책을 쿠버네티스 내에서 사용하기 위해 사용자 어카운트에 연동이 필요하다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># sa 생성 </span>
</span></span><span class="line"><span class="cl">kubectl create sa ebs-csi-controller-sa     -n kube-system
</span></span><span class="line"><span class="cl"><span class="c1"># Role annotation</span>
</span></span><span class="line"><span class="cl">kubectl annotate serviceaccount ebs-csi-controller-sa <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    -n kube-system <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    eks.amazonaws.com/role-arn<span class="o">=</span>arn:aws:iam::955963799952:role/AmazonEKS_EBS_CSI_DriverRole
</span></span></code></pre></td></tr></table>
</div>
</div><p>연동이 끝났으면 EBS 드라이버를 배포하자, 필자의 경우 eksctl를 통해 진행하였다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws eks create-addon --cluster-name my-eks-kubeflow --addon-name aws-ebs-csi-driver <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --service-account-role-arn arn:aws:iam::955963799952:role/AmazonEKS_EBS_CSI_DriverRole
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@hanhorang:/home/ubuntu/blog-share/aews-eksctl/example# kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-node-6xqcv                         1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   aws-node-dtm6v                         1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   aws-node-kn5fj                         1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   aws-node-s7grj                         1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-f7576               1/1     Running   <span class="m">0</span>          6m39s
</span></span><span class="line"><span class="cl">kube-system   coredns-595d647554-jzvlg               1/1     Running   <span class="m">0</span>          6m39s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-controller-b576f46c5-2c5sk     5/6     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-controller-b576f46c5-ffwnk     5/6     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-6tpm6                     3/3     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-djrc4                     3/3     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-qtngl                     3/3     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-thbfc                     3/3     Running   <span class="m">0</span>          16s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-r9csf                       1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-thglh                       1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-txzr4                       1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-zltl2                       1/1     Running   <span class="m">0</span>          7m46s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-4p24p   1/1     Running   <span class="m">0</span>          7m25s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-67275   1/1     Running   <span class="m">0</span>          7m11s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-kmh95   1/1     Running   <span class="m">0</span>          7m13s
</span></span><span class="line"><span class="cl">kube-system   nvidia-device-plugin-daemonset-kzhtv   1/1     Running   <span class="m">0</span>          7m24
</span></span></code></pre></td></tr></table>
</div>
</div><p>스토리지 addon 배포 이후 PVC의 Default 스토리지클래스 지정이 필요하다. 스토리지 클래스를 생성하고 기본 클래스 설정을 진행하자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ebs-sc.yaml  </span>
</span></span><span class="line"><span class="cl">apiVersion: storage.k8s.io/v1
</span></span><span class="line"><span class="cl">kind: StorageClass
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ebs-sc
</span></span><span class="line"><span class="cl">  annotations:
</span></span><span class="line"><span class="cl">    storageclass.kubernetes.io/is-default-class: <span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">provisioner: ebs.csi.aws.com
</span></span><span class="line"><span class="cl">volumeBindingMode: WaitForFirstConsumer
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 스토리지 클래스 배포</span>
</span></span><span class="line"><span class="cl">kubectl apply -f ebs-sc.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># 기본 클래스 수정</span>
</span></span><span class="line"><span class="cl">kubectl patch storageclass gp2 -p <span class="s1">&#39;{&#34;metadata&#34;: {&#34;annotations&#34;:{&#34;storageclass.kubernetes.io/is-default-class&#34;:&#34;false&#34;}}}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>마지막으로 kubeflow 배포를 진행하겠다. 배포는 앞서 깃으로 클론한 레파지토리에 매니패스트 명령어를 통해 진행하겠다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_NAME</span><span class="o">=</span>my-eks-kubeflow 
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">CLUSTER_REGION</span><span class="o">=</span>ap-northeast-2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 설치 명령어 </span>
</span></span><span class="line"><span class="cl">make deploy-kubeflow <span class="nv">INSTALLATION_OPTION</span><span class="o">=</span>kustomize <span class="nv">DEPLOYMENT_OPTION</span><span class="o">=</span>vanilla
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">All istio pods are running!
</span></span><span class="line"><span class="cl"><span class="o">==========</span>Installing <span class="nv">dex</span><span class="o">==========</span>
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;dex&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: dex
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue May  <span class="m">2</span> 22:47:51 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> dex pods to be ready ...
</span></span><span class="line"><span class="cl">running command: kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready pod -l <span class="s1">&#39;app in (dex)&#39;</span> --timeout<span class="o">=</span>240s -n auth
</span></span><span class="line"><span class="cl">pod/dex-56d9748f89-99ggv condition met
</span></span><span class="line"><span class="cl">All dex pods are running!
</span></span><span class="line"><span class="cl"><span class="o">==========</span>Installing oidc-authservice<span class="o">==========</span>
</span></span><span class="line"><span class="cl">Release <span class="s2">&#34;oidc-authservice&#34;</span> does not exist. Installing it now.
</span></span><span class="line"><span class="cl">NAME: oidc-authservice
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Tue May  <span class="m">2</span> 22:48:01 <span class="m">2023</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> oidc-authservice pods to be ready ...
</span></span><span class="line"><span class="cl">running command: kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready pod -l <span class="s1">&#39;app in (authservice)&#39;</span> --timeout<span class="o">=</span>240s -n istio-system
</span></span><span class="line"><span class="cl">error: timed out waiting <span class="k">for</span> the condition on pods/authservice-0
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> oidc-authservice pods to be ready ...
</span></span><span class="line"><span class="cl">running command: kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready pod -l <span class="s1">&#39;app in (authservice)&#39;</span> --timeout<span class="o">=</span>240s -n istio-system
</span></span><span class="line"><span class="cl">error: timed out waiting <span class="k">for</span> the condition on pods/authservice-0
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> oidc-authservice pods to be ready ...
</span></span><span class="line"><span class="cl">running command: kubectl <span class="nb">wait</span> --for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>ready pod -l <span class="s1">&#39;app in (authservice)&#39;</span> --timeout<span class="o">=</span>240s -n istio-system
</span></span></code></pre></td></tr></table>
</div>
</div><p>스크립트를 통해 구성 요소들이 설치된다. 약 5분정도 소요된다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@hanhorang:/home/ubuntu/blog-share/aews-eksctl/kubeflow-manifests# kubectl get pods -A 
</span></span><span class="line"><span class="cl">NAMESPACE                   NAME                                                     READY   STATUS    RESTARTS        AGE
</span></span><span class="line"><span class="cl">ack-system                  ack-sagemaker-controller-5667d978b-xhnmn                 0/1     Error     <span class="m">4</span> <span class="o">(</span>56s ago<span class="o">)</span>     105s
</span></span><span class="line"><span class="cl">auth                        dex-56d9748f89-nk54k                                     1/1     Running   <span class="m">0</span>               34m
</span></span><span class="line"><span class="cl">cert-manager                cert-manager-74d949c895-25bt6                            1/1     Running   <span class="m">0</span>               35m
</span></span><span class="line"><span class="cl">cert-manager                cert-manager-cainjector-d9bc5979d-m6kt8                  1/1     Running   <span class="m">0</span>               35m
</span></span><span class="line"><span class="cl">cert-manager                cert-manager-webhook-84b7ddd796-m6dmp                    1/1     Running   <span class="m">0</span>               35m
</span></span><span class="line"><span class="cl">istio-system                authservice-0                                            1/1     Running   <span class="m">0</span>               34m
</span></span><span class="line"><span class="cl">istio-system                cluster-local-gateway-6955b67f54-tlhp9                   1/1     Running   <span class="m">0</span>               8m16s
</span></span><span class="line"><span class="cl">istio-system                istio-ingressgateway-67f7b5f88d-n6whr                    1/1     Running   <span class="m">0</span>               34m
</span></span><span class="line"><span class="cl">istio-system                istiod-56f7cf9bd6-455ht                                  1/1     Running   <span class="m">0</span>               34m
</span></span><span class="line"><span class="cl">knative-eventing            eventing-controller-c6f5fd6cd-mzfzd                      1/1     Running   <span class="m">0</span>               7m45s
</span></span><span class="line"><span class="cl">knative-eventing            eventing-webhook-79cd6767-pt9dt                          1/1     Running   <span class="m">0</span>               7m45s
</span></span><span class="line"><span class="cl">knative-serving             activator-67849589d6-m7wlq                               2/2     Running   <span class="m">0</span>               8m6s
</span></span><span class="line"><span class="cl">knative-serving             autoscaler-6dbcdd95c7-b5tdc                              2/2     Running   <span class="m">0</span>               8m6s
</span></span><span class="line"><span class="cl">knative-serving             controller-b9b8855b8-ggzrg                               2/2     Running   <span class="m">0</span>               8m6s
</span></span><span class="line"><span class="cl">knative-serving             domain-mapping-75cc6d667f-vc5hz                          2/2     Running   <span class="m">0</span>               8m5s
</span></span><span class="line"><span class="cl">knative-serving             domainmapping-webhook-6dfb78c944-s4d5t                   2/2     Running   <span class="m">0</span>               8m5s
</span></span><span class="line"><span class="cl">knative-serving             net-istio-controller-5fcd96d76f-pqvnt                    2/2     Running   <span class="m">0</span>               8m5s
</span></span><span class="line"><span class="cl">knative-serving             net-istio-webhook-7ff9fdf999-48d9c                       2/2     Running   <span class="m">0</span>               8m5s
</span></span><span class="line"><span class="cl">knative-serving             webhook-69cc5b9849-tbn9r                                 2/2     Running   <span class="m">0</span>               8m5s
</span></span><span class="line"><span class="cl">kube-system                 aws-node-6xqcv                                           1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 aws-node-dtm6v                                           1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 aws-node-kn5fj                                           1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 aws-node-s7grj                                           1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 coredns-595d647554-f7576                                 1/1     Running   <span class="m">0</span>               125m
</span></span><span class="line"><span class="cl">kube-system                 coredns-595d647554-jzvlg                                 1/1     Running   <span class="m">0</span>               125m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-controller-b576f46c5-76czd                       6/6     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-controller-b576f46c5-svcbt                       6/6     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-node-57dnr                                       3/3     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-node-dcn5z                                       3/3     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-node-hbsfg                                       3/3     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 ebs-csi-node-qhhsm                                       3/3     Running   <span class="m">0</span>               15m
</span></span><span class="line"><span class="cl">kube-system                 kube-proxy-r9csf                                         1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 kube-proxy-thglh                                         1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 kube-proxy-txzr4                                         1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 kube-proxy-zltl2                                         1/1     Running   <span class="m">0</span>               127m
</span></span><span class="line"><span class="cl">kube-system                 nvidia-device-plugin-daemonset-4p24p                     1/1     Running   <span class="m">0</span>               126m
</span></span><span class="line"><span class="cl">kube-system                 nvidia-device-plugin-daemonset-67275                     1/1     Running   <span class="m">0</span>               126m
</span></span><span class="line"><span class="cl">kube-system                 nvidia-device-plugin-daemonset-kmh95                     1/1     Running   <span class="m">0</span>               126m
</span></span><span class="line"><span class="cl">kube-system                 nvidia-device-plugin-daemonset-kzhtv                     1/1     Running   <span class="m">0</span>               126m
</span></span><span class="line"><span class="cl">kubeflow-user-example-com   ml-pipeline-ui-artifact-6cb7b9f6fd-jggk2                 2/2     Running   <span class="m">0</span>               110s
</span></span><span class="line"><span class="cl">kubeflow-user-example-com   ml-pipeline-visualizationserver-7b5889796d-trjjd         2/2     Running   <span class="m">0</span>               110s
</span></span><span class="line"><span class="cl">kubeflow                    admission-webhook-deployment-6db8bdbb45-7zfzq            1/1     Running   <span class="m">0</span>               5m4s
</span></span><span class="line"><span class="cl">kubeflow                    cache-server-76cb8f97f9-wqstf                            2/2     Running   <span class="m">0</span>               6m25s
</span></span><span class="line"><span class="cl">kubeflow                    centraldashboard-655c7d894c-vmv5r                        2/2     Running   <span class="m">0</span>               6m40s
</span></span><span class="line"><span class="cl">kubeflow                    jupyter-web-app-deployment-76fbf48ff6-j7tkk              2/2     Running   <span class="m">0</span>               4m55s
</span></span><span class="line"><span class="cl">kubeflow                    katib-controller-8bb4fdf4f-46zsh                         1/1     Running   <span class="m">0</span>               3m6s
</span></span><span class="line"><span class="cl">kubeflow                    katib-db-manager-f8dc7f465-4z2ch                         1/1     Running   <span class="m">0</span>               3m6s
</span></span><span class="line"><span class="cl">kubeflow                    katib-mysql-db6dc68c-xj6qr                               1/1     Running   <span class="m">0</span>               3m6s
</span></span><span class="line"><span class="cl">kubeflow                    katib-ui-7859bc4c67-khc44                                2/2     Running   <span class="m">1</span> <span class="o">(</span>2m59s ago<span class="o">)</span>   3m6s
</span></span><span class="line"><span class="cl">kubeflow                    kserve-controller-manager-85b6b6c47d-qxxjp               2/2     Running   <span class="m">0</span>               7m5s
</span></span><span class="line"><span class="cl">kubeflow                    kserve-models-web-app-99849d9f7-d67hg                    2/2     Running   <span class="m">0</span>               6m51s
</span></span><span class="line"><span class="cl">kubeflow                    kubeflow-pipelines-profile-controller-59ccbd47b9-9k9s4   1/1     Running   <span class="m">0</span>               6m25s
</span></span><span class="line"><span class="cl">kubeflow                    metacontroller-0                                         1/1     Running   <span class="m">0</span>               6m23s
</span></span><span class="line"><span class="cl">kubeflow                    metadata-envoy-deployment-5b6c575b98-rphl6               1/1     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    metadata-grpc-deployment-784b8b5fb4-mmfql                2/2     Running   <span class="m">2</span> <span class="o">(</span>5m47s ago<span class="o">)</span>   6m24s
</span></span><span class="line"><span class="cl">kubeflow                    metadata-writer-5899c74595-55kls                         2/2     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    minio-65dff76b66-7g4q8                                   2/2     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-cff8bdfff-glgnb                              2/2     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-persistenceagent-798dbf666f-kwjhf            2/2     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-scheduledworkflow-859ff9cf7b-fkskm           2/2     Running   <span class="m">0</span>               6m24s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-ui-6d69549787-v2vl6                          2/2     Running   <span class="m">0</span>               6m23s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-viewer-crd-56f7cfd7d9-phhjn                  2/2     Running   <span class="m">1</span>               6m23s
</span></span><span class="line"><span class="cl">kubeflow                    ml-pipeline-visualizationserver-64447ffc76-zllv2         2/2     Running   <span class="m">0</span>               6m23s
</span></span><span class="line"><span class="cl">kubeflow                    mysql-c999c6c8-2vhjq                                     2/2     Running   <span class="m">0</span>               6m23s
</span></span><span class="line"><span class="cl">kubeflow                    notebook-controller-deployment-84c9bfdf76-r5dc9          2/2     Running   <span class="m">1</span> <span class="o">(</span>4m33s ago<span class="o">)</span>   4m41s
</span></span><span class="line"><span class="cl">kubeflow                    profiles-deployment-786df9d89d-mwlsj                     3/3     Running   <span class="m">1</span> <span class="o">(</span>2m4s ago<span class="o">)</span>    2m15s
</span></span><span class="line"><span class="cl">kubeflow                    tensorboard-controller-deployment-6664b8866f-r6jtv       3/3     Running   <span class="m">1</span> <span class="o">(</span>2m31s ago<span class="o">)</span>   2m39s
</span></span><span class="line"><span class="cl">kubeflow                    tensorboards-web-app-deployment-5cb4666798-55j68         2/2     Running   <span class="m">0</span>               2m53s
</span></span><span class="line"><span class="cl">kubeflow                    training-operator-7589458f95-zvrk9                       1/1     Running   <span class="m">0</span>               3m56s
</span></span><span class="line"><span class="cl">kubeflow                    volumes-web-app-deployment-59cf57d887-r9gt8              2/2     Running   <span class="m">0</span>               4m17s
</span></span><span class="line"><span class="cl">kubeflow                    workflow-controller-6547f784cd-mzzmw                     2/2     Running   <span class="m">1</span> <span class="o">(</span>6m16s ago<span class="o">)</span>   6m23s
</span></span></code></pre></td></tr></table>
</div>
</div><p>🧐 <strong>배포 중 트러블슈팅</strong></p>
<p>필자의 경우 구성 요소 중 <code>oidc-authservice</code> 에서 트러블슈팅이 발생했다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/Install1.png" 
    alt="Install1.png" 
     
    width=2054 
    height="694"  /></p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/install2.png" 
    alt="install2.png" 
     
    width=2100 
    height="634"  /></p>
<p>이벤트가 없어 원인을 찾는데 며칠을 소요했다. 원인은 PVC 권한 문제로 EBS CSI Driver 에 대한 IAM role에 대한 OIDC 가 잘못 입력되어 발생하는 것이였다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/ebs-driver.png" 
    alt="ebs-driver.png" 
     
    width=2188 
    height="548"  /></p>
<p>AWS 콘솔에서 OIDC 번호를 수정하니 정상적으로 작동되었다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/oidc2.png" 
    alt="oidc2.png" 
     
    width=1498 
    height="850"  /></p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/oidc-server.png" 
    alt="oidc-server.png" 
     
    width=1332 
    height="656"  /></p>
<h2 id="kubeflow-맛보기">
    <a href="#kubeflow-%eb%a7%9b%eb%b3%b4%ea%b8%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Kubeflow 맛보기
</h2>
<p>kubeflow 배포가 완료되었으면 다음의 명령어를 통해 대시보드에 할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl port-forward --address 0.0.0.0 svc/istio-ingressgateway -n istio-system 8080:80
</span></span></code></pre></td></tr></table>
</div>
</div><p>접속하면 dex 시스템에 아이디와 비밀번호를 입력하자. 공식 문서에 따르면 기본 아이디와 비밀번호는 <a href="mailto:user@example.com">user@example.com</a> , 12341234 이다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/kubeflow1.png" 
    alt="kubeflow1.png" 
     
    width=1844 
    height="692"  /></p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/kubeflow2.png" 
    alt="kubeflow2.png" 
     
    width=1840 
    height="873"  /></p>
<p>이어서 개발 환경인 노트북 서버를 생성해보자. 왼쪽 메뉴에서 [Notebooks] 에서 개발 환경을 설정하자.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/erro1.png" 
    alt="erro1.png" 
     
    width=1612 
    height="898"  /></p>
<p>🧐 <strong>notebook 생성 트러블슈팅</strong></p>
<p>필자의 경우 notebook 생성시 다음과 같이 에러가 나온다. <a href="https://github.com/mlops-for-all/mlops-for-all.github.io/issues/72#issuecomment-1007537301">깃이슈</a>를 확인하니 원인은 쥬피터 내부에서 HTTP 접근에서 생긴 보안 에러였다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>403<span class="o">]</span> Could not find CSRF cookie XSRF-TOKEN in the request. 
</span></span><span class="line"><span class="cl">http://3.38.94.212:8080/jupyter/api/namespaces/kubeflow-user-example-com/notebooks
</span></span></code></pre></td></tr></table>
</div>
</div><p>필자의 경우 배포되어 있는 jupyer notebook을 수정하였다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl edit deploy/jupyter-web-app-deployment -n kubeflow
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">maxUnavailable: 25%
</span></span><span class="line"><span class="cl">    type: RollingUpdate
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      creationTimestamp: null
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: jupyter-web-app
</span></span><span class="line"><span class="cl">        kustomize.component: jupyter-web-app
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - env:
</span></span><span class="line"><span class="cl">        - name: APP_PREFIX
</span></span><span class="line"><span class="cl">          value: /jupyter
</span></span><span class="line"><span class="cl">        - name: UI
</span></span><span class="line"><span class="cl">          value: default
</span></span><span class="line"><span class="cl">        - name: USERID_HEADER
</span></span><span class="line"><span class="cl">          value: kubeflow-userid
</span></span><span class="line"><span class="cl">        - name: USERID_PREFIX
</span></span><span class="line"><span class="cl">        - name: APP_SECURE_COOKIES
</span></span><span class="line"><span class="cl">          value: <span class="s2">&#34;false&#34;</span> <span class="c1"># ture 에서 false 로 수정 ! </span>
</span></span><span class="line"><span class="cl">        image: docker.io/kubeflownotebookswg/jupyter-web-app:v1.7.0
</span></span><span class="line"><span class="cl">        imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">        name: jupyter-web-app
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">5000</span>
</span></span><span class="line"><span class="cl">          protocol: TCP
</span></span><span class="line"><span class="cl">        resources: <span class="o">{}</span>
</span></span><span class="line"><span class="cl">        terminationMessagePath: /dev/termination-log
</span></span><span class="line"><span class="cl">        terminationMessagePolicy: File
</span></span><span class="line"><span class="cl">        volumeMounts:
</span></span><span class="line"><span class="cl">        - mountPath: /etc/config
</span></span><span class="line"><span class="cl">          name: config-volume
</span></span><span class="line"><span class="cl">        - mountPath: /src/apps/default/static/assets/logos
</span></span><span class="line"><span class="cl">          name: logos-volume
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>수정 이후 포트포워딩을 다시해서 시도하면 정상적으로 노트북 서버가 배포된다.</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/test1.png" 
    alt="test1.png" 
     
    width=1858 
    height="880"  /></p>
<p>노트북 서버에 들어가서 간단하게 테스트해보자!</p>
<p><img loading="lazy" 
    src="/./spot-and-kubeflow/test2.png" 
    alt="test2.png" 
     
    width=1859 
    height="971"  /></p>
<h2 id="마치며">
    <a href="#%eb%a7%88%ec%b9%98%eb%a9%b0" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    마치며
</h2>
<p>이번 글에서는 kubeflow 인프라와 kubeflow 배포까지 구성하였다. 다음 시간에는 kubeflow 기능(파라미터 최적화, GPU 할당) 관련 인프라적인 측면을 딥하게 다뤄보겠다.</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/aews-1-eks/" title="Previous post (older)">
            <span>Previous</span>
            [AEWS] EKS 아키텍처와 Private EKS 클러스터 배포하기
            </a>
        
        
        
    </nav>
    
</div>
 
<div class="container">
    
    <script src="https://giscus.app/client.js" 
        data-repo="WingLim/hugo-tania"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTYyNjQzMDc="
        
        data-category="Comments"
        data-category-id="DIC_kwDOEtnPc84B_WKP"
        
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async
        >
</script>

<script>
    function setGiscusTeheme(theme) {
        let giscus = document.querySelector('.giscus iframe');
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme
                        }
                    }
                },
                'https://giscus.app'
            )
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://giscus.app') return;
        setGiscusTeheme(document.documentElement.dataset.userColorScheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setGiscusTeheme(e.detail)
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>