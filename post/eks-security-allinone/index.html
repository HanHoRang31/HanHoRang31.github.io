<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>[AEWS] AWS 서비스를 통한 EKS 보안 구성 | HanHoRang Tech Blog</title>

    
    
    
    <meta property="og:site_name" content="HanHoRang Tech Blog by Tania in Hugo" />
    <meta property="og:title" content="[AEWS] AWS 서비스를 통한 EKS 보안 구성 | HanHoRang Tech Blog"/>
    <meta itemprop="name" content="[AEWS] AWS 서비스를 통한 EKS 보안 구성 | HanHoRang Tech Blog" />
    <meta name="twitter:title" content="[AEWS] AWS 서비스를 통한 EKS 보안 구성 | HanHoRang Tech Blog" />
    <meta name="application-name" content="[AEWS] AWS 서비스를 통한 EKS 보안 구성 | HanHoRang Tech Blog" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="AWS 서비스를 통해서 EKS 보안 이상탐지 모니터링, 시크릿 키 관리, 애플리케이션 트래픽 보호 구성하기" />
    <meta name="twitter:description" content="AWS 서비스를 통해서 EKS 보안 이상탐지 모니터링, 시크릿 키 관리, 애플리케이션 트래픽 보호 구성하기 "/>
    <meta itemprop="description" content=" AWS 서비스를 통해서 EKS 보안 이상탐지 모니터링, 시크릿 키 관리, 애플리케이션 트래픽 보호 구성하기 "/>
    <meta property="og:description" content=" AWS 서비스를 통해서 EKS 보안 이상탐지 모니터링, 시크릿 키 관리, 애플리케이션 트래픽 보호 구성하기 " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Hugo Tania" />
<meta property="og:article:published_time" content=2023-06-02T00:00:00Z />
<meta property="article:published_time" content=2023-06-02T00:00:00Z />


  <meta property="og:article:author" content="Han ho rnag" />
  <meta property="article:author" content="Han ho rnag" />
  <meta name="author" content="Han ho rnag" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "[AEWS] AWS 서비스를 통한 EKS 보안 구성",
    "author": {
      "@type": "Person",
      "name": "Hugo Tania"
    },
    "datePublished": "2023-06-02",
    "description": "AWS 서비스를 통해서 EKS 보안 이상탐지 모니터링, 시크릿 키 관리, 애플리케이션 트래픽 보호 구성하기",
    "wordCount":  4076 ,
    "mainEntityOfPage": "True",
    "dateModified": "2023-06-02",
    "publisher": {
      "@type": "Organization",
      "name": "Hugo Tania",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/HanHoRang31.github.io\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                    HanHoRang Tech Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>[AEWS] AWS 서비스를 통한 EKS 보안 구성</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By HanHoRnag | <time>June 02, 2023</time>
                            | 20 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/kans/">KANS</a>
                            
                            <a href="/tags/kubeflow/">kubeflow</a>
                            
                            <a href="/tags/cloud/">cloud</a>
                            
                            <a href="/tags/aws/">AWS</a>
                            
                            <a href="/tags/eksctl/">eksctl</a>
                            
                            <a href="/tags/eks/">eks</a>
                            
                            <a href="/tags/security/">security</a>
                            
                            <a href="/tags/sealedsecrets/">SealedSecrets</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">AWS EKS Workshop Study (=AEWS)는 EKS Workshop 실습 스터디입니다.
</span></span><span class="line"><span class="cl">CloudNet@ Gasida(가시다)님이 진행하시며,공개된 AWS EKS Workshop을 기반으로 진행하고 있습니다.
</span></span></code></pre></td></tr></table>
</div>
</div><p>지난 글에 이어서 AWS 서비스를 통해서 EKS 보안 구성을 한 내용들을 공유한다. 보안 구성 내용은 EKS  워크샵 내용을 참고하여 정리하였다. 보안 구성 내용은 다음과 같다.</p>
<ul>
<li>EKS Secret 시크릿 키 관리 : Sealed Secrets + AWS KMS</li>
<li>EKS 이상 탐지 모니터링 : Amazon GuardDuty + 사고 대응</li>
<li>EKS 애플리케이션 트래픽 보호 : AWS WAF</li>
</ul>
<h2 id="eks-secret-key-관리">
    <a href="#eks-secret-key-%ea%b4%80%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    EKS Secret Key 관리
</h2>
<blockquote>
<p>참고 : <a href="https://www.eksworkshop.com/docs/security/sealed-secrets/">EKS 워크샵</a>, <a href="https://aws.amazon.com/ko/blogs/opensource/managing-secrets-deployment-in-kubernetes-using-sealed-secrets/">AWS 블로그</a></p>
</blockquote>
<p>Kubernetes Secret은  워크로드의 암호, OAuth 토큰 및 ssh 키 등과 같은 민감한 정보의 배포를 관리하는 리소스이다. Secret은 파드에 볼륨으로 마운트되거나 컨테이너 이미지를 가져오는 데 사용되는 자격 증명으로 사용된다. 그러나 Secret은 기본적으로 Base64 인코딩되어 저장되지만, 이는 실제로 암호화를 제공하는 것은 아니다. 이말은 Git 레파지토리에 시크릿을 업로드하게 되면 그대로 민감 데이터가 노출된다는 뜻으로, 시크릿 키에 대한 추가 관리를 통해 레파지토리에 시크릿 키가 업로드 되도 문제가 없도록 구성해야 한다. 이를 해결하기 위해 본 장에서는 Sealed Secrets + AWS KMS 를 이용하여 쿠버네티스 워크로드의 시크릿 키를 관리하여 레파지토리에서도 시크릿 키를 관리할 수 있도록 보안 구성을 진행할 것이다.</p>
<h3 id="sealed-secrets-원리">
    <a href="#sealed-secrets-%ec%9b%90%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Sealed Secrets 원리
</h3>
<p>Sealed Secrets는 Kubernetes에서 Secret을 안전하게 관리하기 위한 도구로 시크릿 키에 대해 암호화를 해주는 도구이다. 암호화 원리 이해를 위해 Sealed Secrets 구성을 먼저 확인하면 다음과 같다.</p>
<p>Sealed Secrets 두 가지 파트에서 시크릿 키에 대해 암호화 / 복호화를 하여 암호화된 키 관리를 구성한다.</p>
<ul>
<li>A client-side utility (<code>kubeseal</code> ) :  CLI 도구로 시크릿 키에 대해 암호화를 진행해준다.  암호화에 대한 공개 키 / 비밀 키는 Cluster-side controller에서 진행한다.</li>
<li>A cluster-side controller / operator : 쿠버네티스 클러스터에서 설치되며, 고유한 공개 키/비밀 키 쌍을 생성하여 키 관리를 진행한다. Kubeseal 에서 암호화한 시크릿 키에 대해 복호화를 해준다.</li>
</ul>
<p>각 파트를 통해 시크릿 키를 관리하는 과정은 다음과 같다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/kubesealed.png" 
    alt="&lt;a href=&#34;https://auth0.com/blog/kubernetes-secrets-management/&#34;&gt;https://auth0.com/blog/kubernetes-secrets-management/&lt;/a&gt;" 
     
    width=806 
    height="550"  /></p>
<p><a href="https://auth0.com/blog/kubernetes-secrets-management/">https://auth0.com/blog/kubernetes-secrets-management/</a></p>
<ol>
<li>(왼쪽 위 컨트롤러) Sealed Secrets 컨트롤러는 클러스터에 설치되며, 고유한 공개 키/비밀 키 쌍을 생성한다. 이 키 쌍은 SealedSecret 리소스를 암호화하고 복호화하는 데 사용된다.</li>
<li>(아래 과정) 사용자는 <code>kubeseal</code> CLI 도구를 사용하여 Secret을 SealedSecret으로 변환(암호화)한다. 이 변환은 로컬에서 수행되며, 원본 Secret은 클러스터에 전송되지 않는다.  변환된 암호화된 시크릿 키를 통해 git 레파지토리에 업로드시 안전하게 키를 관리할 수 있다(store)</li>
<li>(오른쪽 위 과정) 시크릿 키를 통한 워크로드 배포시 Sealed Secrets 컨트롤러는 SealedSecret 리소스를 감지하고 해당 Secret을 복호화하여 클러스터에 배포한다.</li>
</ol>
<h3 id="sealed-secrets-설치">
    <a href="#sealed-secrets-%ec%84%a4%ec%b9%98" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Sealed Secrets 설치
</h3>
<p>Sealed Secrets 를 사용하기 위해서는 Client-Side와 Cluster-Side 의 툴을 각각 설치해야 한다.</p>
<ul>
<li>
<p>Client-Side 설치 (kubeseal CLI) - <a href="https://github.com/bitnami-labs/sealed-secrets/releases">바이너리 확인</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 리눅스 </span>
</span></span><span class="line"><span class="cl">wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.21.0/kubeseal-0.21.0-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">tar -xvzf kubeseal-0.21.0-linux-amd64.tar.gz
</span></span><span class="line"><span class="cl">sudo install -m <span class="m">755</span> kubeseal /usr/local/bin/kubeseal 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Cluster-Side 설치 (Sealed Secrets Controllers)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.21.0/controller.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>컨트롤러를 설치하면 컨트롤러 로그를 통해 인증서와 공개 키, 비밀 키를 확인할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 인증서 확인 </span>
</span></span><span class="line"><span class="cl">kubectl logs deployments/sealed-secrets-controller -n kube-system
</span></span><span class="line"><span class="cl">--
</span></span><span class="line"><span class="cl">controller version: 0.21.0
</span></span><span class="line"><span class="cl">2023/06/03 02:57:08 Starting sealed-secrets controller version: 0.21.0
</span></span><span class="line"><span class="cl">Searching <span class="k">for</span> existing private keys
</span></span><span class="line"><span class="cl">New key written to kube-system/sealed-secrets-keynllnv
</span></span><span class="line"><span class="cl">Certificate is 
</span></span><span class="line"><span class="cl">-----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">MIIEzDCCArSgAwIBAgIQCbNur2lY5wvwqAZYH7KKsTANBgkqhkiG9w0BAQsFADAA
</span></span><span class="line"><span class="cl">MB4XDTIzMDYwMzAyNTcxMloXDTMzMDUzMTAyNTcxMlowADCCAiIwDQYJKoZIhvcN
</span></span><span class="line"><span class="cl">AQEBBQADggIPADCCAgoCggIBALqtMiIVQUHCT7EEcTGzRPNOK3CH8hwhOX8gxDcA
</span></span><span class="line"><span class="cl">3uN0sLYGRhWyHh+tTDf6BeFvT/K44OU1MjpcyityArXkXizXT5G6Xehl5YY5lHJI
</span></span><span class="line"><span class="cl">f/3V71kxzSo/iwj4nn900NbMZ8hhFmd4tm23GjLjx02U6D0frC7qFXfZLy4f+qAO
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 키 확인 </span>
</span></span><span class="line"><span class="cl">kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key -o yaml
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">items:
</span></span><span class="line"><span class="cl">- apiVersion: v1
</span></span><span class="line"><span class="cl">  data:
</span></span><span class="line"><span class="cl">    tls.crt: ... <span class="c1"># 키 </span>
</span></span><span class="line"><span class="cl">    tls.key: ... <span class="c1"># 키</span>
</span></span><span class="line"><span class="cl">  kind: Secret
</span></span><span class="line"><span class="cl">  metadata:
</span></span><span class="line"><span class="cl">    creationTimestamp: <span class="s2">&#34;2023-06-03T02:57:12Z&#34;</span>
</span></span><span class="line"><span class="cl">    generateName: sealed-secrets-key
</span></span><span class="line"><span class="cl">    labels:
</span></span><span class="line"><span class="cl">      sealedsecrets.bitnami.com/sealed-secrets-key: active
</span></span><span class="line"><span class="cl">    name: sealed-secrets-keynllnv
</span></span><span class="line"><span class="cl">    namespace: kube-system
</span></span><span class="line"><span class="cl">    resourceVersion: <span class="s2">&#34;36062&#34;</span>
</span></span><span class="line"><span class="cl">    uid: 178a33bf-14b4-4cde-8687-76e08e5f2b2f
</span></span><span class="line"><span class="cl">  type: kubernetes.io/tls
</span></span><span class="line"><span class="cl">kind: List
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="sealed-secrets-를-통한-키-관리">
    <a href="#sealed-secrets-%eb%a5%bc-%ed%86%b5%ed%95%9c-%ed%82%a4-%ea%b4%80%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Sealed Secrets 를 통한 키 관리
</h3>
<p>시크릿 키 관리를 위한 예제로 mysql를 배포하고 sealed secret 을 통해 mysql 접근 패스워드를 관리해보겠다.</p>
<ul>
<li>
<p>mysql 예제 배포</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mysql-depeloyment.yaml </span>
</span></span><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mysql
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: mysql
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: <span class="m">1</span>
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: mysql
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: mysql
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: mysql
</span></span><span class="line"><span class="cl">        image: mysql:8.0.26
</span></span><span class="line"><span class="cl">        env:
</span></span><span class="line"><span class="cl">        - name: MYSQL_ROOT_PASSWORD
</span></span><span class="line"><span class="cl">          valueFrom:
</span></span><span class="line"><span class="cl">            secretKeyRef:
</span></span><span class="line"><span class="cl">              name: mysql-root
</span></span><span class="line"><span class="cl">              key: password
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">3306</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mysql-secret.yaml</span>
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Secret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: mysql-root
</span></span><span class="line"><span class="cl">type: Opaque
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  password: <span class="nv">cm9vdA</span><span class="o">==</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>시크릿 키를 디코딩하면 패스워드는 root 이다</li>
</ul>
</li>
</ul>
<p>mysql 접근 시크릿에 대하여 sealed secrets를 통해 암호화를 진행하자.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 로컬에 컨트롤러 인증서 저장하기 </span>
</span></span><span class="line"><span class="cl">kubeseal --fetch-cert &gt; mycert.pem 
</span></span><span class="line"><span class="cl"><span class="c1"># 저장한 컨트롤러 인증서를 통한 암호화 </span>
</span></span><span class="line"><span class="cl">cat mysql-secret.yaml <span class="p">|</span> kubeseal --cert mycert.pem -o yaml &gt; sealed-secret.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>암호화 후 키를 확인하면 다음과 같이 패스워드가 달라진 것을 확인할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat sealed-secret.yaml 
</span></span><span class="line"><span class="cl">--- 
</span></span><span class="line"><span class="cl">apiVersion: bitnami.com/v1alpha1
</span></span><span class="line"><span class="cl">kind: SealedSecret
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: null
</span></span><span class="line"><span class="cl">  name: mysql-root
</span></span><span class="line"><span class="cl">  namespace: default
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  encryptedData:
</span></span><span class="line"><span class="cl">    password: AgBGUSjNgqCLMGKI/y/IwlhgNVzF/wrUFxx00eS/33Q4ZniweRu9Wfwlu9Pq16uBmECmVBPlN7US/gX0wV/hqxYrfWULTaByDnNsrRhKaRFGg0mD5DHCxFLqzTZKzUMZwYZovPxREcMt/d1yx3tWViVsqnz5VnNZYONeyhaZvU059Tj1EWyvfoow19YZM9V3iiyxraX2VB1luTPSbt9JZ355hfWxgDXUHTsheKOVW8GUC1fBi15pBFJXwovoqa6cQ1YcYOKSslJORf+WcDB836ikgykJiHoFpgcLVPS/3uaR73RBAN93gt52hHRpwqFj7aMczqm4aruz6tB7ugpSpArjYDkBHaO5NuaYoeeIGApqsjMQUc/ASuZGXf8rPBZiQeDS5QFLZR3II7gVyyYYQXwMmOy7BCmzBSbzZhKKq9wmD7/uEVBmmH9yJFcCC+FyfzlUyycsANCAWJO12z0MzdVSNr7Lbhb2GUStq6VDlQLndCn1MDAwKbYtkxdwGB5H4PcSiM1+TNkwpwOY7O59XwcWNAVtfPFMLK62lgTCFm0RjR7M/oJX32yWFLfiAifnYVJuNK8ic33J2fFyQvZ3TxWVsZzryOI3+vsR+cUbMh3DCXfMduJ/VtPHUe3zsbbYVOA/Fs/+MpP9GkqkndvQx6kyLhGnIUOOU4iIR2loAPXIjhq1ZUn5XPY7jbrO27yr0clQxM2B
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      creationTimestamp: null
</span></span><span class="line"><span class="cl">      name: mysql-root
</span></span><span class="line"><span class="cl">      namespace: default
</span></span><span class="line"><span class="cl">    type: Opaque
</span></span></code></pre></td></tr></table>
</div>
</div><p>암호화된 시크릿 키를 배포하면 mysql 이 정상적으로 배포된 것을 확인할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl apply -f sealed-secret.yaml 
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">sealedsecret.bitnami.com/mysql-root created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pods -A 
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">default       mysql-9fd5797cc-l8szh                       1/1     Running   <span class="m">0</span>          4m23s
</span></span><span class="line"><span class="cl">default       sealed-secrets-855f5fbf78-d2j4b             1/1     Running   <span class="m">0</span>          23m
</span></span><span class="line"><span class="cl">kube-system   aws-node-j6nq2                              1/1     Running   <span class="m">0</span>          3h18m
</span></span><span class="line"><span class="cl">kube-system   aws-node-lg25d                              1/1     Running   <span class="m">0</span>          3h18m
</span></span><span class="line"><span class="cl">kube-system   coredns-6777fcd775-68cql                    1/1     Running   <span class="m">0</span>          3h16m
</span></span><span class="line"><span class="cl">kube-system   coredns-6777fcd775-jzxr2                    1/1     Running   <span class="m">0</span>          3h16m
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-controller-67dccdf78f-65hr5         6/6     Running   <span class="m">0</span>          3h15m
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-controller-67dccdf78f-hjgjm         6/6     Running   <span class="m">0</span>          3h15m
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-4jzmh                          3/3     Running   <span class="m">0</span>          3h15m
</span></span><span class="line"><span class="cl">kube-system   ebs-csi-node-68n58                          3/3     Running   <span class="m">0</span>          3h15m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-8bgrm                            1/1     Running   <span class="m">0</span>          3h17m
</span></span><span class="line"><span class="cl">kube-system   kube-proxy-wvnfs                            1/1     Running   <span class="m">0</span>          3h17m
</span></span><span class="line"><span class="cl">kube-system   sealed-secrets-controller-b97869575-d7prq   1/1     Running   <span class="m">0</span>          14m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> mysql-9fd5797cc-l8szh  -it /bin/sh
</span></span><span class="line"><span class="cl">-- 
</span></span><span class="line"><span class="cl">mysql -u root -p 
</span></span><span class="line"><span class="cl"><span class="c1"># root 입력 </span>
</span></span><span class="line"><span class="cl">Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span>.
</span></span><span class="line"><span class="cl">Your MySQL connection id is <span class="m">11</span>
</span></span><span class="line"><span class="cl">Server version: 8.0.26 MySQL Community Server - GPL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2021, Oracle and/or its affiliates.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Oracle is a registered trademark of Oracle Corporation and/or its
</span></span><span class="line"><span class="cl">affiliates. Other names may be trademarks of their respective
</span></span><span class="line"><span class="cl">owners.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Type <span class="s1">&#39;help;&#39;</span> or <span class="s1">&#39;\h&#39;</span> <span class="k">for</span> help. Type <span class="s1">&#39;\c&#39;</span> to clear the current input statement.
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sealed-secrets-키-관리">
    <a href="#sealed-secrets-%ed%82%a4-%ea%b4%80%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Sealed Secrets 키 관리
</h3>
<p>앞 서 과정을 확인하니 Sealed Secrets 컨트롤러 내 키를 통해 시크릿 키를 암호화 / 복호화하는 것을 확인하였다. 말 그대로 이중으로 암호화를 진행한 것으로 이해하면 되는데 만약 클러스터를 옮긴다고 가정하거나 재해상태로 새로운 Sealed Secrets 컨트롤러를 생성하는 경우가 생긴다면 시크릿 키의 복호화가 안될 것이고 통일성이 깨져 관리가 힘들어질 것이 분명하다. 그렇다면  Sealed Secrets 컨트롤러 키 관리가 필요한데, AWS Systems Manager Parameter Store 를 통해서 키 관리를 위임할 수 있다.</p>
<p>Sealed Secrets 컨트롤러 키는 다음의 명령어를 통해 키를 파일로 저장시킬 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get secret -n kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key -o yaml &gt; master-sealing-key.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>해당 파일에서 tls.crt 와 tls.key 에 대해 키 관리가 필요하다. AWS Systems Manager Parameter Store 에서 키를 생성하면 되는데 AWS 콘솔 → Systems Manager  →  Parameter Store  에서 해당 키를 입력하고 저장시키면 된다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/parameter1.png" 
    alt="parameter1.png" 
     
    width=1243 
    height="831"  /></p>
<p>저장한 키는 다음의 명령어로 확인할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">aws ssm get-parameter --name <span class="s2">&#34;master-sealing-key-tls-crt&#34;</span> --with-decryption
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Parameter&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Name&#34;</span>: <span class="s2">&#34;master-sealing-key-tls-crt&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Type&#34;</span>: <span class="s2">&#34;String&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Value&#34;</span>: <span class="s2">&#34;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUV6RENDQXJTZ0F3SUJBZ0lRQ2JOdXIybFk1d3Z3cUFaWUg3S0tzVEFOQmdrcWhraUc5dzBCQVFzRkFEQUEKTUI0WERUSXpNRFl3TXpBeU5UY3hNbG9YRFRNek1EVXpNVEF5TlRjeE1sb3dBRENDQWlJd0RRWUpLb1pJaHZjTgpBUUVCQlFBRGdnSVBBRENDQWdvQ2dnSUJBTHF0TWlJVlFVSENUN0VFY1RHelJQTk9LM0NIOGh3aE9YOGd4RGNBCjN1TjBzTFlHUmhXeUhoK3RURGY2QmVGdlQvSzQ0T1UxTWpwY3lpdHlBclhrWGl6WFQ1RzZYZWhsNVlZNWxISkkKZi8zVjcxa3h6U28vaXdqNG5uOTAwTmJNWjhoaEZtZDR0bTIzR2pMangwMlU2RDBmckM3cUZYZlpMeTRmK3FBTwpEaFpoK2dJOWFvMXJSUWZCeDlIaW1vS1FRRy9GTGlxN0NsME5PaC9VQ1o0Q0RIVDd4VTJsN1JkMytsZDJhdTVMCktMR0N2bjZtOUpnVndwNUU0cGY5dUhoVzlVbU5ESXp6dUZFMEpXSUpwVnpIbForZThPYTNXc1p2aFlzUVlKa2EKcHRpelVwbWZBYTVXdFgyTUsyOFNVbVRaRnlqQTFYaFlRRHN5dGt3NTUzdXBjcW14V3hCZjVBUzlhNGs3Ujk5eAplcVhNK3R1a1dpWUpJSkxnaG9oRW12c3BGZmNBMUFlOVIxVnhKVEJKaVBBN2xmTFVLY1prN1hqMmgwR0t5L09UClVrY0ZCSFFvQlh2c0pseCtIVjROQnEwb2o4TVNkeGtTeWtpcnpKeWtHcFdoOE9HVXNLK2dwd0pCRkVsa0tTc2YKVzdhNlV1VU5kbUwrYzl5Tnp2T2hCUlZkRG1XMUU4ZWN5V3NrSW9MSy92WnRsRFk4ZzgwNmhaVTdZSHI1WWhVYwpWTjJjWXVnM0lwRVVNQkVQU0ZCVk9sd2pUYWw5TVRrK3lXR3VPVUhFeUZ0VzlKQ0IwQmVvTjZUM21uS280cUpyCjNaRmIxTGJrSk56TE1aWUlDbmdYeFhrbC9ic3kyR0tIc0FGL04walA2aDRNMmRTOTRJa2NQOFhhNWVTcGd5RXYKZU9IUEFnTUJBQUdqUWpCQU1BNEdBMVVkRHdFQi93UUVBd0lBQVRBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUIwRwpBMVVkRGdRV0JCVDUzM0t6VENNYkVzYm1CV1JBK3cwWmpIc1VoVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBZ0VBClZUNnQzV1IzTEFCUkJVeUNFZXhoRzRLWEFLeTdhVGhqODJHdlo0Q2thMFFNTEp4OUFaMjZZZFREMlZDRUNILzgKb3hUYlNiZzVtYTVUd0p0b25LTnpzMUkydWFpRFlDRG5aWHhjRUhnSmpEaFFDOUJwRUdPZmY1ek4xSTlMcFJMSgpXSjBKSk9vVW5WbjA2cHhqSTJvdVVRZy9oNVhidVBsZWJjVGFJN0Q0RWNZWWwzYnF5enpWVTFVRFFBdWpDTlB0CnZRcDZQa2YvTUUrcE9BNnpPU3BDckExYW92WlpZdTZUQWpzanZpcXluYVdnUWF5TFZ1OHJpSzZibzBOdGh4TzkKTWpmQXlyWGFUdUxNK0RlOVBIMW1teHB5SUZ3dmREcjZYWlRkTEN2SVpNdGprQXM2SXhqcDlheHVUS1lQVHVqcgpCNmxOa0hUNW9aSFNDUmVxVGFQZ3ZzcTdYb3dRNGtNU0traUp4OEhrNTJkVDVuQ0sybGltdVlESmFoWWZrSm1WCjV1NkQ4MkJoa3BKUSswQkJxN1pWTkZ2VCs1ME5NRG5BbVhWamdQd0VKVTFqdDNtS0Z6eWw1bWswSTZaZGpqd0kKVkdybUZLZWs2c1UzVERjbFJSdHJiUGlVZ3ZWUk5Fa0UxSGZzUHBFR0h4NzNxb0MycjRwUTVrOEYzd2JqQkU3VQo0MW02VVFsLzZ4a1RvV3M0RU85dUtFazdaVVBqTUEwK3hkYnZDWGdDRE45QXN3ZlQ2bzhMWGE5eUVyL3NNcng4Ck9ReEJsY1ZRRVRUc0hUd0djcEZlZ2hBUzNacll6U2w5ZGhCWHgweWZQUnZJWnRzdzMyVy9GS1M4djMvcmtQZDIKWGk1QjdldzJ2U0NSL0t2VHFiUG52UDU4cENyVVhlZUJhVmxIYlNqMUE2Zz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Version&#34;</span>: 1,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;LastModifiedDate&#34;</span>: <span class="s2">&#34;2023-06-03T12:48:22.354000+09:00&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ARN&#34;</span>: <span class="s2">&#34;arn:aws:ssm:ap-northeast-2:955963799952:parameter/master-sealing-key-tls-crt&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;DataType&#34;</span>: <span class="s2">&#34;text&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="amazon-guardduty">
    <a href="#amazon-guardduty" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Amazon GuardDuty
</h2>
<p>AWS 의 지능형 위협 탐지 서비스이다. 이 서비스는 AWS 계정, 워크로드, 그리고 AWS에서 호스팅되는 데이터를 보호하기 위해 고급 머신 러닝을 활용하여 악의적인 활동이나 비정상적인 행동을 탐지하는데 사용된다. 탐지는 다음의 활동에서 식별한다.</p>
<ol>
<li>인프라(EKS)와 계정(IAM)을 위협하는 악성 소스로부터의 공격과 위협</li>
<li>계정 내부의 위협, 즉 AWS 리소스를 위협하는 잠재적으로 악의적인 또는 무단 행동</li>
<li>AWS 리소스를 위협하는 알려진 악의적인 활동이나 알려진 비정상 행동</li>
</ol>
<p>GuardDuty는 AWS 로그 데이터, 예를 들어 AWS CloudTrail, Amazon VPC Flow Logs, DNS 로그 등을 분석하여 이러한 위협을 탐지한다. 별도의 설치도 필요 없으며, 사용자는 수동으로 활성화하거나 관리할 필요 없이 GuardDuty를 사용하여 보안 통찰력을 얻을 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guarduty1.png" 
    alt="&lt;a href=&#34;https://www.youtube.com/watch?v=t3rVVilJWEk&#34;&gt;https://www.youtube.com/watch?v=t3rVVilJWEk&lt;/a&gt;" 
     
    width=1780 
    height="600"  /></p>
<p><a href="https://www.youtube.com/watch?v=t3rVVilJWEk">https://www.youtube.com/watch?v=t3rVVilJWEk</a></p>
<p>활성화도 간단하다. AWS 콘솔에서 GuardDuty로 접속하여 EKS 보호 기능을 활성화시키면 끝이다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard2.png" 
    alt="guard2.png" 
     
    width=1802 
    height="672"  /></p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard3.png" 
    alt="guard3.png" 
     
    width=1508 
    height="575"  /></p>
<p>활성화 이후 결과에서 탐지 결과를 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard4.png" 
    alt="guard4.png" 
     
    width=1808 
    height="795"  /></p>
<p>다음은 워크샵에서 제공하는 이상 탐지 예제로 몇 가지 예제를 따라해보고 가드 듀티에 적용되는 지 확인해보겠다.</p>
<ul>
<li>
<p>파드 내에서 이상 실행 명령어  감지</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl -n kube-system <span class="nb">exec</span> <span class="k">$(</span>kubectl -n kube-system get pods -o name -l <span class="nv">app</span><span class="o">=</span>efs-csi-node <span class="p">|</span> head -n1<span class="k">)</span> -c efs-plugin -- <span class="nb">pwd</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>익명 사용자에 대한 접근 감지 (호출, 정책, 파드 생성)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">EKS_CLUSTER_NAME</span><span class="o">=</span>&lt;클러스터 이름 입력&gt;
</span></span><span class="line"><span class="cl"><span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span>ap-northeast-2 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># AnonymousAccessGranted</span>
</span></span><span class="line"><span class="cl">kubectl create role pod-create --verb<span class="o">=</span>get,list,watch,create,delete,patch --resource<span class="o">=</span>pods -n default 
</span></span><span class="line"><span class="cl">kubectl create rolebinding pod-access --role<span class="o">=</span>pod-create --user<span class="o">=</span>system:anonymous
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Discovery: SuccessfulAnonymousAccess</span>
</span></span><span class="line"><span class="cl"><span class="nv">API_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name <span class="nv">$EKS_CLUSTER_NAME</span> --query <span class="s2">&#34;cluster.endpoint&#34;</span> --region <span class="nv">$AWS_DEFAULT_REGION</span> --output text<span class="k">)</span>
</span></span><span class="line"><span class="cl">curl -k <span class="nv">$API_URL</span>/api/v1/pods
</span></span><span class="line"><span class="cl">-- 
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Status&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;Failure&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;pods is forbidden: User \&#34;system:anonymous\&#34; cannot list resource \&#34;pods\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;reason&#34;</span>: <span class="s2">&#34;Forbidden&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;details&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;pods&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;code&#34;</span>: <span class="m">403</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Impact:Kubernetes/SuccessfulAnonymousAccess </span>
</span></span><span class="line"><span class="cl"><span class="nv">API_URL</span><span class="o">=</span><span class="k">$(</span>aws eks describe-cluster --name <span class="nv">$EKS_CLUSTER_NAME</span> --query <span class="s2">&#34;cluster.endpoint&#34;</span> --region <span class="nv">$AWS_DEFAULT_REGION</span> --output text<span class="k">)</span>
</span></span><span class="line"><span class="cl">curl -k -v <span class="nv">$API_URL</span>/api/v1/namespaces/default/pods -X POST -H <span class="s1">&#39;Content-Type: application/yaml&#39;</span> -d <span class="s1">&#39;---
</span></span></span><span class="line"><span class="cl"><span class="s1">apiVersion: v1
</span></span></span><span class="line"><span class="cl"><span class="s1">kind: Pod
</span></span></span><span class="line"><span class="cl"><span class="s1">metadata:
</span></span></span><span class="line"><span class="cl"><span class="s1">  name: nginx
</span></span></span><span class="line"><span class="cl"><span class="s1">  namespace: default
</span></span></span><span class="line"><span class="cl"><span class="s1">spec:
</span></span></span><span class="line"><span class="cl"><span class="s1">  containers:
</span></span></span><span class="line"><span class="cl"><span class="s1">  - name: nginx
</span></span></span><span class="line"><span class="cl"><span class="s1">    image: nginx
</span></span></span><span class="line"><span class="cl"><span class="s1">    ports:
</span></span></span><span class="line"><span class="cl"><span class="s1">    - containerPort: 80
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span>
</span></span><span class="line"><span class="cl">--
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&lt; 
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Status&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;Failure&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;pods \&#34;nginx\&#34; is forbidden: PodSecurityPolicy: unable to admit pod: []&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;reason&#34;</span>: <span class="s2">&#34;Forbidden&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;details&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;name&#34;</span>: <span class="s2">&#34;nginx&#34;</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;pods&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;code&#34;</span>: <span class="m">403</span>
</span></span><span class="line"><span class="cl">* Connection <span class="c1">#0 to host 76A102F3C34E6587C0300AFD756C2316.gr7.ap-northeast-2.eks.amazonaws.com left intact </span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>서비스 사용자 계정에 cluster-admin가 부여된 경우 감지</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl create rolebinding sa-default-admin --clusterrole<span class="o">=</span>cluster-admin --serviceaccount<span class="o">=</span>default:default --namespace<span class="o">=</span>default 
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>내부 대시보드가 로드밸런서로 변경되어 외부로 서비스가 노출될 때 감지</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 예제 대시보드 배포 </span>
</span></span><span class="line"><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.1/aio/deploy/recommended.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 서비스 타입 로드밸런서로 변경</span>
</span></span><span class="line"><span class="cl">kubectl patch svc kubernetes-dashboard -n kubernetes-dashboard -p<span class="o">=</span><span class="s1">&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>루트 수준 액세스 권한이 있는 컨테이너가 실행 감지</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ubuntu-privileged
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: ubuntu-privileged
</span></span><span class="line"><span class="cl">  replicas: <span class="m">1</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: ubuntu-privileged
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: ubuntu-privileged
</span></span><span class="line"><span class="cl">        image: ubuntu
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">22</span>
</span></span><span class="line"><span class="cl">        securityContext:
</span></span><span class="line"><span class="cl">          privileged: <span class="nb">true</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>호스트 경로 볼륨 마운트 감지</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">apiVersion: apps/v1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: ubuntu-privileged
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    matchLabels:
</span></span><span class="line"><span class="cl">      app: ubuntu-privileged
</span></span><span class="line"><span class="cl">  replicas: <span class="m">1</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: ubuntu-privileged
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: ubuntu-privileged
</span></span><span class="line"><span class="cl">        image: ubuntu
</span></span><span class="line"><span class="cl">        ports:
</span></span><span class="line"><span class="cl">        - containerPort: <span class="m">22</span>
</span></span><span class="line"><span class="cl">        securityContext:
</span></span><span class="line"><span class="cl">          privileged: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">        volumeMounts:
</span></span><span class="line"><span class="cl">        - mountPath: /test-pd
</span></span><span class="line"><span class="cl">          name: test-volume
</span></span><span class="line"><span class="cl">      volumes:
</span></span><span class="line"><span class="cl">      - name: test-volume
</span></span><span class="line"><span class="cl">        hostPath: <span class="c1"># 호스트 볼륨 마운트 </span>
</span></span><span class="line"><span class="cl">          path: /etc
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>예제를 배포하면 다음과 같이 Guardduty 화면에서 이상 감지 결과와 정보를 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guardduty5.png" 
    alt="guardduty5.png" 
     
    width=1506 
    height="581"  /></p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard7.png" 
    alt="guard7.png" 
     
    width=1453 
    height="779"  /></p>
<p>해당 이벤트에 대해 <strong>알람 구성</strong>도 가능하다. AWS Guardduty <a href="https://docs.aws.amazon.com/ko_kr/guardduty/latest/ug/guardduty_findings_cloudwatch.html">공식 문서</a>를 참고하면 Cloudwatch 에 규칙 생성으로 이벤트를 받아 알람을 설정할 수 있다.</p>
<ul>
<li>
<p>설정 → 결과 내보내기 옵션을 통해 Cloudwatch 에 이벤트 제공</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard10.png" 
    alt="guard10.png" 
     
    width=1322 
    height="858"  /></p>
</li>
<li>
<p>Cloudwatch → 이벤트 → 규칙 생성</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard11.png" 
    alt="guard11.png" 
     
    width=1116 
    height="768"  /></p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard12.png" 
    alt="guard12.png" 
     
    width=824 
    height="666"  /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;source&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;aws.guardduty&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;detail-type&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;GuardDuty Finding&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;detail&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;severity&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="mi">4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">4.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">5.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">6.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">7.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mi">8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="mf">8.9</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>해당 코드는 severity 필드가 4.0에서 8.9 사이인 GuardDuty Finding 이벤트를 필터링하도록 설정되어 있다.</li>
</ul>
</li>
<li>
<p>구독 SNS 설정하고 규칙을 생성하자</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/duty12.png" 
    alt="duty12.png" 
     
    width=845 
    height="684"  /></p>
</li>
<li>
<p>구성이 완료되면 패턴 기반으로 이벤트가 4~8.9 발생시 SNS로 알람이 오는 것을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/guard14.png" 
    alt="guard14.png" 
     
    width=1596 
    height="593"  /></p>
</li>
</ul>
<p>운영 레벨에서 사용함에 있어 비용적인 측면에서도 고려해야 한다. 23년 6월 기준 30일동안 프리티어로 일정 사용량에 대한 비용을 무료로 제공하고 있다. 문제는 그 다음인데 해당 기능을 위해서는 Cloudtrail, VPC flowlog, EKS runtime 모니터링에 대한 비용을 추가로 산정해야 하기 때문에 도입시 반드시 고려해야 한다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/durt-fee1.png" 
    alt="durt-fee1.png" 
     
    width=1166 
    height="419"  /></p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/duty-fee2.png" 
    alt="&lt;a href=&#34;https://aws.amazon.com/ko/guardduty/pricing/&#34;&gt;https://aws.amazon.com/ko/guardduty/pricing/&lt;/a&gt;" 
     
    width=1159 
    height="534"  /></p>
<p><a href="https://aws.amazon.com/ko/guardduty/pricing/">https://aws.amazon.com/ko/guardduty/pricing/</a></p>
<h2 id="사고-대응">
    <a href="#%ec%82%ac%ea%b3%a0-%eb%8c%80%ec%9d%91" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    사고 대응
</h2>
<blockquote>
<p>참고 :  <a href="https://aws.github.io/aws-eks-best-practices/security/docs/incidents/">EKS 모범 사례 - 보안 - 사고 대응</a></p>
</blockquote>
<p>Amazon GuardDuty를 통해 악의적인 활동 및 이상 동작을 모니터링하고 알람을 거는 방법까지 확인하였다. 다음은 알람의 다음 단계로, 실제 보안 사고 발생시 대응할 수 있는 방법들을 정리한다. 실제 사고가 발생하면 영향을 받는 컨테이너를 폐기하고 교체할지 또는 컨테이너를 격리하고 검사할지 결정해야 한다.  말이 결정이지.. 결국 재발 방지를 위해  컨테이너 격리 및 검사(사고 근본 원인 분석 및 포렌식 조사)가 필수적으로 진행되어야 한다.  사고 대응의 과정은 식별 → 격리 → 포렌식 분석 및 재배포 으로 과정별 대응 계획을 공유하겠다.</p>
<h3 id="식별">
    <a href="#%ec%8b%9d%eb%b3%84" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    식별
</h3>
<p>가장 먼저 문제가 되는 파드나 노드를 식별하는 것이 중요하다. 식별 방식은 문제 파드나 서비스 계정, 취약 및 손상된 이미지를 기준으로 노드를 식별한다. 아래는 식별 방식별 명령어이다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 잘못된 파드 이름과 네임스페이스를 알고 있을 경우, 파드가 실행되는 노드를 식별하는 명령어 </span>
</span></span><span class="line"><span class="cl">kubectl get pods &lt;name&gt; --namespace &lt;namespace&gt; -o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.spec.nodeName}{&#34;\n&#34;}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 파드가 워크로드(예. 디플로이먼트)로 동작하는 경우 모든 포드와 실행 중인 노드를 나열하는 명령어 </span>
</span></span><span class="line"><span class="cl"><span class="nv">selector</span><span class="o">=</span><span class="k">$(</span>kubectl get deployments &lt;name&gt; <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span> --namespace &lt;namespace&gt; -o json <span class="p">|</span> jq -j <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s1">&#39;.spec.selector.matchLabels | to_entries | .[] | &#34;\(.key)=\(.value)&#34;&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pods --namespace &lt;namespace&gt; --selector<span class="o">=</span><span class="nv">$selector</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-o json <span class="p">|</span> jq -r <span class="s1">&#39;.items[] | &#34;\(.metadata.name) \(.spec.nodeName)&#34;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 서비스 계정을 사용하여 문제가 있는 파드나 노드를 식별하는 명령어</span>
</span></span><span class="line"><span class="cl">kubectl get pods -o json --namespace &lt;namespace&gt; <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    jq -r <span class="s1">&#39;.items[] |
</span></span></span><span class="line"><span class="cl"><span class="s1">    select(.spec.serviceAccount == &#34;&lt;service account name&gt;&#34;) |
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;\(.metadata.name) \(.spec.nodeName)&#34;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 취약하거나 손상된 이미지 및 작업자가 있는 파드나 노드를 식별 명령어</span>
</span></span><span class="line"><span class="cl"><span class="nv">IMAGE</span><span class="o">=</span>&lt;Name of the malicious/compromised image&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get pods -o json --all-namespaces <span class="p">|</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    jq -r --arg image <span class="s2">&#34;</span><span class="nv">$IMAGE</span><span class="s2">&#34;</span> <span class="s1">&#39;.items[] | 
</span></span></span><span class="line"><span class="cl"><span class="s1">    select(.spec.containers[] | .image == $image) | 
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#34;\(.metadata.name) \(.metadata.namespace) \(.spec.nodeName)&#34;&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="격리">
    <a href="#%ea%b2%a9%eb%a6%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    격리
</h3>
<p>문제 노드나 파드를 식별하였으면 해당 리소스에 대한 격리가 필요하다. 격리 과정은 다음과 같다.</p>
<ol>
<li>
<p>네트워크 정책을 통해 식별 파드의 인그래스 &amp; 이그래스 트래픽을 거부시킨다.</p>
<p>다음과 같이 문제있는 파드의 레이블(예제 레이블, <code>app:web</code>  ) 을 찾아 모든 트래픽을 거부시키는 네트워크 정책을 생성하여 공격을 중지시킬 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">networking.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">NetworkPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-deny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">Egress</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>만약 노드 호스트가 뚫린 경우, AWS 보안 그룹을 통해 식별 노드의 네트워크 인그래스를 막아 다른 호스트로 부터 격리할 수 있다. 다만, 보안 그룹을 변경할 때 실행 중인 모든 컨테이너가 영향을 받으니 사전 테스트를 통해 식별 IP 및 포트를 확인하는 작업이 필요하다.</p>
</li>
<li>
<p>IAM 보안 자격 증명 취소를 통해 추가 손상을 방지한다.</p>
<p>파드가 다른 AWS 리소스에 액세스할 수 있도록 허용하는 IAM 역할이 할당된 경우 추가 손상을 막기 위해 식별 노드에서 해당 IAM 역할을 제거한다. 이때도 다른 워크로드에 영향을 주지 않고 역할에서 IAM 정책을 안전하게 제거할 수 있는 지 평가가 필요하다.</p>
</li>
<li>
<p>노드 차단을 통해 더 이상 파드가 노드에 예약하지 않도록 설정한다.</p>
<p><code>kubernetes cordon</code>명령어를 통해 노드에 더 이상 파드를 예약하지 않도록 한다. 이는 다른 워크로드에 영향을 주지 않고 포렌식 연구를 하기 위함이다.</p>
</li>
<li>
<p>종료 방지 기능을 활성화하여 노드 축소 이벤트로 부터 노드를 보호시킨다.</p>
<p>해킹 공격으로 이상 감지의 파드를 지워 문제 원인을 지우려고 시도할 수 있다. 이때 ASG 의 종료 방지 기능을 활용하면,  인스턴스 축소 이벤트로 부터 노드를 보호시킬 수 있다.</p>
</li>
</ol>
<h3 id="포렌식-분석-및-재배포">
    <a href="#%ed%8f%ac%eb%a0%8c%ec%8b%9d-%eb%b6%84%ec%84%9d-%eb%b0%8f-%ec%9e%ac%eb%b0%b0%ed%8f%ac" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    포렌식 분석 및 재배포
</h3>
<p>다음은 원인 분석을 위해 식별 노드에 대한 휘발성 아키텍츠 캡처가 필요하다.</p>
<ol>
<li>
<p>노드에서 실행 중인 도커 프로세스와 메모리 및 포트 확인</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 파드별 프로세스 확인 </span>
</span></span><span class="line"><span class="cl">sudo pstree
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">systemd─┬─2*<span class="o">[</span>agetty<span class="o">]</span>
</span></span><span class="line"><span class="cl">        ├─amazon-ssm-agen─┬─ssm-agent-worke───8*<span class="o">[{</span>ssm-agent-worke<span class="o">}]</span>
</span></span><span class="line"><span class="cl">        │                 └─8*<span class="o">[{</span>amazon-ssm-agen<span class="o">}]</span>
</span></span><span class="line"><span class="cl">        ├─auditd───<span class="o">{</span>auditd<span class="o">}</span>
</span></span><span class="line"><span class="cl">        ├─chronyd
</span></span><span class="line"><span class="cl">        ├─containerd───11*<span class="o">[{</span>containerd<span class="o">}]</span>
</span></span><span class="line"><span class="cl">        ├─containerd-shim─┬─aws-vpc-cni─┬─aws-k8s-agent───8*<span class="o">[{</span>aws-k8s-agent<span class="o">}]</span>
</span></span><span class="line"><span class="cl">        │                 │             └─4*<span class="o">[{</span>aws-vpc-cni<span class="o">}]</span>
</span></span><span class="line"><span class="cl">        │                 ├─pause
</span></span><span class="line"><span class="cl">        │                 └─11*<span class="o">[{</span>containerd-shim<span class="o">}]</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 파드별 프로세스 및 메모리 확인</span>
</span></span><span class="line"><span class="cl">ps afxuwww 
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">root      <span class="m">5699</span>  0.0  0.3 <span class="m">721420</span> <span class="m">15284</span> ?        Ssl  05:32   0:01  <span class="se">\_</span> /livenessprobe --csi-address<span class="o">=</span>/csi/csi.sock
</span></span><span class="line"><span class="cl">root      <span class="m">5409</span>  0.1  0.2 <span class="m">712480</span> <span class="m">10924</span> ?        Sl   05:32   0:11 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id eb55d159bad848ea2179132ee8d8d26dcb768aba4098331045b5943fa3981120 -address /run/containerd/containerd.sock
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5430</span>  0.0  0.0    <span class="m">972</span>     <span class="m">4</span> ?        Ss   05:32   0:00  <span class="se">\_</span> /pause
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5502</span>  0.0  1.0 <span class="m">765196</span> <span class="m">39908</span> ?        Ssl  05:32   0:01  <span class="se">\_</span> /bin/aws-ebs-csi-driver controller --endpoint<span class="o">=</span>unix:///var/lib/csi/sockets/pluginproxy/csi.sock --k8s-tag-cluster-id<span class="o">=</span>hanhorang --logging-format<span class="o">=</span>text --user-agent-extra<span class="o">=</span>eks --v<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5646</span>  0.0  1.0 <span class="m">755660</span> <span class="m">42648</span> ?        Ssl  05:32   0:08  <span class="se">\_</span> /csi-provisioner --csi-address<span class="o">=</span>/var/lib/csi/sockets/pluginproxy/csi.sock --v<span class="o">=</span><span class="m">2</span> --feature-gates<span class="o">=</span><span class="nv">Topology</span><span class="o">=</span><span class="nb">true</span> --extra-create-metadata --leader-election<span class="o">=</span><span class="nb">true</span> --default-fstype<span class="o">=</span>ext4
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5788</span>  0.0  0.9 <span class="m">751060</span> <span class="m">35884</span> ?        Ssl  05:32   0:03  <span class="se">\_</span> /csi-attacher --csi-address<span class="o">=</span>/var/lib/csi/sockets/pluginproxy/csi.sock --v<span class="o">=</span><span class="m">2</span> --leader-election<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5852</span>  0.1  0.8 <span class="m">750784</span> <span class="m">32136</span> ?        Ssl  05:32   0:17  <span class="se">\_</span> /csi-snapshotter --csi-address<span class="o">=</span>/var/lib/csi/sockets/pluginproxy/csi.sock --leader-election<span class="o">=</span><span class="nb">true</span> --extra-create-metadata
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5927</span>  0.0  0.8 <span class="m">751100</span> <span class="m">34652</span> ?        Ssl  05:32   0:00  <span class="se">\_</span> /csi-resizer --csi-address<span class="o">=</span>/var/lib/csi/sockets/pluginproxy/csi.sock --v<span class="o">=</span><span class="m">2</span> --handle-volume-inuse-error<span class="o">=</span><span class="nb">false</span>
</span></span><span class="line"><span class="cl">ec2-user  <span class="m">5961</span>  0.0  0.4 <span class="m">721676</span> <span class="m">16452</span> ?        Ssl  05:32   0:02  <span class="se">\_</span> /livenessprobe --csi-address<span class="o">=</span>/csi/csi.sock
</span></span><span class="line"><span class="cl">root     <span class="m">13499</span>  0.0  0.2 <span class="m">712224</span> <span class="m">10252</span> ?        Sl   05:57   0:01 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id cb6ebee42e28416dce159859edd5c0c2ca894bdae5fab6af4e51f8b26c21dc28 -address /run/containerd/containerd.sock
</span></span><span class="line"><span class="cl"><span class="m">65535</span>    <span class="m">13521</span>  0.0  0.0    <span class="m">972</span>     <span class="m">4</span> ?        Ss   05:57   0:00  <span class="se">\_</span> /pause
</span></span><span class="line"><span class="cl">docker   <span class="m">13651</span>  0.0  0.8 <span class="m">741808</span> <span class="m">34400</span> ?        Ssl  05:58   0:03  <span class="se">\_</span> /dashboard --insecure-bind-address<span class="o">=</span>0.0.0.0 --bind-address<span class="o">=</span>0.0.0.0 --auto-generate-certificates --namespace<span class="o">=</span>kubernetes-dashboard
</span></span><span class="line"><span class="cl">root     <span class="m">14138</span>  0.0  0.2 <span class="m">712480</span> <span class="m">10652</span> ?        Sl   05:59   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 8e865c7d2f0dc0a8ca9061aea5f89df362d07d749b8f984884d900ca77845011 -address /run/containerd/containerd.sock
</span></span><span class="line"><span class="cl"><span class="m">65535</span>    <span class="m">14160</span>  0.0  0.0    <span class="m">972</span>     <span class="m">4</span> ?        Ss   05:59   0:00  <span class="se">\_</span> /pause
</span></span><span class="line"><span class="cl">root      <span class="m">9717</span>  0.0  0.2 <span class="m">712480</span> <span class="m">10028</span> ?        Sl   07:01   0:00 /usr/bin/containerd-shim-runc-v2 -namespace k8s.io -id 76439116dd121ba3c644c38ff9e0b09c01810dfff8c5adbeb41812abe9871ce7 -address /run/containerd/containerd.sock
</span></span><span class="line"><span class="cl"><span class="m">65535</span>     <span class="m">9738</span>  0.0  0.0    <span class="m">972</span>     <span class="m">4</span> ?        Ss   07:01   0:00  <span class="se">\_</span> /pause
</span></span><span class="line"><span class="cl">root      <span class="m">9808</span>  0.0  0.1   <span class="m">7880</span>  <span class="m">4512</span> ?        Ss   07:01   0:00  <span class="se">\_</span> nginx: master process nginx -g daemon off<span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="m">100</span>       <span class="m">9820</span>  0.0  0.0   <span class="m">8336</span>  <span class="m">2200</span> ?        S    07:01   0:00      <span class="se">\_</span> nginx: worker process
</span></span><span class="line"><span class="cl"><span class="m">100</span>       <span class="m">9821</span>  0.0  0.0   <span class="m">8336</span>  <span class="m">1548</span> ?        S    07:01   0:00      <span class="se">\_</span> nginx: worker process
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 포트 확인 </span>
</span></span><span class="line"><span class="cl">sudo netstat -tulnp
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span></span><span class="line"><span class="cl">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:10248         0.0.0.0:*               LISTEN      2940/kubelet        
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:61679         0.0.0.0:*               LISTEN      3431/./aws-k8s-agen 
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:111             0.0.0.0:*               LISTEN      1821/rpcbind        
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      2419/sshd           
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:25            0.0.0.0:*               LISTEN      2262/master         
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:46847         0.0.0.0:*               LISTEN      2826/containerd     
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:50051         0.0.0.0:*               LISTEN      3431/./aws-k8s-agen 
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::10249                :::*                    LISTEN      4213/kube-proxy     
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::10250                :::*                    LISTEN      2940/kubelet        
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::61678                :::*                    LISTEN      3431/./aws-k8s-agen 
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::111                  :::*                    LISTEN      1821/rpcbind        
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::10256                :::*                    LISTEN      4213/kube-proxy     
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> :::22                   :::*                    LISTEN      2419/sshd           
</span></span><span class="line"><span class="cl">udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:68              0.0.0.0:*                           2064/dhclient       
</span></span><span class="line"><span class="cl">udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:111             0.0.0.0:*                           1821/rpcbind        
</span></span><span class="line"><span class="cl">udp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:323           0.0.0.0:*                           1848/chronyd        
</span></span><span class="line"><span class="cl">udp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:720             0.0.0.0:*                           1821/rpcbind        
</span></span><span class="line"><span class="cl">udp6       <span class="m">0</span>      <span class="m">0</span> :::111                  :::*                                1821/rpcbind        
</span></span><span class="line"><span class="cl">udp6       <span class="m">0</span>      <span class="m">0</span> ::1:323                 :::*                                1848/chronyd        
</span></span><span class="line"><span class="cl">udp6       <span class="m">0</span>      <span class="m">0</span> fe80::e2:4aff:fe3e::546 :::*                                2099/dhclient       
</span></span><span class="line"><span class="cl">udp6       <span class="m">0</span>      <span class="m">0</span> :::720                  :::*                                1821/rpcbind
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>작업자 노드에서 컨테이너가 변경되기 전에 docker 명령을 실행하여  도커에 대한 설정 수집</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># docker </span>
</span></span><span class="line"><span class="cl"><span class="c1">## 실행 컨테이너 확인 </span>
</span></span><span class="line"><span class="cl">docker container top <span class="nv">$CONTAINER</span> 
</span></span><span class="line"><span class="cl"><span class="c1">## 로그 확인 </span>
</span></span><span class="line"><span class="cl">docker container logs <span class="nv">$CONTAINER</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 포트 확인</span>
</span></span><span class="line"><span class="cl">docker container port <span class="nv">$CONTAINER</span> 
</span></span><span class="line"><span class="cl"><span class="c1">## 파일 및 디렉토리 변경 사항 캡처 </span>
</span></span><span class="line"><span class="cl">docker container diff <span class="nv">$CONTAINER</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># containerd 1.24 이상 </span>
</span></span><span class="line"><span class="cl">sudo nerdctl ps <span class="c1"># 컨테이너 리스트 확인</span>
</span></span><span class="line"><span class="cl">sudo nerdctl logs <span class="o">[</span>container-id<span class="o">]</span> <span class="c1"># 컨테이너 로그 확인</span>
</span></span><span class="line"><span class="cl">sudo nerdctl diff <span class="o">[</span>container-id<span class="o">]</span> <span class="c1"># 컨테이너와 원본 이미지 간의 차이점 확인 </span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>포렌식 캡처를 위해 컨테이너를 일시중지하고, 인스턴스의 EBS 볼륨을 스냅샷하자.</p>
<p>노드 IP를 식별하여 해당 노드에 연결된 볼륨에 들어가 스냅샷을 생성하도록 하자.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/snap1.png" 
    alt="snap1.png" 
     
    width=1589 
    height="430"  /></p>
</li>
<li>
<p>손상된 포드 또는 워크로드 리소스 재배포</p>
<p>분석을 위한 데이터를 수집한 후에는 손상된 포드 또는 워크로드 리소스를 재배포 할 수 있다. 수정 사항을 롤아웃하고 새 교체 파드로 시작한 다음,취약 파드를 삭제하면 끝난다.</p>
</li>
</ol>
<h3 id="침해-대응-시뮬레이션">
    <a href="#%ec%b9%a8%ed%95%b4-%eb%8c%80%ec%9d%91-%ec%8b%9c%eb%ae%ac%eb%a0%88%ec%9d%b4%ec%85%98" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    침해 대응 시뮬레이션
</h3>
<p>민첩한 사고 대응을 위해서는 사전의 침해 시뮬레이션이 필요하다. 시뮬레이션을 위한 유틸리티로 <a href="https://github.com/cyberark/kubesploit">https://github.com/cyberark/kubesploit</a> 가 있는데 아래 침해 스택에 따라 모듈을 구성하여 침해 방식을 테스트한다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/kubesploit.png" 
    alt="&lt;a href=&#34;https://github.com/cyberark/kubesploit/blob/assets/mitre_pic_full.png&#34;&gt;https://github.com/cyberark/kubesploit/blob/assets/mitre_pic_full.png&lt;/a&gt;" 
     
    width=1864 
    height="1502"  /></p>
<p><a href="https://github.com/cyberark/kubesploit/blob/assets/mitre_pic_full.png">https://github.com/cyberark/kubesploit/blob/assets/mitre_pic_full.png</a></p>
<p>공격 스택이 별로 없는 것 같지만,, k8s 기반의 침해 시뮬레이션 툴 중에 가장 별이 많으며, 그나마 많은 침해 방식 기능을 제공한다. 또한, 깃허브 공식 문서에서는 침해 스택에 따른 <a href="https://github.com/cyberark/kubesploit/blob/main/MITIGATION.md">대응 방식</a>도 제공하니 나중에 침해 대응 시뮬레이션 진행시 참고하도록 하자.</p>
<h2 id="aws-waf을-통한-애플리케이션-트래픽-보호">
    <a href="#aws-waf%ec%9d%84-%ed%86%b5%ed%95%9c-%ec%95%a0%ed%94%8c%eb%a6%ac%ec%bc%80%ec%9d%b4%ec%85%98-%ed%8a%b8%eb%9e%98%ed%94%bd-%eb%b3%b4%ed%98%b8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    AWS WAF을 통한 애플리케이션 트래픽 보호
</h2>
<blockquote>
<p>참고 :<a href="https://catalog.workshops.aws/observability/ko-KR">One Observability Workshop</a></p>
</blockquote>
<p>AWS WAF 는 웹 애플리케이션을 일반적인 웹 공격으로부터 보호하는 보안 서비스이다. 이 서비스는 공격자가 취약점을 이용하여 애플리케이션에 접근하거나 데이터를 유출하는 것을 막는다. (참고 : ChatGPT)</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf1.png" 
    alt="waf1.png" 
     
    width=1008 
    height="303"  /></p>
<p>AWS WAF는 다음과 같은 주요 기능을 제공한다:</p>
<ol>
<li><strong>사용자 정의 보안 규칙</strong>: AWS WAF는 사용자 정의 필터를 생성하여 웹 요청을 허용하거나 차단할 수 있다. 이 필터는 IP 주소, HTTP 헤더, HTTP 바디, URI 문자열, SQL 삽입 공격, 스크립트 교차 사이트 공격 (XSS) 등에 기반한다.</li>
<li><strong>비용 효율적인 보안</strong>: AWS WAF는 수요에 따라 가격이 책정되므로, 사용자는 실제로 사용하는 만큼만 비용을 지불한다.</li>
<li><strong>실시간 지표</strong>: AWS WAF는 AWS CloudWatch와 통합하여 웹 트래픽에 대한 실시간 지표를 제공한다. 이를 통해 사용자는 웹 트래픽의 트렌드를 식별하고 필요한 보안 조치를 즉시 취할 수 있다.</li>
<li><strong>보안 자동화</strong>: AWS WAF는 API를 통해 보안을 자동화할 수 있다. 이는 룰의 업데이트를 자동화하고, 새로운 애플리케이션에 보안 설정을 자동으로 적용하는 데 사용할 수 있다.</li>
</ol>
<p>AWS WAF는 Amazon CloudFront, AWS Application Load Balancer, Amazon API Gateway 등 다른 AWS 서비스와 함께 사용될 수 있어, 사용자의 AWS 웹 애플리케이션을 보호하는 데 유용하다. EKS 환경에서도 애플리케이션을 ALB로 구성하며 여기에 WAF를 연결하여 유입 트래픽에 대한 보안 구성을 설정할 수 있다.</p>
<p>WAF 기능 확인을 위한 선행 작업으로 EKS 클러스터에서 ALB 컨트롤러와 예제 배포가 필요하다. 다음의 명령어를 통해 진행하도록 하자.</p>
<h3 id="waf-구성">
    <a href="#waf-%ea%b5%ac%ec%84%b1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    WAF 구성
</h3>
<ul>
<li>
<p>ALB 컨트롤러 설치</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ALB controller 정책 설치</span>
</span></span><span class="line"><span class="cl">curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.4.7/docs/install/iam_policy.json
</span></span><span class="line"><span class="cl">aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 정책 arn 생성 확인 </span>
</span></span><span class="line"><span class="cl"><span class="nv">ACCOUNT_ID</span><span class="o">=</span><span class="m">000000000000</span>
</span></span><span class="line"><span class="cl">aws iam get-policy --policy-arn arn:aws:iam::<span class="nv">$ACCOUNT_ID</span>:policy/AWSLoadBalancerControllerIAMPolicy --query <span class="s1">&#39;Policy.Arn&#39;</span>
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="s2">&#34;arn:aws:iam::000000000000:policy/AWSLoadBalancerControllerIAMPolicy&#34;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OIDC 서비스 어카운트 생성</span>
</span></span><span class="line"><span class="cl"><span class="nv">CLUSTER_NAME</span><span class="o">=</span>hanhorang 
</span></span><span class="line"><span class="cl">eksctl create iamserviceaccount --cluster<span class="o">=</span><span class="nv">$CLUSTER_NAME</span> --namespace<span class="o">=</span>kube-system --name<span class="o">=</span>aws-load-balancer-controller <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--attach-policy-arn<span class="o">=</span>arn:aws:iam::<span class="nv">$ACCOUNT_ID</span>:policy/AWSLoadBalancerControllerIAMPolicy --override-existing-serviceaccounts --approve
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># OIDC 서비스 어카운트 확인 </span>
</span></span><span class="line"><span class="cl">kubectl edit sa/aws-load-balancer-controller  -n kube-system
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ServiceAccount
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  annotations: <span class="c1"># annoation 에 role-arn이 추가된 것을 확인! </span>
</span></span><span class="line"><span class="cl">    eks.amazonaws.com/role-arn: arn:aws:iam::000000000000:role/eksctl-hanhorang-addon-iamserviceaccount-kub-Role1-1MPK8ATNJVXQH
</span></span><span class="line"><span class="cl">  creationTimestamp: <span class="s2">&#34;2023-05-08T05:32:22Z&#34;</span>
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app.kubernetes.io/managed-by: eksctl
</span></span><span class="line"><span class="cl">  name: aws-load-balancer-controller
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  resourceVersion: <span class="s2">&#34;1236&#34;</span>
</span></span><span class="line"><span class="cl">  uid: 5fe3e69b-8cfc-426c-a16a-509e1f7c4a86
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ALB 설치 </span>
</span></span><span class="line"><span class="cl">helm repo add eks https://aws.github.io/eks-charts
</span></span><span class="line"><span class="cl">helm repo update
</span></span><span class="line"><span class="cl">helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set <span class="nv">clusterName</span><span class="o">=</span><span class="nv">$CLUSTER_NAME</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --set serviceAccount.create<span class="o">=</span><span class="nb">false</span> --set serviceAccount.name<span class="o">=</span>aws-load-balancer-controller
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ALB 파드 확인 </span>
</span></span><span class="line"><span class="cl">kubectl get pods -A
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">NAMESPACE     NAME                                            READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7857849d69-qc9nr   1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">kube-system   aws-load-balancer-controller-7857849d69-qjvkk   1/1     Running   <span class="m">0</span>          24m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ALB 로그 확인</span>
</span></span><span class="line"><span class="cl">kubectl logs pods/aws-load-balancer-controller-7857849d69-qc9nr -n kube-system
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;version&#34;</span>,<span class="s2">&#34;GitVersion&#34;</span>:<span class="s2">&#34;v2.5.1&#34;</span>,<span class="s2">&#34;GitCommit&#34;</span>:<span class="s2">&#34;06abaed66e17a411ba064f34e6018b889780ac66&#34;</span>,<span class="s2">&#34;BuildDate&#34;</span>:<span class="s2">&#34;2023-04-17T22:36:53+0000&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.metrics&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Metrics server is starting to listen&#34;</span>,<span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;:8080&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;setup&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;adding health check for controller&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/mutate-v1-pod&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/mutate-v1-service&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/validate-elbv2-k8s-aws-v1beta1-ingressclassparams&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/mutate-elbv2-k8s-aws-v1beta1-targetgroupbinding&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/validate-elbv2-k8s-aws-v1beta1-targetgroupbinding&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Registering webhook&#34;</span>,<span class="s2">&#34;path&#34;</span>:<span class="s2">&#34;/validate-networking-v1-ingress&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:45Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;setup&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;starting podInfo repo&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:47Z&#34;</span>,<span class="s2">&#34;logger&#34;</span>:<span class="s2">&#34;controller-runtime.webhook.webhooks&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Starting webhook server&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;level&#34;</span>:<span class="s2">&#34;info&#34;</span>,<span class="s2">&#34;ts&#34;</span>:<span class="s2">&#34;2023-05-08T05:59:47Z&#34;</span>,<span class="s2">&#34;msg&#34;</span>:<span class="s2">&#34;Starting server&#34;</span>,<span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;health probe&#34;</span>,<span class="s2">&#34;addr&#34;</span>:<span class="s2">&#34;[::]:61779&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>Ingress 예제 배포</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># game-2048 배포 </span>
</span></span><span class="line"><span class="cl">curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/3/ingress1.yaml
</span></span><span class="line"><span class="cl">cat ingress1.yaml <span class="p">|</span> yh
</span></span><span class="line"><span class="cl">kubectl apply -f ingress1.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get ingress -A 
</span></span><span class="line"><span class="cl">--- 
</span></span><span class="line"><span class="cl">NAMESPACE   NAME           CLASS   HOSTS   ADDRESS                                                                        PORTS   AGE
</span></span><span class="line"><span class="cl">game-2048   ingress-2048   alb     *       k8s-game2048-ingress2-91307666f8-2009146712.ap-northeast-2.elb.amazonaws.com   <span class="m">80</span>      24s
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf2.png" 
    alt="waf2.png" 
     
    width=1293 
    height="980"  /></p>
</li>
</ul>
<p>해당 서비스에 WAF를 연결하겠다.  AWS 콘솔에서 WAF 접근하여 새로운 서비스를 추가하도록 하자. 아쉽지만 WAF 콘솔 진입시 지역이 글로벌로 바뀌어서 그런가 한글 지원이 안된다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf3.png" 
    alt="waf3.png" 
     
    width=857 
    height="864"  /></p>
<p>추가 리소스에서 위에서 생성한 ALB를 연결하자.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf4.png" 
    alt="waf4.png" 
     
    width=825 
    height="506"  /></p>
<p>AWS WAF에서 자체적으로 트래픽 보호를 위한 규칙을 제공한다.. 하지만 아래 그림과 같이 사용에 비용이 발생하니 참고하자. 규칙 또한 다양하고 구성시 설명이 상세하게 나오니 참고하자. 규칙 키워드로 정리하면 IP 주소 차단, SQL Injection 공격 차단, Cross-Site Scripting (XSS) 공격 차단, 유저 봇 차단, 크기 제한 규칙, 지역 블랙리스트, HTTP 헤더, HTTP 메소드, 문자열 매칭, 반복 요청 등이 있고 세부적으로 커스터마이징이 가능하다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf6.png" 
    alt="waf6.png" 
     
    width=853 
    height="848"  /></p>
<h3 id="waf-관측">
    <a href="#waf-%ea%b4%80%ec%b8%a1" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    WAF 관측
</h3>
<p>WAF을 구성하면 메트릭과 로깅 정보를 확인할 수 있다. 메트릭은 기본적으로 제공하지만, 로깅은 WAF 내 기능 탭 Logging and metrics 에서 로깅 기능을 활성화(로그 그룹 생성시 네이밍 <code>aws-waf-logs-</code> 로 시작해야 인식된다.)해야 한다. 활성화를 하면 로깅 관련 쿼리도 제공된다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf8.png" 
    alt="waf8.png" 
     
    width=1600 
    height="865"  /></p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf11.png" 
    alt="waf11.png" 
     
    width=1594 
    height="826"  /></p>
<h3 id="waf-기능-확인">
    <a href="#waf-%ea%b8%b0%eb%8a%a5-%ed%99%95%ec%9d%b8" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    WAF 기능 확인
</h3>
<p>기본적으로 WAF 의 설정된 룰에 조건이 도달되면 해당 IP는 접근이 블록(차단)된다. 상황에 따라 다르지만, 기본적으로 WAF는 각 규칙이 엄격하게 구성되어 있어 원치않는 차단 IP가 나올 수 있다. 이를 대비하기 위해 옵션이 제공되는 데 블록 대신 Count로 모니터링할 수 있는 기능을 제공한다. 기능 탭 Rule에서 규칙을 클릭하고 설정 부분에서 해당 옵션을 활성화시키면 된다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf12.png" 
    alt="waf12.png" 
     
    width=833 
    height="254"  /></p>
<p>WAF에서 임계값에 대한 알람 구성 또한 가능하다. Cloudwatch 에서 알람 생성에서 WAF에서 확인한 메트릭 값에 대한 알람 설정을 손 쉽게 할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf-alarm.png" 
    alt="waf-alarm.png" 
     
    width=2480 
    height="1210"  /></p>
<p>WAF는 CloudWatch Contributor Insights와 연계하여 특정 조건의 상위 N 기여자를 가져와 대시보드에서 시각화하는 기능을 제공한다. 이를 통해서 상위 차단 IP 주소를 시각화하여 확인할 수 있다. Cloudwatch → contributor Ingihts → 규칙 생성으로 WAF에서 생성한 로그를 지정하고 로그 개수에 대한 필터링을 집계 설정하여 대시보드 구성하면 다음과 같이 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/waf15.png" 
    alt="waf15.png" 
     
    width=1626 
    height="1328"  /></p>
<p>트래픽 테스트를 할 수 없어서 워크샵 결과 화면을 대체한다. 앞 서 생성한 규칙 키에서 설정한 값에 대한 로그 값을 합계하여  Count 값을 확인할 수 있다.</p>
<p><img loading="lazy" 
    src="/./EKS-Security-allinone/contributor-insights-blocked-requests.jpeg" 
    alt="contributor-insights-blocked-requests.jpeg" 
     
    width=3082 
    height="1732"  /></p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/eks-security-concept/" title="Previous post (older)">
            <span>Previous</span>
            [AEWS] EKS Security 이해
            </a>
        
        
        
        <a rel="next" href="/post/aews-gitops/" title="Next post (newer)">
            <span>Next</span>
            [AEWS] Gitops CI &amp; CD 구성
            </a> 
        
    </nav>
    
</div>
 
<div class="container">
    
    <script src="https://giscus.app/client.js" 
        data-repo="WingLim/hugo-tania"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMTYyNjQzMDc="
        
        data-category="Comments"
        data-category-id="DIC_kwDOEtnPc84B_WKP"
        
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        crossorigin="anonymous"
        async
        >
</script>

<script>
    function setGiscusTeheme(theme) {
        let giscus = document.querySelector('.giscus iframe');
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme
                        }
                    }
                },
                'https://giscus.app'
            )
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://giscus.app') return;
        setGiscusTeheme(document.documentElement.dataset.userColorScheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        setGiscusTeheme(e.detail)
    })
</script>

</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.706a523ba43e6d0427c7fdf2b9d05dbd0920d3f12942b453690b495cb2522743.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>